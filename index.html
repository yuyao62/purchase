<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
body { margin: 0; background: #eef1f7; min-height: 100vh; }

.app {
  width: min(1100px, 100%);
  background: #fff;
  margin: 20px auto;
  padding: 24px;
  border-radius: 20px;
  box-shadow: 0 18px 40px rgba(0,0,0,.12);
}

h1 { text-align: center; margin: 0 0 6px; }
.subtitle { text-align: center; color: #6b7280; font-size: 14px; margin-bottom: 16px; }

.row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 12px; }
label { font-weight: 800; }

input, select {
  padding: 8px 14px;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  max-width: 100%;
}
button {
  padding: 8px 18px;
  border-radius: 999px;
  border: none;
  background: #4f46e5;
  color: #fff;
  font-weight: 800;
  cursor: pointer;
}
.emergency-btn { background:#dc2626; }
.secondary-btn { background:#111827; }
.ghost-btn { background:#e5e7eb; color:#111827; }

.pill { padding: 4px 12px; border-radius: 999px; font-size: 13px; font-weight: 800; }
.pill-total { background:#dbeafe; color:#1e3a8a; }
.pill-buy { background:#fee2e2; color:#991b1b; }
.pill-ok { background:#dcfce7; color:#166534; }

.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { background: #e5e7eb; padding: 8px; position: sticky; top: 0; }
td { padding: 6px 8px; vertical-align: middle; }
tr:nth-child(even) td { background: #f3f4f6; }
td.col-stock input { width: 80px; text-align: center; border-radius: 10px; }

.tag { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; }
.tag-empty { background:#e5e7eb; }
.tag-buy { background:#fee2e2; color:#b91c1c; }
.tag-ok { background:#dcfce7; color:#166534; }

@media (max-width: 520px){
  .app { width: 100%; margin: 0; padding: 12px; border-radius: 0; box-shadow: none; }
  h1 { font-size: 26px; }
  .subtitle { font-size: 12px; }

  .table-wrap { overflow: visible; }
  table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
  thead { display: none; }

  tr {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 120px;
    grid-template-areas:
      "code right"
      "drug right"
      "usage right";
    gap: 4px 8px;
    background: #fff;
    border-radius: 14px;
    padding: 10px;
    max-width: 100%;
    overflow: hidden;
  }

  td { padding: 0; white-space: normal; min-width: 0; }
  td.col-code { grid-area: code; font-weight: 900; font-size: 14px; }

  td.col-drug{
    grid-area: drug;
    font-weight: 700;
    line-height: 1.3;
    overflow-wrap:anywhere;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  td.col-usage { grid-area: usage; font-weight: 800; color: #374151; }

  td.col-stock{
    grid-area: right;
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:6px;
    min-height:48px;
    align-self:stretch;
    min-width:0;
    max-width:100%;
  }

  td.col-status { display:none; }

  td.col-stock input{
    width:68px;
    max-width:100%;
    min-height:36px;
    font-size:16px;
    text-align:center;
    touch-action: manipulation;
  }

  td.col-stock .tag{
    max-width:52px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    font-size:11px;
    padding:4px 6px;
  }

  #searchInput{ font-size: 16px; padding: 10px 16px; }
}

/* ===== ç·Šæ€¥ modal ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,#7f1d1d,#000);
  color:#fff;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.modal h1{ font-size:44px; margin:0 0 16px; }
.modal button{
  width:min(360px, 90vw);
  padding:14px 18px;
  font-size:18px;
  border-radius:14px;
}

/* ===== éœ€æ¡è³¼æ¸…å–®ï¼šç¨ç«‹ç•«é¢ ===== */
.buy-screen{
  display:none;
  position:fixed;
  inset:0;
  background:#0b1220;
  color:#fff;
  z-index:9998;
  overflow:auto;
  padding:16px;
}
.buy-panel{ width:min(980px, 100%); margin:0 auto; }
.buy-head{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:10px;
  justify-content:space-between;
  margin-bottom:12px;
}
.buy-title{ font-size:22px; font-weight:900; }
.buy-sub{ color:#cbd5e1; font-size:13px; margin-top:4px; }
.buy-actions{ display:flex; flex-wrap:wrap; gap:10px; }

.buy-card{
  background:#111827;
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.buy-row{
  display:grid;
  grid-template-columns:110px 1fr 120px 120px 120px;
  gap:10px;
  align-items:start;
}
.buy-row > div{ min-width:0; }
.buy-k{ font-size:12px; color:#94a3b8; font-weight:800; }
.buy-v{ font-size:14px; font-weight:800; overflow-wrap:anywhere; }
.buy-pill{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  background:#fecaca;
  color:#7f1d1d;
}
@media (max-width: 700px){
  .buy-row{
    grid-template-columns:1fr 120px;
    grid-template-areas:
      "code need"
      "drug need"
      "vendor need"
      "usage stock"
      "suggest suggest";
  }
  .b-code{grid-area:code;}
  .b-drug{grid-area:drug;}
  .b-vendor{grid-area:vendor;}
  .b-usage{grid-area:usage;}
  .b-stock{grid-area:stock;}
  .b-suggest{grid-area:suggest;}
  .b-need{grid-area:need; text-align:right;}
}
</style>
</head>

<body>
<div class="app" id="mainApp">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="subtitle">å» å•†ä¸‹æ‹‰ï¼šä¸­æ–‡å‰2ç¢¼ â†’ è‹±æ–‡å‰5ç¢¼ï¼ˆä¸­æ–‡å„ªå…ˆï¼‰</div>

  <div class="row">
    <label>å» å•†ï¼š</label>
    <select id="vendorSelect"><option value="">å…¨éƒ¨</option></select>
  </div>

  <div class="row">
    <label>æœå°‹ï¼š</label>
    <input id="searchInput" style="flex:1" placeholder="è¼¸å…¥å°±æœƒè‡ªå‹•æŸ¥ï¼ˆè—¥ä»£ / è—¥å / å» å•†ï¼‰">
  </div>

  <div class="row">
    <button id="resetBtn">é‡ç½®</button>
    <button id="emergencyBtn" class="emergency-btn">ç·Šæ€¥</button>
    <label><input type="checkbox" id="needBuyOnly"> åªé¡¯ç¤ºéœ€æ¡è³¼ï¼ˆå‹¾é¸è‡ªå‹•è·³é ï¼‰</label>
    <button id="openBuyScreenBtn" class="secondary-btn">éœ€æ¡è³¼æ¸…å–®ï¼ˆå¦ä¸€ç•«é¢ï¼‰</button>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount"></span>
    <span class="pill pill-buy" id="needBuyCount"></span>
    <span class="pill pill-ok" id="okCount"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>è—¥ä»£</th>
          <th>è—¥å“</th>
          <th>æœˆç”¨é‡</th>
          <th>åº«å­˜</th>
          <th>ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody id="drugBody"></tbody>
    </table>
  </div>

  <canvas id="chart" height="180"></canvas>
</div>

<!-- éœ€æ¡è³¼æ¸…å–®ï¼šç¨ç«‹ç•«é¢ -->
<div id="buyScreen" class="buy-screen">
  <div class="buy-panel">
    <div class="buy-head">
      <div>
        <div class="buy-title">ğŸ§¾ éœ€æ¡è³¼æ¸…å–®</div>
        <div class="buy-sub" id="buyMeta"></div>
      </div>
      <div class="buy-actions">
        <button id="backBtn" class="ghost-btn">è¿”å›ä¸»ç•«é¢</button>
        <button id="saveCSVBtn" class="secondary-btn">å­˜æª” CSV</button>
        <button id="saveJSONBtn" class="secondary-btn">å­˜æª” JSON</button>
      </div>
    </div>

    <div id="buyList"></div>
  </div>
</div>

<!-- ç·Šæ€¥ -->
<div id="emergencyModal" class="modal">
  <div style="text-align:center; padding: 16px">
    <h1>âš ï¸ è«‹æ´½åº—é•·</h1>
    <button onclick="document.getElementById('emergencyModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>

<script>
document.addEventListener("touchstart", ()=>{}, {passive:true});

(() => {
  let rawData = [];
  let chart;

  const $ = id => document.getElementById(id);

  const vendorKey = v => {
    v = String(v||"");
    return /^[A-Za-z]/.test(v) ? v.slice(0,5).toUpperCase() : v.slice(0,2);
  };

  const nowStamp = () => {
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
  };

  function makeTag(x){
    if(x.åº«å­˜é‡==null) return '<span class="tag tag-empty">æœªè¼¸å…¥</span>';
    return x.éœ€æ¡è³¼
      ? '<span class="tag tag-buy">éœ€æ¡è³¼</span>'
      : '<span class="tag tag-ok">è¶³å¤ </span>';
  }

  function renderStats(list){
    const total = list.length;
    const need = list.filter(x=>x.éœ€æ¡è³¼).length;
    const ok = list.filter(x=>x.åº«å­˜é‡!=null && !x.éœ€æ¡è³¼).length;

    $("totalCount").textContent = `å…± ${total} ç­†`;
    $("needBuyCount").textContent = `éœ€æ¡è³¼ ${need} ç­†`;
    $("okCount").textContent = `åº«å­˜è¶³å¤  ${ok} ç­†`;

    if(chart) chart.destroy();
    chart = new Chart($("chart"),{
      type:"pie",
      data:{labels:["éœ€æ¡è³¼","åº«å­˜è¶³å¤ "],datasets:[{data:[need,ok]}]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  function render(list){
    $("drugBody").innerHTML = "";
    list.forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-code">${x.è—¥ä»£}</td>
        <td class="col-drug">${x.è—¥å“}</td>
        <td class="col-usage">${x.æœˆç”¨é‡}</td>
        <td class="col-stock">
          <input type="number" inputmode="numeric" value="${x.åº«å­˜é‡??""}">
          ${makeTag(x)}
        </td>
        <td class="col-status"></td>
      `;

      const inp = tr.querySelector("input");
      inp.addEventListener("input", ()=>{
        x.åº«å­˜é‡ = inp.value==="" ? null : +inp.value;
        x.éœ€æ¡è³¼ = x.åº«å­˜é‡!=null && (Number(x.æœˆç”¨é‡)||0) > x.åº«å­˜é‡;
        tr.querySelector(".tag").outerHTML = makeTag(x);

        persistStock();
        renderStats(list);

        // âœ… å¦‚æœç›®å‰å‹¾é¸ã€Œåªé¡¯ç¤ºéœ€æ¡è³¼ã€ï¼Œè¼¸å…¥æ™‚ä¹Ÿå³æ™‚æ›´æ–°éœ€æ¡è³¼é 
        if ($("needBuyOnly").checked && isBuyScreenOpen()) openBuyScreen();
      });

      $("drugBody").appendChild(tr);
    });
    renderStats(list);
  }

  function currentFilteredList(){
    const kw = $("searchInput").value.toLowerCase();
    const vSel = $("vendorSelect").value;
    const needOnly = $("needBuyOnly").checked;

    let list = rawData.filter(x=>{
      if(vSel && vendorKey(x.å» å•†)!==vSel) return false;
      if(!kw) return true;
      return (
        String(x.è—¥ä»£).toLowerCase().includes(kw) ||
        String(x.è—¥å“).toLowerCase().includes(kw) ||
        String(x.å» å•†).toLowerCase().includes(kw)
      );
    });

    if(needOnly) list = list.filter(x=>x.éœ€æ¡è³¼);
    return list;
  }

  function filter(){
    const list = currentFilteredList();
    render(list);

    const first = $("drugBody").querySelector("tr");
    if(first) first.scrollIntoView({behavior:"smooth", block:"start"});
  }

  /* ========= éœ€æ¡è³¼æ¸…å–®ï¼šå¦ä¸€ç•«é¢ ========= */
  function getNeedBuyList(){
    const kw = $("searchInput").value.toLowerCase();
    const vSel = $("vendorSelect").value;

    return rawData
      .filter(x=>{
        if(vSel && vendorKey(x.å» å•†)!==vSel) return false;
        if(kw){
          const hit =
            String(x.è—¥ä»£).toLowerCase().includes(kw) ||
            String(x.è—¥å“).toLowerCase().includes(kw) ||
            String(x.å» å•†).toLowerCase().includes(kw);
          if(!hit) return false;
        }
        return x.éœ€æ¡è³¼;
      })
      .map(x=>{
        const stock = (x.åº«å­˜é‡==null) ? 0 : x.åº«å­˜é‡;
        const suggest = Math.max(0, (Number(x.æœˆç”¨é‡)||0) - Number(stock||0));
        return {
          è—¥ä»£: x.è—¥ä»£,
          è—¥å“: x.è—¥å“,
          å» å•†: x.å» å•†,
          æœˆç”¨é‡: Number(x.æœˆç”¨é‡)||0,
          åº«å­˜é‡: x.åº«å­˜é‡,
          å»ºè­°æ¡è³¼é‡: suggest
        };
      })
      .sort((a,b)=> (b.å»ºè­°æ¡è³¼é‡ - a.å»ºè­°æ¡è³¼é‡));
  }

  function isBuyScreenOpen(){
    return $("buyScreen").style.display === "block";
  }

  function openBuyScreen(){
    const list = getNeedBuyList();
    $("buyScreen").style.display = "block";

    const vSel = $("vendorSelect").value || "å…¨éƒ¨";
    const kw = $("searchInput").value.trim() || "ï¼ˆç„¡ï¼‰";
    $("buyMeta").textContent = `ç¯©é¸ï¼šå» å•† ${vSel}ï½œé—œéµå­— ${kw}ï½œå…± ${list.length} ç­†ï¼ˆä¾å»ºè­°æ¡è³¼é‡æ’åºï¼‰`;

    const wrap = $("buyList");
    wrap.innerHTML = "";

    if(list.length === 0){
      const empty = document.createElement("div");
      empty.className = "buy-card";
      empty.innerHTML = `<div style="font-weight:900; font-size:16px">ç›®å‰æ²’æœ‰éœ€æ¡è³¼é …ç›®</div>
                         <div style="color:#94a3b8; margin-top:6px">è«‹å…ˆåœ¨ä¸»ç•«é¢è¼¸å…¥åº«å­˜ï¼Œç³»çµ±æ‰æœƒåˆ¤æ–·éœ€æ¡è³¼ã€‚</div>`;
      wrap.appendChild(empty);
      return;
    }

    list.forEach(x=>{
      const card = document.createElement("div");
      card.className = "buy-card";
      card.innerHTML = `
        <div class="buy-row">
          <div class="b-code">
            <div class="buy-k">è—¥ä»£</div>
            <div class="buy-v">${x.è—¥ä»£}</div>
          </div>

          <div class="b-drug">
            <div class="buy-k">è—¥å“</div>
            <div class="buy-v">${x.è—¥å“}</div>
          </div>

          <div class="b-usage">
            <div class="buy-k">æœˆç”¨é‡</div>
            <div class="buy-v">${x.æœˆç”¨é‡}</div>
          </div>

          <div class="b-stock">
            <div class="buy-k">åº«å­˜</div>
            <div class="buy-v">${x.åº«å­˜é‡==null ? "æœªè¼¸å…¥" : x.åº«å­˜é‡}</div>
          </div>

          <div class="b-need">
            <div class="buy-k">ç‹€æ…‹</div>
            <div class="buy-v"><span class="buy-pill">éœ€æ¡è³¼</span></div>
          </div>

          <div class="b-vendor">
            <div class="buy-k">å» å•†</div>
            <div class="buy-v">${x.å» å•†}</div>
          </div>

          <div class="b-suggest">
            <div class="buy-k">å»ºè­°æ¡è³¼é‡</div>
            <div class="buy-v">${x.å»ºè­°æ¡è³¼é‡}</div>
          </div>
        </div>
      `;
      wrap.appendChild(card);
    });
  }

  function closeBuyScreen(){
    $("buyScreen").style.display = "none";
  }

  function downloadFile(filename, mime, content){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportNeedBuyCSV(){
    const list = getNeedBuyList();
    const header = ["è—¥ä»£","è—¥å“","å» å•†","æœˆç”¨é‡","åº«å­˜é‡","å»ºè­°æ¡è³¼é‡"];
    const esc = v => {
      const s = (v==null) ? "" : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const rows = [header.join(",")].concat(
      list.map(x=> header.map(k=>esc(x[k])).join(","))
    );
    downloadFile(`éœ€æ¡è³¼æ¸…å–®_${nowStamp()}.csv`, "text/csv;charset=utf-8", rows.join("\n"));
  }

  function exportNeedBuyJSON(){
    const list = getNeedBuyList();
    downloadFile(`éœ€æ¡è³¼æ¸…å–®_${nowStamp()}.json`, "application/json;charset=utf-8", JSON.stringify(list, null, 2));
  }

  /* ========= åº«å­˜ä¿å­˜ / é‚„åŸ ========= */
  const STOCK_KEY = "drug_stock_v1";

  function persistStock(){
    const obj = {};
    rawData.forEach(x=>{ obj[String(x.è—¥ä»£)] = x.åº«å­˜é‡; });
    localStorage.setItem(STOCK_KEY, JSON.stringify(obj));
  }

  function restoreStock(){
    try{
      const obj = JSON.parse(localStorage.getItem(STOCK_KEY) || "{}");
      rawData = rawData.map(x=>{
        const v = obj[String(x.è—¥ä»£)];
        const stock = (v===null || v===undefined || v==="") ? null : Number(v);
        const need = (stock!=null) && (Number(x.æœˆç”¨é‡)||0) > stock;
        return {...x, åº«å­˜é‡: stock, éœ€æ¡è³¼: need};
      });
    }catch(e){}
  }

  async function load(){
    const r = await fetch("inventory.json");
    rawData = (await r.json()).map(x=>({...x,åº«å­˜é‡:null,éœ€æ¡è³¼:false}));
    restoreStock();

    [...new Set(rawData.map(x=>vendorKey(x.å» å•†)))].forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      $("vendorSelect").appendChild(o);
    });

    filter();
  }

  /* ========= äº‹ä»¶ ========= */
  $("searchInput").addEventListener("input", ()=>{
    clearTimeout(window._t);
    window._t = setTimeout(()=>{
      filter();
      if ($("needBuyOnly").checked) openBuyScreen(); // âœ… ç¯©é¸è®Šå‹•ä¹ŸåŒæ­¥æ›´æ–°éœ€æ¡è³¼é 
    }, 200);
  });

  $("vendorSelect").addEventListener("change", ()=>{
    filter();
    if ($("needBuyOnly").checked) openBuyScreen(); // âœ… å» å•†è®Šå‹•ä¹ŸåŒæ­¥
  });

  // âœ… å‹¾é¸å³è·³é  / å–æ¶ˆå³å›ä¸»ç•«é¢
  $("needBuyOnly").addEventListener("change", ()=>{
    filter();
    if ($("needBuyOnly").checked){
      openBuyScreen();
    } else {
      closeBuyScreen();
    }
  });

  $("resetBtn").addEventListener("click", ()=>{
    $("vendorSelect").value="";
    $("searchInput").value="";
    $("needBuyOnly").checked=false;
    closeBuyScreen();   // âœ… é‡ç½®å›ä¸»ç•«é¢
    filter();
  });

  $("emergencyBtn").addEventListener("click", ()=>{
    $("emergencyModal").style.display="flex";
  });

  // æ‰‹å‹•é–‹å•Ÿä»ä¿ç•™
  $("openBuyScreenBtn").addEventListener("click", openBuyScreen);

  $("backBtn").addEventListener("click", ()=>{
    // âœ… è¿”å›ä¸»ç•«é¢åŒæ™‚æŠŠå‹¾é¸å–æ¶ˆï¼ˆé¿å…ä¸€ç›´è‡ªå‹•è·³å›ä¾†ï¼‰
    $("needBuyOnly").checked = false;
    closeBuyScreen();
    filter();
  });

  $("saveCSVBtn").addEventListener("click", exportNeedBuyCSV);
  $("saveJSONBtn").addEventListener("click", exportNeedBuyJSON);

  load();
})();
</script>
</body>
</html>
