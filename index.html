<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

/* ===== æ‰‹æ©Ÿç‰ˆï¼šç¦æ­¢ä»»ä½•æ©«å‘æ²å‹•ï¼ˆæœ€çµ‚å®šæ¡ˆï¼‰ ===== */
html, body {
  max-width: 100%;
  overflow-x: hidden; /* â›” æ•´é ç¦æ­¢å·¦å³æ»‘ */
}

/* æ‰‹æ©Ÿç‰ˆå¼·åˆ¶æ‰€æœ‰å…ƒç´ ä¸æ’å¯¬ */
@media (max-width: 520px) {
  * {
    max-width: 100%;
    box-sizing: border-box;
  }

  /* è¡¨æ ¼æˆ–å®¹å™¨ä¸€å¾‹ä¸çµ¦æ©«å‘ scroll */
  .table-wrap,
  table {
    overflow-x: hidden !important;
  }

  /* é˜²æ­¢ input / tag / badge æ’å¯¬ */
  input,
  select,
  button,
  .tag,
  .pill,
  .badge-over,
  .badge-buy {
    max-width: 100%;
  }
}

<style>
html{font-size:16px}
body{margin:0;background:#f3f4f6;color:#111827}
body.lock{overflow:hidden}
.app{max-width:1100px;margin:20px auto;background:#fff;padding:24px;border-radius:20px;box-shadow:0 18px 40px rgba(0,0,0,.12)}
h1{text-align:center;margin:0}
.subtitle{text-align:center;color:#6b7280;font-size:14px;margin-bottom:16px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
label{font-weight:800}
input,select{padding:8px 14px;border-radius:999px;border:1px solid #d1d5db;font-size:16px}
button{padding:8px 18px;border-radius:999px;border:none;font-weight:800;cursor:pointer;background:#4f46e5;color:#fff}
.secondary-btn{background:#111827}
.emergency-btn{background:#dc2626}
.ghost-btn{background:#e5e7eb;color:#111827}

.pill{padding:4px 12px;border-radius:999px;font-weight:800;font-size:14px}
.pill-total{background:#dbeafe}
.pill-buy{background:#fee2e2}
.pill-ok{background:#dcfce7}
.pill-over{background:#ede9fe;color:#4c1d95}

#overNotice{display:none;background:#ede9fe;color:#4c1d95;
  padding:10px 14px;border-radius:14px;font-weight:900;cursor:pointer}
#overNotice:hover{background:#ddd6fe}

table{width:100%;border-collapse:collapse}
th,td{padding:8px}
th{background:#e5e7eb}
tr:nth-child(even) td{background:#f3f4f6}

.tag{padding:4px 10px;border-radius:999px;font-weight:800;font-size:14px}
.tag-ok{background:#dcfce7}
.tag-buy{background:#fee2e2;color:#991b1b}
.tag-over{background:#ede9fe;color:#5b21b6}
.tag-empty{background:#e5e7eb}

.stock-wrap{display:flex;flex-direction:column;gap:6px}
.stock-top{display:flex;gap:6px;align-items:center}
.note-input{border-radius:10px;padding:6px 10px;border:1px solid #d1d5db}
.note-del{display:none;background:#ef4444;color:#fff;border:none;border-radius:8px;padding:6px 10px;font-weight:900}
body.admin .note-del{display:inline-block}

.fullscreen{display:none;height:100dvh;background:#0b1220;color:#fff;overflow:auto;padding:16px}
.panel{max-width:980px;margin:auto}
.vendor-group{background:#020617;padding:6px 10px;border-radius:10px;margin-top:16px;font-weight:900}
.line{background:rgba(17,24,39,.4);padding:10px;border-radius:12px;margin-bottom:8px}
.badge-over{background:#ddd6fe;color:#4c1d95;padding:4px 10px;border-radius:999px;font-weight:900}
</style>
</head>

<body>

<div class="app" id="mainApp">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="subtitle">æ¯æœˆä¸€æª” inventory_YYYY_MM.json</div>

  <div id="overNotice"></div>

  <div class="row">
    <label>å¹´ä»½</label><select id="yearSelect"></select>
    <label>ç”¨é‡</label>
    <select id="startMonth"></select> åˆ°
    <select id="endMonth"></select>
    <button id="reloadBtn" class="secondary-btn">é‡æ–°è¼‰å…¥</button>
    <label><input type="checkbox" id="adminMode"> ç®¡ç†è€…</label>
  </div>

  <div class="row">
    <button id="resetBtn">é‡ç½®</button>
    <button id="openOverBtn" class="secondary-btn">ğŸŒ¸ å‹¿å¿˜æˆ‘æ¸…å–®</button>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount"></span>
    <span class="pill pill-buy" id="needBuyCount"></span>
    <span class="pill pill-ok" id="okCount"></span>
    <span class="pill pill-over" id="overCount"></span>
  </div>

  <table>
    <thead>
      <tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th></tr>
    </thead>
    <tbody id="drugBody"></tbody>
  </table>
</div>

<div id="overScreen" class="fullscreen">
  <div class="panel">
    <button class="ghost-btn" id="backBtn">è¿”å›</button>
    <h2>ğŸŒ¸ å‹¿å¿˜æˆ‘ï½œåº«å­˜éé«˜æ¸…å–®</h2>
    <div id="overList"></div>
  </div>
</div>

<script>
(() => {
const $ = id => document.getElementById(id);
let rawData=[];

/* ===== storage ===== */
const STOCK_KEY="drug_stock_v1";
const NOTE_KEY="drug_note_v1";
const MANUAL_KEY="manual_over_v1";

const getLS=k=>JSON.parse(localStorage.getItem(k)||"{}");
const setLS=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

let stockLS=getLS(STOCK_KEY);
let noteLS=getLS(NOTE_KEY);
let manualLS=getLS(MANUAL_KEY);

/* ===== UI ===== */
function initYM(){
  const y=new Date().getFullYear();
  [y-1,y,y+1].forEach(v=>{
    const o=new Option(v,v);$("yearSelect").appendChild(o);
  });
  for(let i=1;i<=12;i++){
    $("startMonth").appendChild(new Option(i,i));
    $("endMonth").appendChild(new Option(i,i));
  }
  const m=new Date().getMonth()+1;
  $("startMonth").value=m;$("endMonth").value=m;
}

/* ===== data ===== */
const fileName=(y,m)=>`inventory_${y}_${String(m).padStart(2,"0")}.json`;

async function loadData(){
  const y=$("yearSelect").value;
  rawData=[];
  for(let m=1;m<=12;m++){
    try{
      const r=await fetch(fileName(y,m),{cache:"no-store"});
      if(!r.ok)continue;
      const rows=await r.json();
      rows.forEach(x=>{
        const code=x["è—¥ä»£"];
        let rec=rawData.find(r=>r.è—¥ä»£===code);
        if(!rec){
          rec={è—¥ä»£:code,è—¥å“:x["è—¥å“"],ç”¨é‡:0};
          rawData.push(rec);
        }
        rec[`m${m}`]=Number(x["æœˆç”¨é‡"]||0);
      });
    }catch{}
  }
  render();
}

function calcUsage(x){
  let s=+$("startMonth").value,e=+$("endMonth").value,sum=0;
  for(let i=s;i<=e;i++) sum+=x[`m${i}`]||0;
  return sum;
}

function isOver(x){
  if(manualLS[x.è—¥ä»£])return true;
  const u=calcUsage(x);
  const st=stockLS[x.è—¥ä»£];
  return u>0 && st!=null && st>u*6;
}

/* ===== render ===== */
function render(){
  const tb=$("drugBody");tb.innerHTML="";
  let overCnt=0,need=0,ok=0;
  rawData.forEach(x=>{
    const u=calcUsage(x);
    const st=stockLS[x.è—¥ä»£];
    const over=isOver(x);
    if(over)overCnt++;
    if(st!=null && u>st)need++; else if(st!=null)ok++;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${x.è—¥ä»£}</td>
      <td>${x.è—¥å“}</td>
      <td>${u}</td>
      <td>
        <div class="stock-wrap">
          <div class="stock-top">
            <input type="number" value="${st??""}">
            ${over?'<span class="tag tag-over">åº«å­˜éé«˜</span>':(st==null?'<span class="tag tag-empty">æœªè¼¸å…¥</span>':'<span class="tag tag-ok">æ­£å¸¸</span>')}
          </div>
          <input class="note-input" placeholder="å‚™è¨»" value="${noteLS[x.è—¥ä»£]||""}">
          <label><input type="checkbox" ${manualLS[x.è—¥ä»£]?"checked":""}> æ‰‹å‹•å‹¿å¿˜æˆ‘</label>
        </div>
      </td>`;
    const [stInp,noteInp,chk]=tr.querySelectorAll("input");
    stInp.oninput=()=>{stockLS[x.è—¥ä»£]=+stInp.value;setLS(STOCK_KEY,stockLS);render();}
    noteInp.oninput=()=>{noteLS[x.è—¥ä»£]=noteInp.value;setLS(NOTE_KEY,noteLS);}
    chk.onchange=()=>{ if(!$("adminMode").checked){chk.checked=!!manualLS[x.è—¥ä»£];return;}
      chk.checked?manualLS[x.è—¥ä»£]=1:delete manualLS[x.è—¥ä»£];
      setLS(MANUAL_KEY,manualLS);render();
    }
    tb.appendChild(tr);
  });

  $("totalCount").textContent=`å…± ${rawData.length}`;
  $("needBuyCount").textContent=`éœ€æ¡è³¼ ${need}`;
  $("okCount").textContent=`æ­£å¸¸ ${ok}`;
  $("overCount").textContent=`å‹¿å¿˜æˆ‘ ${overCnt}`;

  if(overCnt){
    $("overNotice").style.display="block";
    $("overNotice").innerHTML=`ğŸŒ¸ å‹¿å¿˜æˆ‘ ${overCnt} ç­†ï½œé»æ­¤æŸ¥çœ‹`;
  }else $("overNotice").style.display="none";
}

/* ===== events ===== */
$("reloadBtn").onclick=loadData;
$("resetBtn").onclick=()=>{ $("startMonth").value=$("endMonth").value=new Date().getMonth()+1; render(); }
$("openOverBtn").onclick=()=>{ $("mainApp").style.display="none";$("overScreen").style.display="block";
  const l=$("overList");l.innerHTML="";
  rawData.filter(isOver).forEach(x=>{
    const d=document.createElement("div");
    d.className="line";
    d.innerHTML=`${x.è—¥ä»£} ${x.è—¥å“} <span class="badge-over">åº«å­˜éé«˜</span>`;
    l.appendChild(d);
  });
}
$("backBtn").onclick=()=>{$("overScreen").style.display="none";$("mainApp").style.display="block";}
$("overNotice").onclick=$("openOverBtn").onclick;

/* ===== start ===== */
initYM();
loadData();
})();
</script>
</body>
</html>
