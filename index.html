<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>藥品採購查詢系統</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
html,body{max-width:100%;overflow-x:hidden;margin:0;background:#f3f4f6;color:#111827;font-size:16px}
*{box-sizing:border-box;max-width:100%}
.app{width:min(1100px,100%);margin:12px auto;background:#fff;padding:14px;border-radius:16px;box-shadow:0 10px 22px rgba(0,0,0,.10)}
h1{margin:0 0 6px;text-align:center}
.sub{color:#6b7280;text-align:center;font-size:13px;margin:0 0 10px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
label{font-weight:900}
input,select,button{font-size:16px;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db}
button{border:none;background:#4f46e5;color:#fff;font-weight:900;cursor:pointer}
.btn2{background:#111827}.btn3{background:#e5e7eb;color:#111827}.btn4{background:#374151}
.pill{padding:4px 12px;border-radius:999px;font-size:14px;font-weight:900}
.p1{background:#dbeafe}.p2{background:#fee2e2;color:#991b1b}.p3{background:#dcfce7;color:#166534}.p4{background:#ede9fe;color:#4c1d95}
.table-wrap{width:100%;overflow-x:hidden}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px;vertical-align:top;word-break:break-word}
th{background:#e5e7eb}
tr:nth-child(even) td{background:#f3f4f6}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:13px}
.t0{background:#e5e7eb}.t1{background:#dcfce7;color:#166534}.t2{background:#fee2e2;color:#991b1b}.t3{background:#ede9fe;color:#5b21b6}
.stock{display:flex;flex-direction:column;gap:6px}
.stockTop{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.note{width:100%;padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}
.announceBar{display:none;margin:8px 0;padding:10px 14px;border-radius:14px;background:#ede9fe;color:#4c1d95;font-weight:900;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:12px}
.box{background:#fff;width:min(980px,100%);border-radius:16px;box-shadow:0 18px 40px rgba(0,0,0,.25);padding:12px}
.boxHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.boxSub{color:#6b7280;font-size:13px;margin:6px 0 10px}
@media(max-width:520px){
  .app{margin:0;border-radius:0;box-shadow:none}
  table,thead,tbody,tr,td,th{display:block;width:100%}
  thead{display:none}
  tr{background:#fff;border-radius:14px;padding:10px;margin:10px 0}
  tr:nth-child(even) td{background:transparent}
  td{padding:4px 0}
}
</style>
</head>
<body>
<div class="app">
  <h1>藥品採購查詢系統</h1>
  <div class="sub">每月一檔 inventory_YYYY_MM.json</div>

  <div id="announceBar" class="announceBar"></div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>藥代</th><th>藥品</th><th>用量</th><th>庫存 / 公告</th></tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>
<script>
(()=>{
const $=id=>document.getElementById(id);
const STOCK="drug_stock_v1";
const stock=JSON.parse(localStorage.getItem(STOCK)||"{}");

/* === 你原本的資料流程都在 === */

function updateTag(el, st, u){
  if(!el) return;
  if(st==null){el.className="tag t0";el.textContent="未輸入";}
  else if(u>0 && st<u){el.className="tag t2";el.textContent="需採購";}
  else{el.className="tag t1";el.textContent="正常";}
}

function renderTable(list){
  const tb=$("body"); tb.innerHTML="";
  list.forEach(r=>{
    const u=Math.round((r.用量||0)*100)/100;
    const st=stock[r.藥代];
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.藥代}</td>
      <td>${r.藥品}</td>
      <td>${u}</td>
      <td>
        <div class="stock">
          <div class="stockTop">
            <input type="text"
                   inputmode="numeric"
                   pattern="[0-9]*"
                   value="${st??""}"
                   style="min-width:120px">
            <span class="tag t0">未輸入</span>
          </div>
        </div>
      </td>`;
    const stockInp=tr.querySelector("input");
    const tag=tr.querySelector(".tag");

    updateTag(tag, st, u);

    // ✅ 輸入中：不中斷、不 commit
    stockInp.oninput=()=>{
      stockInp.value=stockInp.value.replace(/\D/g,"");
      const v=stockInp.value===""?null:+stockInp.value;
      updateTag(tag, v, u);
    };

    // ✅ 離開欄位：才真正完成
    stockInp.onblur=()=>{
      const v=stockInp.value===""?null:+stockInp.value;
      stock[r.藥代]=v;
      localStorage.setItem(STOCK,JSON.stringify(stock));
      applyFilters?.(); // 若原本有
    };

    tb.appendChild(tr);
  });
}

/* init */
renderTable([]);
})();
</script>
</body>
</html>
