<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
html,body{max-width:100%;overflow-x:hidden;margin:0;background:#f3f4f6;color:#111827;font-size:16px}
*{box-sizing:border-box;max-width:100%}
.app{width:min(1100px,100%);margin:12px auto;background:#fff;padding:14px;border-radius:16px;box-shadow:0 10px 22px rgba(0,0,0,.10)}
h1{margin:0 0 6px;text-align:center} .sub{color:#6b7280;text-align:center;font-size:13px;margin:0 0 10px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
label{font-weight:900}
input,select,button{font-size:16px;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db}
button{border:none;background:#4f46e5;color:#fff;font-weight:900;cursor:pointer}
.btn2{background:#111827}.btn3{background:#e5e7eb;color:#111827}.btn4{background:#374151}
.pill{padding:4px 12px;border-radius:999px;font-size:14px;font-weight:900}
.p1{background:#dbeafe}.p2{background:#fee2e2;color:#991b1b}.p3{background:#dcfce7;color:#166534}.p4{background:#ede9fe;color:#4c1d95}
.table-wrap{width:100%;overflow-x:auto}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px;vertical-align:top;word-break:break-word}
th{background:#e5e7eb}
tr:nth-child(even) td{background:#f3f4f6}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:13px}
.t0{background:#e5e7eb}.t1{background:#dcfce7;color:#166534}.t2{background:#fee2e2;color:#991b1b}.t3{background:#ede9fe;color:#5b21b6}
.stock{display:flex;flex-direction:column;gap:6px}
.stockTop{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.note{width:100%;padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}
.announceBar{display:none;margin:8px 0;padding:10px 14px;border-radius:14px;background:#ede9fe;color:#4c1d95;font-weight:900;cursor:pointer}
.announceBar:hover{background:#ddd6fe}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:12px}
.box{background:#fff;width:min(980px,100%);border-radius:16px;box-shadow:0 18px 40px rgba(0,0,0,.25);padding:12px}
.boxHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.boxHead h3{margin:0} .boxSub{color:#6b7280;font-size:13px;margin:6px 0 10px}
.box .table-wrap{max-height:70vh;overflow:auto;border-radius:12px}
.small{font-size:13px;color:#6b7280}

/* âœ… æ‰‹æ©Ÿï¼šä¸»æ¸…å–®ç¶­æŒå¡ç‰‡ï¼ˆåªå¥— mainTableï¼‰ */
@media(max-width:520px){
  .app{margin:0;border-radius:0;box-shadow:none}

  .mainTable,
  .mainTable thead,
  .mainTable tbody{display:block;width:100%}

  .mainTable thead{display:none}

  .mainTable tr{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px 14px;
    background:#fff;
    border-radius:14px;
    padding:12px;
    margin:10px 0;
  }

  .mainTable td{display:block;width:100%;padding:0}
  .mainTable tr:nth-child(even) td{background:transparent}

  .mainTable td::before{
    font-weight:900;color:#6b7280;display:block;margin-bottom:4px;
  }
  .mainTable td:nth-child(1)::before{content:"è—¥ä»£"}
  .mainTable td:nth-child(2)::before{content:"è—¥å“"}
  .mainTable td:nth-child(3)::before{content:"ç”¨é‡"}
  .mainTable td:nth-child(4)::before{content:"åº«å­˜ / å…¬å‘Š"}

  .mainTable td:nth-child(4){grid-column: 1 / -1;}

  .mainTable .drugName{
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
    overflow-wrap:anywhere;
    word-break:break-word;
  }

  .mainTable .stockTop input{width:140px}
}

/* âœ… æ‰‹æ©Ÿç‰ˆï¼šå…¬å‘Šæ˜ç´°/éœ€æ¡è³¼æ¸…å–®ï¼ä¸€ç­†ä¸€è¡Œï¼ˆéå¡ç‰‡ï¼‰ï¼Œå·¦å³æ»‘å‹• */
@media (max-width:520px){
  .annTable{display:table;width:100%;min-width:600px;border-collapse:collapse;}
  .annTable thead{display:table-header-group}
  .annTable tbody{display:table-row-group}
  .annTable tr{display:table-row}
  .annTable th,.annTable td{
    display:table-cell;padding:6px 8px;font-size:13px;white-space:nowrap;
  }
  .box .table-wrap{overflow-x:auto}
}
</style>
</head>
<body>
<div class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="sub">æ¯æœˆä¸€æª” inventory_YYYY_MM.jsonï¼ˆå–®æœˆç‚ºä¸»ï¼Œæ”¯æ´é€²éšå¤šæœˆï¼‰</div>

  <div id="announceBar" class="announceBar"></div>

  <div class="row">
    <label>å¹´ä»½</label><select id="year"></select>
    <label>æœˆä»½</label>
    <button id="pm" class="btn4" title="ä¸Šå€‹æœˆ">â—€</button>
    <select id="m1"></select>
    <button id="nm" class="btn4" title="ä¸‹å€‹æœˆ">â–¶</button>

    <label style="margin-left:6px">
      <input id="adv" type="checkbox" style="transform:scale(1.1);margin-right:6px">å¤šæœˆé€²éš
    </label>
    <span id="advBox" style="display:none;align-items:center;gap:8px">
      <span class="small">åˆ°</span><select id="m2"></select>
    </span>

    <button id="reload" class="btn2">é‡æ–°è¼‰å…¥</button>
    <button id="reset" class="btn3">é‡ç½®</button>
  </div>

  <div class="row">
    <label>å» å•†</label>
    <select id="vendorSel"></select>
    <button id="clearVendor" class="btn3">æ¸…é™¤å» å•†</button>
  </div>

  <div class="row">
    <label>æœå°‹</label>
    <input id="q" placeholder="è¼¸å…¥è—¥ä»£æˆ–è—¥å“åç¨±" style="flex:1;min-width:220px">
    <button id="search">æœå°‹</button>
    <button id="export" class="btn4">åŒ¯å‡º Excel</button>
    <button id="yearView" class="btn4">å¹´åº¦ç¸½è¦½</button>
    <button id="buyView" class="btn4">éœ€æ¡è³¼æ¸…å–®</button>
    <button id="admin" class="btn2">ç®¡ç†è€…</button>
    <button id="addExt" class="btn4" style="display:none">æ–°å¢å¤–éƒ¨å…¬å‘Š</button>
  </div>

  <div class="row">
    <span class="pill p1" id="cTotal"></span>
    <span class="pill p2" id="cBuy"></span>
    <span class="pill p3" id="cOk"></span>
    <span class="pill p4" id="cAnn"></span>
  </div>

  <div class="table-wrap">
    <table class="mainTable">
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜ / å…¬å‘Š</th></tr></thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>

<!-- å…¬å‘Šæ˜ç´° -->
<div id="modal" class="modal"><div class="box">
  <div class="boxHead">
    <div>
      <h3>å…¬å‘Šæ˜ç´°</h3>
      <div class="boxSub" id="annRule"></div>
    </div>
    <button id="close" class="btn3">é—œé–‰</button>
  </div>
  <div class="table-wrap">
    <table class="annTable">
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th><th>åŸå› </th><th>æ“ä½œ</th></tr></thead>
      <tbody id="annBody"></tbody>
    </table>
  </div>
</div></div>

<!-- âœ… éœ€æ¡è³¼æ¸…å–® -->
<div id="buyModal" class="modal"><div class="box">
  <div class="boxHead">
    <div>
      <h3>éœ€æ¡è³¼æ¸…å–®</h3>
      <div class="boxSub">æ¯ç¨®è—¥ä»£ä¸€è¡Œï¼ˆåº«å­˜ < ç”¨é‡ï¼‰</div>
    </div>
    <button id="buyClose" class="btn3">é—œé–‰</button>
  </div>
  <div class="table-wrap">
    <table class="annTable">
      <thead>
        <tr>
          <th>è—¥ä»£</th>
          <th>è—¥å“</th>
          <th>ç”¨é‡</th>
          <th>åº«å­˜</th>
          <th>å»ºè­°æ¡è³¼</th>
          <th>å‚™è¨»</th>
        </tr>
      </thead>
      <tbody id="buyBody"></tbody>
    </table>
  </div>
</div></div>

<script>
(()=> {
  const $=id=>document.getElementById(id);

  const STOCK="drug_stock_v1",
        NOTE="drug_note_v1",
        IGN="ignore_auto_announce_v1",
        ADMIN="admin_on_v1",
        EXT="external_announce_v1";

  // âœ… å…¬å‘ŠåŒæ­¥ï¼šå…©ç«¯å…±ç”¨ notices.json
  const NOTICES_URL = "notices.json";
  // è®“é›¢ç·š/æª”æ¡ˆæ¨¡å¼ä¹Ÿèƒ½è·‘ï¼šæœ¬æ©Ÿå¿«å–ä¸€ä»½
  const NOTICE_CACHE = "notice_cache_v1";

  const stock=JSON.parse(localStorage.getItem(STOCK)||"{}");
  const notes=JSON.parse(localStorage.getItem(NOTE)||"{}");
  const ignore=JSON.parse(localStorage.getItem(IGN)||"{}");
  const ext=JSON.parse(localStorage.getItem(EXT)||"[]"); // ä»ä¿ç•™ï¼šç”¨ä¾†è£œã€Œå¤–éƒ¨å…¬å‘Šè—¥ã€åˆ°ä¸»æ¸…å–®

  let adminOn=localStorage.getItem(ADMIN)==="1";
  let rows=[], viewRows=[], vendorMap=new Map();

  // âœ… notices: { [code]: {text, level, updatedAt} }
  let notices = {};

  const pad2=n=>String(n).padStart(2,"0");
  const file=(y,m)=>`inventory_${y}_${pad2(m)}.json`;

  function normCode(s){ return String(s||"").trim().toUpperCase(); }

  async function loadNotices(){
    // å…ˆè®€å¿«å–ï¼ˆé¿å… fetch å¤±æ•—æ™‚æ•´å€‹æ²’æœ‰å…¬å‘Šï¼‰
    try{ notices = JSON.parse(localStorage.getItem(NOTICE_CACHE)||"{}") || {}; }catch{ notices = {}; }

    try{
      const r = await fetch(`${NOTICES_URL}?t=${Date.now()}`, {cache:"no-store"});
      if(!r.ok) return;
      const obj = await r.json();
      if(obj && typeof obj === "object"){
        notices = obj;
        localStorage.setItem(NOTICE_CACHE, JSON.stringify(notices));
      }
    }catch{
      // keep cache
    }
  }

  // âœ… æœ‰å…¬å‘Šï¼šnotices.json æœ‰æ–‡å­—
  function hasNotice(code){
    const k = normCode(code);
    const x = notices[k];
    return !!(x && String(x.text||"").trim());
  }
  function noticeText(code){
    const k = normCode(code);
    return String((notices[k]&&notices[k].text) || "").trim();
  }

  const vendorKey = (s)=>{
    s=(s||"æœªæ¨™ç¤ºå» å•†").trim();
    const m=[...s.matchAll(/[\u4E00-\u9FFF]/g)].map(x=>x[0]);
    if(m.length>=2) return m[0]+m[1];
    if(m.length===1) return m[0];
    return (s.replace(/\s+/g," ").slice(0,8) || "å…¶ä»–");
  };

  const tagHTML=(st,u,ann,extFlag)=>{
    if(extFlag) return `<span class="tag t3">ğŸ“¢ å¤–éƒ¨å…¬å‘Š</span>`;
    if(ann) return `<span class="tag t3">å…¬å‘Š</span>`;
    if(st==null) return `<span class="tag t0">æœªè¼¸å…¥</span>`;
    if(u>0 && st<u) return `<span class="tag t2">éœ€æ¡è³¼</span>`;
    return `<span class="tag t1">æ­£å¸¸</span>`;
  };

  function updateTag(el, st, u, ann=false, extFlag=false){
    if(!el) return;
    if(extFlag){ el.className="tag t3"; el.textContent="ğŸ“¢ å¤–éƒ¨å…¬å‘Š"; return; }
    el.className="tag";
    if(ann){ el.classList.add("t3"); el.textContent="å…¬å‘Š"; return; }
    if(st==null || st===""){ el.classList.add("t0"); el.textContent="æœªè¼¸å…¥"; return; }
    st=Number(st); u=Number(u||0);
    if(u>0 && st<u){ el.classList.add("t2"); el.textContent="éœ€æ¡è³¼"; return; }
    el.classList.add("t1"); el.textContent="æ­£å¸¸";
  }

  function initSelects(){
    const y=new Date().getFullYear();
    $("year").innerHTML="";
    $("year").appendChild(new Option(y,y,true,true));
    $("m1").innerHTML=""; $("m2").innerHTML="";
    for(let i=1;i<=12;i++){ $("m1").appendChild(new Option(i,i)); $("m2").appendChild(new Option(i,i)); }
    const m=new Date().getMonth()+1; $("m1").value=m; $("m2").value=m;
    $("adv").checked=false; $("advBox").style.display="none";
    $("admin").textContent=adminOn?"ç®¡ç†è€…(é–‹)":"ç®¡ç†è€…";
    $("addExt").style.display = adminOn ? "inline-block" : "none";
  }

  // å¤–éƒ¨å…¬å‘Šåˆ¤æ–·ï¼ˆext æ¸…å–®ï¼šç”¨ä¾†æŠŠå¤–éƒ¨å…¬å‘Šè—¥ã€Œè£œé€²ä¸»æ¸…å–®ã€ï¼‰
  const isExt = (code)=> ext.some(x => normCode(x.code) === normCode(code));

  async function loadData(){
    rows=[]; vendorMap=new Map();

    const y=+$("year").value;
    const adv=$("adv").checked;
    const a=+$("m1").value, b=adv?+$("m2").value:a;
    const s=Math.min(a,b), e=Math.max(a,b);
    const monthCount=(e-s+1);

    const agg=new Map();
    for(let m=s;m<=e;m++){
      try{
        const r=await fetch(file(y,m),{cache:"no-store"});
        if(!r.ok) continue;
        const list=await r.json();
        list.forEach(x=>{
          const code=normCode(x["è—¥ä»£"]);
          const name=x["è—¥å“"];
          const ven=x["å» å•†"]||"æœªæ¨™ç¤ºå» å•†";
          if(!agg.has(code)) agg.set(code,{è—¥ä»£:code,è—¥å“:name,å» å•†:ven, sum:0});
          agg.get(code).sum += Number(x["æœˆç”¨é‡"]||0);
        });
      }catch{}
    }

    rows=[...agg.values()].map(x=>{
      const avg = monthCount>0 ? (x.sum/monthCount) : 0;
      const vKey = vendorKey(x.å» å•†);
      if(!vendorMap.has(vKey)) vendorMap.set(vKey,[]);
      const rec={è—¥ä»£:x.è—¥ä»£,è—¥å“:x.è—¥å“,å» å•†:x.å» å•†,å» å•†Key:vKey,ç”¨é‡:avg,å€é–“ç¸½ç”¨é‡:x.sum,æœˆæ•¸:monthCount};
      vendorMap.get(vKey).push(rec);
      return rec;
    });

    // âœ… æŠŠ ext è£œé€² rowsï¼ˆè‹¥ inventory æ²’æœ‰ï¼‰
    ext.forEach(x=>{
      const code=normCode(x.code), name=String(x.name||"").trim();
      if(!code || !name) return;
      if(rows.some(r=>r.è—¥ä»£===code)) return;

      const ven=(x.vendor||"å¤–éƒ¨å…¬å‘Š").trim();
      const vKey=vendorKey(ven);
      const rec={è—¥ä»£:code,è—¥å“:name,å» å•†:ven,å» å•†Key:vKey,ç”¨é‡:0,å€é–“ç¸½ç”¨é‡:0,æœˆæ•¸:monthCount};
      rows.push(rec);
      if(!vendorMap.has(vKey)) vendorMap.set(vKey,[]);
      vendorMap.get(vKey).push(rec);
    });

    buildVendorDropdown();
    applyFilters();
  }

  function buildVendorDropdown(){
    const sel=$("vendorSel");
    const cur=sel.value || "(å…¨éƒ¨)";
    sel.innerHTML="";
    sel.appendChild(new Option("(å…¨éƒ¨)","(å…¨éƒ¨)"));
    [...vendorMap.keys()].sort((a,b)=>a.localeCompare(b,"zh-Hant")).forEach(k=>{
      sel.appendChild(new Option(`${k} (${vendorMap.get(k).length})`,k));
    });
    sel.value=[...sel.options].some(o=>o.value===cur)?cur:"(å…¨éƒ¨)";
  }

  function isAutoAnn(r){
    if(ignore[r.è—¥ä»£]) return false;
    const u=Number(r.ç”¨é‡||0);
    const st=stock[r.è—¥ä»£];
    return u>0 && st!=null && st>u*6;
  }

  // âœ… å…¬å‘Šåˆ¤å®šï¼šä»¥ notices.json ç‚ºä¸»ï¼ˆåŒæ­¥ï¼‰ï¼Œå†åŠ ã€Œè‡ªå‹•å…¬å‘Šã€
  function isAnn(r){
    if(hasNotice(r.è—¥ä»£)) return true;
    return isAutoAnn(r);
  }

  function annReason(r){
    const a=isAutoAnn(r);
    const n=hasNotice(r.è—¥ä»£);
    if(n && a) return "å…¬å‘Š(åŒæ­¥)+è‡ªå‹•";
    if(n) return "å…¬å‘Š(åŒæ­¥)";
    if(a) return "è‡ªå‹•";
    return "";
  }

  function applyFilters(){
    const q=$("q").value.trim();
    const v=$("vendorSel").value;
    viewRows=rows.filter(r=>{
      if(v!=="(å…¨éƒ¨)" && r.å» å•†Key!==v) return false;
      if(q && !(r.è—¥ä»£.includes(q.toUpperCase()) || r.è—¥å“.includes(q))) return false;
      return true;
    });
    renderTable(viewRows);
    renderCounts(viewRows);
    renderAnnounceBar(viewRows);
  }

  function renderTable(list){
    const tb=$("body"); tb.innerHTML="";
    list.forEach(r=>{
      const u=Math.round((r.ç”¨é‡||0)*100)/100;
      const st=stock[r.è—¥ä»£], ann=isAnn(r), extFlag=isExt(r.è—¥ä»£);
      const tr=document.createElement("tr");
      const nText = noticeText(r.è—¥ä»£);

      tr.innerHTML=`
        <td>${r.è—¥ä»£}</td>
        <td class="drugName">${r.è—¥å“}</td>
        <td>${u}</td>
        <td>
          <div class="stock">
            <div class="stockTop">
              <input type="number" inputmode="numeric" value="${st??""}" style="min-width:120px">
              ${tagHTML(st,u,ann,extFlag)}
              ${nText ? `<span class="small">ğŸ“ ${escapeHtml(nText)}</span>` : ``}
            </div>
            <input class="note" placeholder="å‚™è¨»" value="${notes[r.è—¥ä»£]??""}">
          </div>
        </td>`;

      const tagEl=tr.querySelector(".tag");
      const stockInp=tr.querySelector('input[type="number"]');
      const noteInp=tr.querySelector('input.note');

      stockInp.oninput=()=>{ stockInp.value=stockInp.value.replace(/\D/g,""); const v=stockInp.value===""?null:+stockInp.value; updateTag(tagEl,v,u,isAnn(r),extFlag); };
      stockInp.onblur=()=>{ const v=stockInp.value===""?null:+stockInp.value; stock[r.è—¥ä»£]=v; localStorage.setItem(STOCK,JSON.stringify(stock)); applyFilters(); };

      noteInp.oninput=()=>{ notes[r.è—¥ä»£]=noteInp.value; localStorage.setItem(NOTE,JSON.stringify(notes)); };

      tb.appendChild(tr);
    });
  }

  function renderCounts(list){
    let buy=0, ok=0, ann=0;
    list.forEach(r=>{
      const st=stock[r.è—¥ä»£], u=Number(r.ç”¨é‡||0);
      if(isAnn(r)) ann++;
      if(st!=null && u>st) buy++; else if(st!=null) ok++;
    });
    $("cTotal").textContent=`å…± ${list.length}`;
    $("cBuy").textContent=`éœ€æ¡è³¼ ${buy}`;
    $("cOk").textContent=`æ­£å¸¸ ${ok}`;
    $("cAnn").textContent=`å…¬å‘Š ${ann}`;
  }

  function renderAnnounceBar(list){
    const n=list.filter(isAnn).length;
    const bar=$("announceBar");
    if(n){ bar.style.display="block"; bar.textContent=`ğŸ“¢ å…¬å‘Š ${n} ç­†ï¼ˆé»æˆ‘çœ‹æ˜ç´°ï¼‰`; }
    else bar.style.display="none";
  }

  function openAnnModal(){
    const adv=$("adv").checked;
    const s=+$("m1").value, e=adv?+$("m2").value:s;
    const months=Math.abs(e-s)+1;
    $("annRule").textContent = adv
      ? `å¤šæœˆæ¨¡å¼ï¼šè‡ªå‹•åˆ¤æ–·ï¼åº«å­˜ >ï¼ˆå€é–“å¹³å‡æœˆç”¨é‡ï¼‰Ã— 6ï¼ˆå¹³å‡ï¼ç¸½ç”¨é‡ Ã· ${months}ï¼‰`
      : `å–®æœˆæ¨¡å¼ï¼šè‡ªå‹•åˆ¤æ–·ï¼åº«å­˜ > å–®æœˆç”¨é‡ Ã— 6`;

    const list=viewRows.filter(isAnn);
    const tb=$("annBody"); tb.innerHTML="";
    list.forEach(r=>{
      const extFlag=isExt(r.è—¥ä»£);
      const u = extFlag ? "â€”" : (Math.round((r.ç”¨é‡||0)*100)/100);
      const st=stock[r.è—¥ä»£];
      const reason=annReason(r);

      const nText = noticeText(r.è—¥ä»£);
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.è—¥ä»£}</td>
        <td class="drugName">${r.è—¥å“}</td>
        <td>${u}</td>
        <td>${st??""}</td>
        <td>${reason}${nText ? `ï¼š${escapeHtml(nText)}` : ""}</td>
        <td>${adminOn?`
          <button class="btn3" data-del="${r.è—¥ä»£}" style="padding:6px 10px;border-radius:999px;border:1px solid #d1d5db;cursor:pointer">å¿½ç•¥è‡ªå‹•å…¬å‘Š</button>
        `:`<span class="small">éœ€ç®¡ç†è€…</span>`}</td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick=()=>{
        const code=btn.getAttribute("data-del");
        ignore[code]=1;
        localStorage.setItem(IGN,JSON.stringify(ignore));
        applyFilters();
        openAnnModal();
      };
    });

    $("modal").style.display="flex";
  }

  // âœ… éœ€æ¡è³¼æ¸…å–®ï¼šæ¯ç¨®è—¥ä»£ä¸€è¡Œ
  function openBuyModal(){
    const tb=$("buyBody");
    tb.innerHTML="";

    const map=new Map();
    viewRows.forEach(r=>{
      const st=stock[r.è—¥ä»£];
      const u=Number(r.ç”¨é‡||0);
      if(st!=null && u>st){
        if(!map.has(r.è—¥ä»£)) map.set(r.è—¥ä»£, r);
      }
    });

    [...map.values()].forEach(r=>{
      const u=Math.round((r.ç”¨é‡||0)*100)/100;
      const st=Number(stock[r.è—¥ä»£]);
      const need=Math.max(0, Math.ceil(u - st));
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.è—¥ä»£}</td>
        <td class="drugName">${r.è—¥å“}</td>
        <td>${u}</td>
        <td>${st}</td>
        <td>${need}</td>
        <td>${notes[r.è—¥ä»£] ?? ""}</td>`;
      tb.appendChild(tr);
    });

    $("buyModal").style.display="flex";
  }

  function exportExcel(){
    const data=viewRows.map(r=>{
      const st=stock[r.è—¥ä»£];
      const u=Math.round((r.ç”¨é‡||0)*100)/100;
      const nText = noticeText(r.è—¥ä»£);
      return {
        è—¥ä»£:r.è—¥ä»£,
        è—¥å“:r.è—¥å“,
        å» å•†:r.å» å•†Key,
        åŸå» å•†:r.å» å•†,
        ç”¨é‡:u,
        åº«å­˜:st??"",
        å…¬å‘Š:isAnn(r)?"æ˜¯":"å¦",
        å…¬å‘ŠåŸå› :annReason(r),
        å…¬å‘Šå…§å®¹:nText,
        å‚™è¨»:notes[r.è—¥ä»£]??""
      };
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"data");
    const y=$("year").value, adv=$("adv").checked, a=$("m1").value, b=adv?$("m2").value:a;
    XLSX.writeFile(wb,`æ¡è³¼æŸ¥è©¢_${y}_${a}-${b}.xlsx`);
  }

  async function yearOverview(){
    const y=+$("year").value;
    const backup={m1:$("m1").value,m2:$("m2").value,adv:$("adv").checked};
    const sum=[];
    for(let m=1;m<=12;m++){
      $("adv").checked=false; $("advBox").style.display="none";
      $("m1").value=m;
      await loadData();
      let ann=0,buy=0,total=rows.length;
      rows.forEach(r=>{
        const st=stock[r.è—¥ä»£], u=Number(r.ç”¨é‡||0);
        if(isAnn(r)) ann++;
        if(st!=null && u>st) buy++;
      });
      sum.push({æœˆä»½:m,ç­†æ•¸:total,éœ€æ¡è³¼:buy,å…¬å‘Š:ann});
    }
    $("m1").value=backup.m1; $("m2").value=backup.m2; $("adv").checked=backup.adv;
    $("advBox").style.display=backup.adv?"inline-flex":"none";
    await loadData();

    $("annRule").textContent="å¹´åº¦ç¸½è¦½ï¼ˆæ¯æœˆï¼šç­†æ•¸ / éœ€æ¡è³¼ / å…¬å‘Šï¼‰";
    const tb=$("annBody"); tb.innerHTML="";
    sum.forEach(x=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${x.æœˆä»½}</td><td>â€”</td><td>${x.ç­†æ•¸}</td><td>${x.éœ€æ¡è³¼}</td><td>${x.å…¬å‘Š}</td><td></td>`;
      tb.appendChild(tr);
    });
    $("modal").style.display="flex";
  }

  function shiftMonth(d){
    let m=+$("m1").value; m+=d;
    if(m<1) m=1; if(m>12) m=12;
    $("m1").value=m;
    if(!$("adv").checked) $("m2").value=m;
    loadData();
  }

  function addExternalAnnounce(){
    if(!adminOn) return alert("éœ€ç®¡ç†è€…æ¨¡å¼");
    const code=normCode(prompt("å¤–éƒ¨å…¬å‘Šè—¥ä»£ï¼ˆå»ºè­° EXT001 / EXT-xxxï¼‰","EXT001")||"");
    if(!code) return;
    if(ext.some(x=>normCode(x.code)===code) || rows.some(r=>r.è—¥ä»£===code)) return alert("æ­¤è—¥ä»£å·²å­˜åœ¨ï¼Œè«‹æ›ä¸€å€‹");

    const name=(prompt("è—¥å“åç¨±ï¼ˆåªå¡«è—¥åï¼‰","")||"").trim();
    if(!name) return;

    const vendor=(prompt("å» å•†ï¼ˆå¯ç©ºï¼‰","å¤–éƒ¨å…¬å‘Š")||"å¤–éƒ¨å…¬å‘Š").trim();
    ext.push({code,name,vendor,createdAt:Date.now()});
    localStorage.setItem(EXT,JSON.stringify(ext));

    alert("å·²æ–°å¢å¤–éƒ¨å…¬å‘Šè—¥ã€‚æé†’ï¼šå…¬å‘Šå…§å®¹è«‹å¯«å…¥ notices.jsonï¼Œæ‰‹æ©Ÿ/ç¶²é æ‰æœƒåŒæ­¥é¡¯ç¤ºã€‚");
    loadData();
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // events
  $("reload").onclick=async ()=>{ await loadNotices(); await loadData(); };
  $("search").onclick=applyFilters;
  $("q").addEventListener("keydown",e=>{ if(e.key==="Enter") applyFilters(); });
  $("vendorSel").onchange=applyFilters;
  $("clearVendor").onclick=()=>{ $("vendorSel").value="(å…¨éƒ¨)"; applyFilters(); };
  $("pm").onclick=()=>shiftMonth(-1);
  $("nm").onclick=()=>shiftMonth(1);
  $("m1").onchange=()=>{ if(!$("adv").checked) $("m2").value=$("m1").value; loadData(); };
  $("m2").onchange=loadData;

  $("adv").onchange=()=>{
    const on=$("adv").checked;
    $("advBox").style.display=on?"inline-flex":"none";
    if(!on) $("m2").value=$("m1").value;
    loadData();
  };

  $("announceBar").onclick=openAnnModal;
  $("close").onclick=()=>$("modal").style.display="none";
  $("modal").onclick=(e)=>{ if(e.target.id==="modal") $("modal").style.display="none"; };

  $("buyView").onclick=openBuyModal;
  $("buyClose").onclick=()=>$("buyModal").style.display="none";
  $("buyModal").onclick=(e)=>{ if(e.target.id==="buyModal") $("buyModal").style.display="none"; };

  $("export").onclick=exportExcel;
  $("yearView").onclick=yearOverview;

  $("admin").onclick=()=>{
    const ok=prompt("è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼ˆæ­¤è£ç½®ï¼‰","");
    if(ok==="admin"){
      adminOn=!adminOn;
      localStorage.setItem(ADMIN,adminOn?"1":"0");
      alert(adminOn?"ç®¡ç†è€…æ¨¡å¼å·²é–‹å•Ÿ":"ç®¡ç†è€…æ¨¡å¼å·²é—œé–‰");
    }
    $("admin").textContent=adminOn?"ç®¡ç†è€…(é–‹)":"ç®¡ç†è€…";
    $("addExt").style.display = adminOn ? "inline-block" : "none";
  };

  $("addExt").onclick=addExternalAnnounce;

  // âœ… é‡ç½®ï¼šä¸å‹•å…¬å‘Šä¾†æºï¼ˆnotices.jsonï¼‰ï¼Œåªæ¸…åº«å­˜/å‚™è¨»
  $("reset").onclick=()=>{
    localStorage.removeItem(STOCK);
    localStorage.removeItem(NOTE);
    location.reload();
  };

  // init
  initSelects();
  (async ()=>{
    await loadNotices();
    await loadData();
  })();
})();
</script>
</body>
</html>
