<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>

<style>
html, body {
  max-width: 100%;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
  font-size: 16px;
  background: #f3f4f6;
  color: #111827;
}
* { box-sizing: border-box; max-width: 100%; }

.app{
  width: min(1100px, 100%);
  margin: 16px auto;
  background: #fff;
  padding: 16px;
  border-radius: 16px;
  box-shadow: 0 12px 28px rgba(0,0,0,.12);
}
h1{ text-align:center; margin:0 0 8px; }
.subtitle{ text-align:center; color:#6b7280; font-size:14px; margin-bottom:12px; }

.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; }
label{ font-weight:800; }
input, select, button{
  font-size:16px; padding:8px 12px; border-radius:999px;
  border:1px solid #d1d5db; max-width:100%;
}
button{ background:#4f46e5; color:#fff; font-weight:800; border:none; cursor:pointer; }
.secondary-btn{ background:#111827; }
.ghost-btn{ background:#e5e7eb; color:#111827; }

#overNotice{
  display:none; margin-bottom:12px; padding:10px 14px;
  border-radius:14px; background:#ede9fe; color:#4c1d95;
  font-weight:900; cursor:pointer;
}
#overNotice:hover{ background:#ddd6fe; }

.pill{ padding:4px 12px; border-radius:999px; font-size:14px; font-weight:800; }
.pill-total{ background:#dbeafe; }
.pill-buy{ background:#fee2e2; color:#991b1b; }
.pill-ok{ background:#dcfce7; color:#166534; }
.pill-over{ background:#ede9fe; color:#4c1d95; }

.table-wrap{ width:100%; overflow-x:hidden; }
table{ width:100%; border-collapse:collapse; table-layout:fixed; }
th, td{ padding:8px; vertical-align:top; word-break:break-word; }
th{ background:#e5e7eb; }
tr:nth-child(even) td{ background:#f3f4f6; }

.tag{ display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:14px; }
.tag-empty{ background:#e5e7eb; }
.tag-ok{ background:#dcfce7; color:#166534; }
.tag-buy{ background:#fee2e2; color:#991b1b; }
.tag-over{ background:#ede9fe; color:#5b21b6; }

.stock-wrap{ display:flex; flex-direction:column; gap:6px; }
.stock-top{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.note-input{ width:100%; padding:6px 10px; border-radius:10px; border:1px solid #d1d5db; font-size:14px; }

@media (max-width:520px){
  .app{ margin:0; border-radius:0; box-shadow:none; }
  table, thead, tbody, tr, td, th{ display:block; width:100%; }
  thead{ display:none; }
  tr{ background:#fff; border-radius:14px; padding:10px; margin-bottom:10px; }
  td{ padding:4px 0; }
  td::before{ font-weight:900; color:#6b7280; display:block; margin-bottom:2px; }
  td:nth-child(1)::before{ content:"è—¥ä»£"; }
  td:nth-child(2)::before{ content:"è—¥å“"; }
  td:nth-child(3)::before{ content:"ç”¨é‡"; }
  td:nth-child(4)::before{ content:"åº«å­˜"; }
}
</style>
</head>
<body>
<div class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="subtitle">æ¯æœˆä¸€æª” inventory_YYYY_MM.json</div>

  <div id="overNotice"></div>

  <div class="row">
    <button id="resetBtn" class="ghost-btn">é‡ç½®</button>
  </div>

  <div class="row">
    <label>å¹´ä»½</label>
    <select id="yearSelect"></select>
    <label>æœˆä»½</label>
    <select id="startMonth"></select>
    åˆ°
    <select id="endMonth"></select>
    <button id="reloadBtn" class="secondary-btn">é‡æ–°è¼‰å…¥</button>
    <button id="filterNeedBtn" class="ghost-btn">åªçœ‹éœ€æ¡è³¼</button>
  </div>

  <div class="row">
    <label>æœå°‹è—¥å“</label>
    <input id="searchInput" placeholder="è¼¸å…¥è—¥ä»£æˆ–è—¥å“åç¨±">
    <button id="searchBtn">æœå°‹</button>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount"></span>
    <span class="pill pill-buy" id="needBuyCount"></span>
    <span class="pill pill-ok" id="okCount"></span>
    <span class="pill pill-over" id="overCount"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>è—¥ä»£</th>
          <th>è—¥å“</th>
          <th>ç”¨é‡</th>
          <th>åº«å­˜</th>
        </tr>
      </thead>
      <tbody id="drugBody"></tbody>
    </table>
  </div>

  <div id="overList" style="margin-top:16px; display:none;">
    <h3>ğŸŒ¸ å‹¿å¿˜æˆ‘æ¸…å–®</h3>
    <ul id="overListBody"></ul>
  </div>
</div>
<script>
(() => {
  const $ = id => document.getElementById(id);
  let rawData = [];

  const STOCK_KEY = "drug_stock_v1";
  const MANUAL_KEY = "manual_over_v1";
  const NOTE_KEY = "drug_note_v1";

  const stock = JSON.parse(localStorage.getItem(STOCK_KEY) || "{}");
  const manual = JSON.parse(localStorage.getItem(MANUAL_KEY) || "{}");
  const notes = JSON.parse(localStorage.getItem(NOTE_KEY) || "{}");

  function initYear(){
    const y = new Date().getFullYear();
    $("yearSelect").innerHTML = "";
    const o = new Option(y, y);
    o.selected = true;
    $("yearSelect").appendChild(o);
  }

  function initMonths(){
    for(let i=1;i<=12;i++){
      $("startMonth").appendChild(new Option(i,i));
      $("endMonth").appendChild(new Option(i,i));
    }
    const m = new Date().getMonth()+1;
    $("startMonth").value = m;
    $("endMonth").value = m;
  }

  const fileName = (y,m)=>`inventory_${y}_${String(m).padStart(2,"0")}.json`;

  async function loadData(){
    rawData = [];
    const y = $("yearSelect").value;
    for(let m=1;m<=12;m++){
      try{
        const r = await fetch(fileName(y,m), {cache:"no-store"});
        if(!r.ok) continue;
        const rows = await r.json();
        rows.forEach(x=>{
          let rec = rawData.find(r=>r.è—¥ä»£===x["è—¥ä»£"]);
          if(!rec){
            rec = {è—¥ä»£:x["è—¥ä»£"], è—¥å“:x["è—¥å“"]};
            rawData.push(rec);
          }
          rec[`m${m}`] = Number(x["æœˆç”¨é‡"]||0);
        });
      }catch{}
    }
    render();
  }

  function usage(x){
    let s=+$("startMonth").value, e=+$("endMonth").value, sum=0;
    for(let i=s;i<=e;i++) sum += x[`m${i}`]||0;
    return sum;
  }

   function isOver(x){
    if(manual[x.è—¥ä»£]) return true;
    const u = usage(x);
    const st = stock[x.è—¥ä»£];
    return u>0 && st!=null && st>u*6;
  }

  function render(){
    const tb = $("drugBody");
    tb.innerHTML = "";
    let over=0, need=0, ok=0;

    rawData.forEach(x=>{
      const u = usage(x);
      const st = stock[x.è—¥ä»£];
      const overFlag = isOver(x);
      if(overFlag) over++;
      if(st!=null && u>st) need++;
      else if(st!=null) ok++;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.è—¥ä»£}</td>
        <td>${x.è—¥å“}</td>
        <td>${u}</td>
        <td>
          <div class="stock-wrap">
            <div class="stock-top">
              <input type="number" value="${st??""}">
              ${overFlag?'<span class="tag tag-over">åº«å­˜éé«˜</span>':
                st==null?'<span class="tag tag-empty">æœªè¼¸å…¥</span>':
                '<span class="tag tag-ok">æ­£å¸¸</span>'}
            </div>
            <input class="note-input" placeholder="å‚™è¨»" value="${notes[x.è—¥ä»£]??""}">
          </div>
        </td>
      `;

      const [inp, noteInp] = tr.querySelectorAll("input");
      inp.oninput = ()=>{
        stock[x.è—¥ä»£] = inp.value===""?null:+inp.value;
        localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
        render();
      };
      noteInp.oninput = ()=>{
        notes[x.è—¥ä»£] = noteInp.value;
        localStorage.setItem(NOTE_KEY, JSON.stringify(notes));
      };

      tb.appendChild(tr);
    });

    $("totalCount").textContent = `å…± ${rawData.length}`;
    $("needBuyCount").textContent = `éœ€æ¡è³¼ ${need}`;
    $("okCount").textContent = `æ­£å¸¸ ${ok}`;
    $("overCount").textContent = `å‹¿å¿˜æˆ‘ ${over}`;

    if(over){
      $("overNotice").style.display="block";
      $("overNotice").textContent = `ğŸŒ¸ å‹¿å¿˜æˆ‘ ${over} ç­†`;
    }else{
      $("overNotice").style.display="none";
    }

    // å‹¿å¿˜æˆ‘æ¸…å–®
    const list = $("overListBody");
    list.innerHTML = "";
    const keys = Object.keys(manual);
    if(keys.length){
      $("overList").style.display = "block";
      keys.forEach(k=>{
        const li = document.createElement("li");
        li.textContent = `${k} (${rawData.find(r=>r.è—¥ä»£===k)?.è—¥å“||""})`;
        list.appendChild(li);
      });
    }else{
      $("overList").style.display = "none";
    }
  }
  // æœå°‹åŠŸèƒ½
  $("searchBtn").onclick = () => {
    const keyword = $("searchInput").value.trim();
    if(!keyword){ render(); return; }
    const tb = $("drugBody");
    tb.innerHTML = "";
    rawData.filter(x=>x.è—¥ä»£.includes(keyword) || x.è—¥å“.includes(keyword))
      .forEach(x=>{
        const u = usage(x);
        const st = stock[x.è—¥ä»£];
        const overFlag = isOver(x);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${x.è—¥ä»£}</td>
          <td>${x.è—¥å“}</td>
          <td>${u}</td>
          <td>
            <div class="stock-wrap">
              <div class="stock-top">
                <input type="number" value="${st??""}">
                ${overFlag?'<span class="tag tag-over">åº«å­˜éé«˜</span>':
                  st==null?'<span class="tag tag-empty">æœªè¼¸å…¥</span>':
                  '<span class="tag tag-ok">æ­£å¸¸</span>'}
              </div>
              <input class="note-input" placeholder="å‚™è¨»" value="${notes[x.è—¥ä»£]??""}">
            </div>
          </td>
        `;
        tb.appendChild(tr);
      });
  };

  // é‡ç½®åŠŸèƒ½
  $("resetBtn").onclick = () => {
    localStorage.removeItem(STOCK_KEY);
    localStorage.removeItem(MANUAL_KEY);
    localStorage.removeItem(NOTE_KEY);
    location.reload();
  };

  // åªçœ‹éœ€æ¡è³¼
  $("filterNeedBtn").onclick = () => {
    const tb = $("drugBody");
    tb.innerHTML = "";
    rawData.filter(x => {
      const u = usage(x);
      const st = stock[x.è—¥ä»£];
      return st!=null && u > st;
    }).forEach(x => {
      const u = usage(x);
      const st = stock[x.è—¥ä»£];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.è—¥ä»£}</td>
        <td>${x.è—¥å“}</td>
        <td>${u}</td>
        <td>
          <div class="stock-wrap">
            <div class="stock-top">
              <input type="number" value="${st??""}">
              <span class="tag tag-buy">éœ€æ¡è³¼</span>
            </div>
            <input class="note-input" placeholder="å‚™è¨»" value="${notes[x.è—¥ä»£]??""}">
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  };

  $("reloadBtn").onclick = loadData;
  $("startMonth").onchange = render;
  $("endMonth").onchange = render;

  initYear();
  initMonths();
  loadData();
})();
</script>
</body>
</html>

