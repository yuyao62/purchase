<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>藥品採購查詢系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #eef1f7; display: flex; justify-content: center; min-height: 100vh; }
    .app { width: min(1100px, 100%); background: #fff; margin: 20px; padding: 24px; border-radius: 20px; box-shadow: 0 18px 40px rgba(0,0,0,.12); }
    h1 { text-align: center; margin-bottom: 6px; }
    .subtitle { text-align: center; color: #6b7280; font-size: 14px; margin-bottom: 20px; }

    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 16px; }
    label { font-weight: 800; }

    input, select {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    button {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: #4f46e5;
      color: #fff;
      font-weight: 800;
      cursor: pointer;
    }

    .emergency-btn { background:#dc2626; animation:pulse 1.4s infinite; }
    @keyframes pulse {
      0% { box-shadow:0 0 0 0 rgba(220,38,38,.6); }
      70% { box-shadow:0 0 0 14px rgba(220,38,38,0); }
      100% { box-shadow:0 0 0 0 rgba(220,38,38,0); }
    }

    .pill { padding:4px 12px; border-radius:999px; font-size:13px; font-weight:800; }
    .pill-total { background:#dbeafe; color:#1e3a8a; }
    .pill-buy { background:#fee2e2; color:#991b1b; }
    .pill-ok { background:#dcfce7; color:#166534; }

    table { width:100%; border-collapse:collapse; font-size:13px; }
    th { background:#e5e7eb; padding:8px; position:sticky; top:0; }
    td { padding:6px 8px; }
    tr:nth-child(even) td { background:#f3f4f6; }

    .status-tag { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; }
    .status-empty { background:#e5e7eb; }
    .status-buy { background:#fee2e2; color:#b91c1c; }
    .status-ok { background:#dcfce7; color:#166534; }

    .autocomplete-box {
      position:absolute; background:#fff; width:100%;
      border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15);
      max-height:240px; overflow:auto; display:none; z-index:999;
    }
    .autocomplete-item { padding:10px 14px; cursor:pointer; }
    .autocomplete-item:hover { background:#eef2ff; }

    .modal {
      display:none; position:fixed; inset:0;
      background:radial-gradient(circle at top,#7f1d1d,#000);
      color:#fff; justify-content:center; align-items:center;
    }
  </style>
</head>

<body>
<div class="app">
  <h1>藥品採購查詢系統</h1>
  <div class="subtitle">廠商下拉：中文前2碼 → 英文前5碼（中文優先顯示）</div>

  <div class="row">
    <label>廠商：</label>
    <select id="vendorSelect"><option value="">全部</option></select>

    <label>搜尋：</label>
    <div style="position:relative;flex:1">
      <input id="searchInput" style="width:100%" placeholder="藥代 / 廠商 / 藥名">
      <div id="autocompleteBox" class="autocomplete-box"></div>
    </div>

    <button id="searchBtn">查詢</button>
    <button id="resetBtn">重置</button>
    <button id="emergencyBtn" class="emergency-btn">緊急</button>

    <label><input type="checkbox" id="needBuyOnly"> 只顯示需採購</label>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount"></span>
    <span class="pill pill-buy" id="needBuyCount"></span>
    <span class="pill pill-ok" id="okCount"></span>
  </div>

  <table>
    <thead>
      <tr><th>廠商</th><th>藥代</th><th>藥品</th><th>月用量</th><th>庫存</th><th>狀態</th></tr>
    </thead>
    <tbody id="drugBody"></tbody>
  </table>

  <canvas id="chart" height="180"></canvas>
</div>

<div id="emergencyModal" class="modal">
  <div>
    <h1>⚠️ 請洽店長</h1>
    <button onclick="document.getElementById('emergencyModal').style.display='none'">我知道了</button>
  </div>
</div>

<script>
(() => {
  let rawData=[], viewData=[], chart;

  const $=id=>document.getElementById(id);
  const isEng=s=>/^[A-Za-z]/.test(s);
  const hasZh=s=>/[\u4e00-\u9fff]/.test(s);

  const vendorKey=v=>{
    v=String(v||"").trim();
    return isEng(v)?v.slice(0,5).toUpperCase():v.slice(0,2);
  };

  function populateVendors(){
    const keys=[...new Set(rawData.map(x=>vendorKey(x.廠商)))].filter(Boolean);
    keys.sort((a,b)=>{
      const ae=/^[A-Z]/.test(a), be=/^[A-Z]/.test(b);
      if(ae!==be) return ae-be;  // 中文先
      return a.localeCompare(b);
    });
    $("vendorSelect").innerHTML='<option value="">全部</option>';
    keys.forEach(k=>{
      const o=document.createElement("option");
      o.value=k;
      o.textContent=/^[A-Z]/.test(k)?`${k}（英文前5碼）`:`${k}（中文前2碼）`;
      $("vendorSelect").appendChild(o);
    });
  }

  function filterData(){
    const vSel=$("vendorSelect").value;
    const kw=$("searchInput").value.trim();
    const need=$("needBuyOnly").checked;

    let base=rawData.filter(x=>{
      if(vSel && vendorKey(x.廠商)!==vSel) return false;
      if(!kw) return true;
      return x.藥代.startsWith(kw.slice(0,5))
        || (hasZh(kw)?x.廠商.startsWith(kw.slice(0,2)):x.廠商.toUpperCase().startsWith(kw.toUpperCase().slice(0,5)))
        || x.藥品.includes(kw);
    });

    viewData=need?base.filter(x=>x.需採購):base;
    render(base);
  }

  function render(base){
    $("drugBody").innerHTML="";
    viewData.forEach(x=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${x.廠商}</td><td>${x.藥代}</td><td>${x.藥品}</td><td>${x.月用量}</td>
        <td><input type="number" value="${x.庫存量??""}"></td><td></td>`;
      const inp=tr.querySelector("input");
      const td=tr.lastChild;
      inp.oninput=()=>{
        x.庫存量=inp.value===""?null:+inp.value;
        x.需採購=x.庫存量!=null && x.月用量>x.庫存量;
        td.innerHTML=x.庫存量==null?"未輸入":x.需採購?"需採購":"庫存足夠";
        renderStats(base);
      };
      $("drugBody").appendChild(tr);
    });
    renderStats(base);
  }

  function renderStats(base){
    const total=base.length;
    const need=base.filter(x=>x.需採購).length;
    const ok=base.filter(x=>x.庫存量!=null&&!x.需採購).length;
    $("totalCount").textContent=`共 ${total} 筆`;
    $("needBuyCount").textContent=`需採購 ${need} 筆`;
    $("okCount").textContent=`庫存足夠 ${ok} 筆`;

    if(chart) chart.destroy();
    chart=new Chart($("chart"),{
      type:"pie",
      data:{labels:["需採購","庫存足夠"],datasets:[{data:[need,ok]}]},
    });
  }

  async function load(){
    const r=await fetch("inventory.json");
    rawData=(await r.json()).map(x=>({...x,庫存量:null,需採購:false}));
    populateVendors();
    filterData();
  }

  $("searchBtn").onclick=filterData;
  $("resetBtn").onclick=()=>{ $("vendorSelect").value="";$("searchInput").value="";$("needBuyOnly").checked=false;filterData(); };
  $("vendorSelect").onchange=filterData;
  $("needBuyOnly").onchange=filterData;
  $("emergencyBtn").onclick=()=>$("emergencyModal").style.display="flex";

  load();
})();
</script>
</body>
</html>
