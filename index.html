<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<style>
html,body{max-width:100%;overflow-x:hidden;margin:0;font:16px/1.4 system-ui;background:#f3f4f6;color:#111827}*{box-sizing:border-box;max-width:100%}
.app{width:min(1100px,100%);margin:16px auto;background:#fff;padding:14px;border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.12)}
h1{margin:0 0 6px;text-align:center}.sub{margin:0 0 10px;text-align:center;color:#6b7280;font-size:13px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
label{font-weight:900}input,select,button{padding:8px 12px;border-radius:999px;border:1px solid #d1d5db;font-size:16px}
button{border:none;background:#4f46e5;color:#fff;font-weight:900;cursor:pointer}
.b2{background:#111827}.b3{background:#e5e7eb;color:#111827}.b4{background:#374151}
.pill{padding:4px 12px;border-radius:999px;font-size:14px;font-weight:900;display:inline-flex;gap:6px;align-items:center}
.p1{background:#dbeafe}.p2{background:#fee2e2;color:#991b1b}.p3{background:#dcfce7;color:#166534}.p4{background:#ede9fe;color:#4c1d95;cursor:pointer}
.table-wrap{width:100%;overflow-x:hidden}table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px;vertical-align:top;word-break:break-word}th{background:#e5e7eb}tr:nth-child(even) td{background:#f3f4f6}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:13px}
.t0{background:#e5e7eb}.t1{background:#dcfce7;color:#166534}.t2{background:#fee2e2;color:#991b1b}.t3{background:#ede9fe;color:#5b21b6}
.stock{display:flex;flex-direction:column;gap:6px}.top{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.note{width:100%;padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}
.tabs button{padding:8px 10px}.active{outline:3px solid rgba(79,70,229,.25)}
#noticeBar{display:none;margin:10px 0;padding:10px 14px;border-radius:14px;background:#ede9fe;color:#4c1d95;font-weight:900;cursor:pointer}
#noticeBar:hover{background:#ddd6fe}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px}
.card{width:min(980px,100%);background:#fff;border-radius:18px;padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
.card h3{margin:0 0 8px}.muted{color:#6b7280;font-size:13px}
.close{float:right;background:#e5e7eb;color:#111827}
@media(max-width:520px){
.app{margin:0;border-radius:0;box-shadow:none}table,thead,tbody,tr,td,th{display:block;width:100%}thead{display:none}
tr{background:#fff;border-radius:14px;padding:10px;margin:10px 0}td{padding:4px 0}td::before{font-weight:900;color:#6b7280;display:block;margin-bottom:2px}
td:nth-child(1)::before{content:"è—¥ä»£"}td:nth-child(2)::before{content:"è—¥å“"}td:nth-child(3)::before{content:"ç”¨é‡"}td:nth-child(4)::before{content:"åº«å­˜"}
}
</style></head><body>
<div class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1><div class="sub">å–®æœˆç‚ºä¸»ï½œå¯åˆ‡æ›ã€Œå¤šæœˆé€²éšæ¨¡å¼ã€ï½œæ¯æœˆä¸€æª” inventory_YYYY_MM.json</div>

  <div class="row tabs">
    <button id="tabMain" class="active">æŸ¥è©¢</button>
    <button id="tabYear">å¹´åº¦ç¸½è¦½</button>
    <button id="tabVendor">å» å•†é </button>
    <button id="exportBtn" class="b3">åŒ¯å‡º Excel</button>
  </div>

  <div id="noticeBar"></div>

  <div class="row">
    <label>å¹´ä»½</label><select id="year"></select>
    <label>æœˆä»½</label>
    <button id="pm" class="b4" title="ä¸Šæœˆ">â—€</button>
    <select id="m1"></select>
    <button id="nm" class="b4" title="ä¸‹æœˆ">â–¶</button>

    <label style="margin-left:6px"><input id="adv" type="checkbox"/> å¤šæœˆé€²éšæ¨¡å¼</label>
    <span id="m2wrap" style="display:none;align-items:center;gap:8px">
      <span>åˆ°</span><select id="m2"></select>
    </span>

    <button id="reload" class="b2">é‡æ–°è¼‰å…¥</button>
    <button id="reset" class="b3">é‡ç½®</button>
  </div>

  <div class="row">
    <label>å» å•†</label>
    <select id="vendor"></select>
    <button id="clearVendor" class="b3">æ¸…é™¤å» å•†</button>

    <label style="margin-left:6px">æœå°‹</label>
    <input id="q" placeholder="è¼¸å…¥è—¥ä»£æˆ–è—¥å“åç¨±"/>
    <button id="go">æœå°‹</button>
    <button id="clearQ" class="b3">æ¸…é™¤</button>
  </div>

  <div class="row">
    <span class="pill p1" id="cAll"></span>
    <span class="pill p2" id="cBuy"></span>
    <span class="pill p3" id="cOk"></span>
    <span class="pill p4" id="cNotice">å…¬å‘Š 0</span>
  </div>

  <div id="viewMain">
    <div class="table-wrap"><table>
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th></tr></thead>
      <tbody id="tb"></tbody>
    </table></div>
  </div>

  <div id="viewYear" style="display:none">
    <div class="row"><div class="pill p1">å¹´åº¦ç¸½è¦½ï¼šæœƒè¼‰å…¥è©²å¹´å¯å–å¾—çš„æ‰€æœ‰æœˆä»½</div></div>
    <div class="table-wrap"><table>
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>å¹´åº¦ç¸½ç”¨é‡</th></tr></thead>
      <tbody id="tbYear"></tbody>
    </table></div>
  </div>

  <div id="viewVendor" style="display:none">
    <div class="row"><div class="pill p1">å» å•†é ï¼šä¾ã€Œè—¥å“åç¨±ä¸­çš„ä¸­æ–‡å‰ 2 ç¢¼ã€åˆ†ç¾¤</div></div>
    <div class="table-wrap"><table>
      <thead><tr><th>å» å•†</th><th>è—¥ä»£</th><th>è—¥å“</th></tr></thead>
      <tbody id="tbVendor"></tbody>
    </table></div>
  </div>
</div>

<!-- å…¬å‘Šå½ˆçª— -->
<div class="modal" id="modal">
  <div class="card">
    <button class="close" id="close">é—œé–‰</button>
    <h3>å…¬å‘Šæ˜ç´°</h3>
    <div class="muted" id="noticeHint"></div>
    <div class="table-wrap"><table>
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th><th>åŸå› </th><th>ç®¡ç†</th></tr></thead>
      <tbody id="tbNotice"></tbody>
    </table></div>
  </div>
</div>

<script>
(()=>{const $=id=>document.getElementById(id);
let rows=[], view="main", lastExport=[];
const K_ST="drug_stock_v1", K_MA="manual_notice_v1", K_NO="drug_note_v1", K_DI="dismiss_notice_v1";
const st=JSON.parse(localStorage.getItem(K_ST)||"{}"), ma=JSON.parse(localStorage.getItem(K_MA)||"{}"),
      no=JSON.parse(localStorage.getItem(K_NO)||"{}"), di=JSON.parse(localStorage.getItem(K_DI)||"{}");
const fn=(y,m)=>`inventory_${y}_${String(m).padStart(2,"0")}.json`;
const cjk2=s=>{const m=(s||"").match(/[\u4e00-\u9fff]/g);return m&&m.length? (m[0]+(m[1]||m[0])):"å…¶ä»–"};
const tag=(stock,usage,auto,man)=>man?'<span class="tag t3">æ‰‹å‹•å…¬å‘Š</span>':auto?'<span class="tag t3">è‡ªå‹•å…¬å‘Š</span>':stock==null?'<span class="tag t0">æœªè¼¸å…¥</span>':usage>0&&stock<usage?'<span class="tag t2">éœ€æ¡è³¼</span>':'<span class="tag t1">æ­£å¸¸</span>';

function init(){const y=new Date().getFullYear();$("year").innerHTML="";$("year").appendChild(new Option(y,y,true,true));
  ["m1","m2"].forEach(id=>{$(id).innerHTML="";for(let i=1;i<=12;i++)$(id).appendChild(new Option(i,i));});
  const m=new Date().getMonth()+1; $("m1").value=m; $("m2").value=m; bind(); loadMain();
}
function bind(){
  $("adv").onchange=()=>{$("m2wrap").style.display=$("adv").checked?"inline-flex":"none"; if(!$("adv").checked) $("m2").value=$("m1").value; loadMain();}
  $("m1").onchange=()=>{if(!$("adv").checked) $("m2").value=$("m1").value; loadMain();}
  $("m2").onchange=loadMain;
  $("pm").onclick=()=>shift(-1); $("nm").onclick=()=>shift(1);
  $("reload").onclick=()=>{view==="main"?loadMain():view==="year"?loadYear():loadVendors();};
  $("go").onclick=render; $("clearQ").onclick=()=>{$("q").value="";render();};
  $("vendor").onchange=render; $("clearVendor").onclick=()=>{$("vendor").value="__ALL__";render();};
  $("reset").onclick=()=>{[K_ST,K_MA,K_NO,K_DI].forEach(k=>localStorage.removeItem(k));location.reload();}
  $("noticeBar").onclick=openNotice; $("cNotice").onclick=openNotice; $("close").onclick=closeNotice; $("modal").onclick=e=>{if(e.target.id==="modal")closeNotice();}
  $("tabMain").onclick=()=>switchView("main"); $("tabYear").onclick=()=>switchView("year"); $("tabVendor").onclick=()=>switchView("vendor");
  $("exportBtn").onclick=exportExcel;
}
function switchView(v){
  view=v; ["tabMain","tabYear","tabVendor"].forEach(id=>$(id).classList.remove("active"));
  $("viewMain").style.display=v==="main"?"block":"none"; $("viewYear").style.display=v==="year"?"block":"none"; $("viewVendor").style.display=v==="vendor"?"block":"none";
  $(v==="main"?"tabMain":v==="year"?"tabYear":"tabVendor").classList.add("active");
  v==="main"?loadMain():v==="year"?loadYear():loadVendors();
}
function shift(d){
  let m=+$("m1").value+d; if(m<1)m=1; if(m>12)m=12; $("m1").value=m; if(!$("adv").checked) $("m2").value=m; loadMain();
}
async function loadRange(y,s,e){
  const map=new Map(); for(let m=s;m<=e;m++){
    try{const r=await fetch(fn(y,m),{cache:"no-store"}); if(!r.ok) continue;
      (await r.json()).forEach(x=>{
        const k=x["è—¥ä»£"]; const rec=map.get(k)||{è—¥ä»£:k,è—¥å“:x["è—¥å“"], ç”¨é‡:0, å» å•†:cjk2(x["è—¥å“"])};
        rec.ç”¨é‡+=Number(x["æœˆç”¨é‡"]||0); map.set(k,rec);
      });
    }catch{}
  } return [...map.values()];
}
async function loadMain(){
  const y=$("year").value, s=+$("m1").value, e=+$("m2").value;
  rows=await loadRange(y,Math.min(s,e),Math.max(s,e)); buildVendorOptions(rows); render();
}
function buildVendorOptions(list){
  const set=new Set(list.map(x=>x.å» å•†)); const sel=$("vendor"); const cur=sel.value||"__ALL__";
  sel.innerHTML=""; sel.appendChild(new Option("(å…¨éƒ¨)","__ALL__",true,false));
  [...set].sort().forEach(v=>sel.appendChild(new Option(v,v)));
  sel.value=set.has(cur)?cur:"__ALL__";
}
function isAutoNotice(x){
  const u=+x.ç”¨é‡||0, stock=st[x.è—¥ä»£]; return u>0 && stock!=null && stock>u*6 && !di[x.è—¥ä»£];
}
function isManualNotice(x){return !!ma[x.è—¥ä»£];}
function render(){
  if(view!=="main"){return;}
  const kw=$("q").value.trim(), ven=$("vendor").value;
  let list=rows.filter(x=>(ven==="__ALL__"||x.å» å•†===ven) && (!kw||x.è—¥ä»£.includes(kw)||x.è—¥å“.includes(kw)));
  const tb=$("tb"); tb.innerHTML=""; let cBuy=0,cOk=0,cNotice=0;
  list.forEach(x=>{
    const u=+x.ç”¨é‡||0, stock=st[x.è—¥ä»£]??null, auto=isAutoNotice(x), man=isManualNotice(x);
    if(auto||man) cNotice++; if(stock!=null && u>stock) cBuy++; else if(stock!=null) cOk++;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${x.è—¥ä»£}</td><td>${x.è—¥å“}</td><td>${u}</td><td>
      <div class="stock">
        <div class="top">
          <input type="number" inputmode="numeric" value="${stock??""}">
          ${tag(stock,u,auto,man)}
          <label style="display:inline-flex;gap:6px;align-items:center;font-weight:900">
            <input type="checkbox" ${man?"checked":""}>æ‰‹å‹•å…¬å‘Š
          </label>
        </div>
        <input class="note note-input" placeholder="å‚™è¨»" value="${no[x.è—¥ä»£]??""}">
      </div></td>`;
    const inputs=tr.querySelectorAll("input");
    const stockInp=inputs[0], manChk=inputs[1], noteInp=inputs[2];
    stockInp.oninput=()=>{st[x.è—¥ä»£]=stockInp.value===""?null:+stockInp.value; localStorage.setItem(K_ST,JSON.stringify(st)); render();};
    manChk.onchange=()=>{ if(manChk.checked) ma[x.è—¥ä»£]=true; else delete ma[x.è—¥ä»£];
      localStorage.setItem(K_MA,JSON.stringify(ma)); render();};
    noteInp.oninput=()=>{no[x.è—¥ä»£]=noteInp.value; localStorage.setItem(K_NO,JSON.stringify(no));};
    tb.appendChild(tr);
  });
  $("cAll").textContent=`å…± ${list.length}`; $("cBuy").textContent=`éœ€æ¡è³¼ ${cBuy}`; $("cOk").textContent=`æ­£å¸¸ ${cOk}`;
  $("cNotice").textContent=`å…¬å‘Š ${cNotice}`;
  if(cNotice){$("noticeBar").style.display="block";$("noticeBar").textContent=`ğŸ“£ å…¬å‘Š ${cNotice} ç­†ï¼ˆé»æˆ‘çœ‹æ˜ç´°ï¼‰`;}
  else $("noticeBar").style.display="none";
  lastExport=list;
}
function openNotice(){
  if(view!=="main") return;
  const y=$("year").value, s=+$("m1").value, e=+$("m2").value;
  $("noticeHint").textContent=`${$("adv").checked?"å¤šæœˆæ¨¡å¼":"å–®æœˆæ¨¡å¼"}ï¼šè‡ªå‹•åˆ¤æ–· = åº«å­˜ > ${(Math.min(s,e))===Math.max(s,e)?"å–®æœˆç”¨é‡":"å€é–“ç”¨é‡"} Ã— 6ï¼›æ‰‹å‹•å…¬å‘Šå¯ä¸¦è¡Œã€‚`;
  const list=rows.filter(x=>isAutoNotice(x)||isManualNotice(x));
  const tb=$("tbNotice"); tb.innerHTML="";
  list.forEach(x=>{
    const u=+x.ç”¨é‡||0, stock=st[x.è—¥ä»£]??null, auto=isAutoNotice(x), man=isManualNotice(x);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${x.è—¥ä»£}</td><td>${x.è—¥å“}</td><td>${u}</td><td>${stock??""}</td>
      <td>${man?"æ‰‹å‹•":"è‡ªå‹•"}</td>
      <td><button class="b3" data-k="${x.è—¥ä»£}" data-t="${man?"man":"auto"}">åˆªé™¤</button></td>`;
    tr.querySelector("button").onclick=(ev)=>{
      const k=ev.target.dataset.k, t=ev.target.dataset.t;
      if(t==="man"){delete ma[k]; localStorage.setItem(K_MA,JSON.stringify(ma));}
      else {di[k]=true; localStorage.setItem(K_DI,JSON.stringify(di));}
      openNotice(); render();
    };
    tb.appendChild(tr);
  });
  $("modal").style.display="flex";
}
function closeNotice(){$("modal").style.display="none";}
async function loadYear(){
  const y=$("year").value; const all=await loadRange(y,1,12);
  $("tbYear").innerHTML=""; all.sort((a,b)=>b.ç”¨é‡-a.ç”¨é‡).forEach(x=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${x.è—¥ä»£}</td><td>${x.è—¥å“}</td><td>${(+x.ç”¨é‡||0).toFixed(2).replace(/\.00$/,"")}</td>`;
    $("tbYear").appendChild(tr);
  });
  lastExport=all.map(x=>({è—¥ä»£:x.è—¥ä»£,è—¥å“:x.è—¥å“,å¹´åº¦ç¸½ç”¨é‡:x.ç”¨é‡,å» å•†:x.å» å•†}));
}
async function loadVendors(){
  const y=$("year").value; const all=await loadRange(y,1,12);
  const tb=$("tbVendor"); tb.innerHTML="";
  all.sort((a,b)=>a.å» å•†.localeCompare(b.å» å•†)).forEach(x=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${x.å» å•†}</td><td>${x.è—¥ä»£}</td><td>${x.è—¥å“}</td>`;
    tb.appendChild(tr);
  });
  lastExport=all.map(x=>({å» å•†:x.å» å•†,è—¥ä»£:x.è—¥ä»£,è—¥å“:x.è—¥å“}));
}
function exportExcel(){
  const data=(lastExport&&lastExport.length)?lastExport:[];
  if(!data.length){alert("ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™");return;}
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws, view==="main"?"æŸ¥è©¢":view==="year"?"å¹´åº¦ç¸½è¦½":"å» å•†é ");
  const y=$("year").value, s=$("m1").value, e=$("m2").value;
  XLSX.writeFile(wb, view==="main"?`æ¡è³¼_${y}_${s}${$("adv").checked?`-${e}`:""}.xlsx`:`${view}_${y}.xlsx`);
}
init();
})();
</script>
</body></html>
