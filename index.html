<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>

<!-- XLSX ä»ä¿ç•™ï¼ˆåŸæœ¬ä¸»æ¸…å–® / å¹´åº¦ç¸½è¦½æœƒç”¨åˆ°ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
html,body{
  max-width:100%;
  overflow-x:hidden;
  margin:0;
  background:#f3f4f6;
  color:#111827;
  font-size:16px
}
*{box-sizing:border-box;max-width:100%}

.app{
  width:min(1100px,100%);
  margin:12px auto;
  background:#fff;
  padding:14px;
  border-radius:16px;
  box-shadow:0 10px 22px rgba(0,0,0,.10)
}

h1{margin:0 0 6px;text-align:center}
.sub{color:#6b7280;text-align:center;font-size:13px;margin:0 0 10px}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  margin:8px 0
}

label{font-weight:900}

input,select,button{
  font-size:16px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid #d1d5db
}

button{
  border:none;
  background:#4f46e5;
  color:#fff;
  font-weight:900;
  cursor:pointer
}
button:disabled{opacity:.5;cursor:not-allowed}

.btn2{background:#111827}
.btn3{background:#e5e7eb;color:#111827}
.btn4{background:#374151}

.pill{
  padding:4px 12px;
  border-radius:999px;
  font-size:14px;
  font-weight:900
}
.p1{background:#dbeafe}
.p2{background:#fee2e2;color:#991b1b}
.p3{background:#dcfce7;color:#166534}
.p4{background:#ede9fe;color:#4c1d95}

.table-wrap{width:100%;overflow-x:auto}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px;vertical-align:top;word-break:break-word}
th{background:#e5e7eb}
tr:nth-child(even) td{background:#f3f4f6}

.tag{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:13px
}
.t0{background:#e5e7eb}
.t1{background:#dcfce7;color:#166534}
.t2{background:#fee2e2;color:#991b1b}
.t3{background:#ede9fe;color:#5b21b6}

.stock{display:flex;flex-direction:column;gap:6px}
.stockTop{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.note{
  width:100%;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px
}

/* ===== ä¸Šæ–¹å…¬å‘Šæ¢ ===== */
.announceBar{
  display:block;
  margin:8px 0;
  padding:10px 14px;
  border-radius:14px;
  background:#ede9fe;
  color:#4c1d95;
  font-weight:900;
  cursor:pointer;
  user-select:none
}
.announceBar:hover{background:#ddd6fe}

/* ===== Modal ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  padding:12px
}
.box{
  background:#fff;
  width:min(980px,100%);
  border-radius:16px;
  box-shadow:0 18px 40px rgba(0,0,0,.25);
  padding:12px
}
.boxHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px
}
.boxHead h3{margin:0}
.boxSub{color:#6b7280;font-size:13px;margin:6px 0 10px}
.box .table-wrap{
  max-height:70vh;
  overflow:auto;
  border-radius:12px
}
.small{font-size:13px;color:#6b7280}

/* â‘  æ‰‹æ©Ÿï¼šéš±è—å…¬å‘Šè¡¨é ­ï¼ˆä¸€å®šè¦æœ€å‰é¢ä¹‹ä¸€ï¼‰ */
@media (max-width:520px){
  .annTable thead,
  .annTable th{
    display:none !important;
  }
}

/* â‘¡ æ‰‹æ©Ÿï¼šç§»é™¤åºè™Ÿæ¬„ï¼Œè—¥ä»£è²¼é½Šå·¦é‚Š */
@media (max-width:520px){

  /* grid æ”¹æˆï¼šè—¥ä»£ï½œåº«å­˜ï½œå‚™è¨»ï½œåˆªé™¤ */
  .annTable tr{
    grid-template-columns: 1fr 56px 56px 34px !important;
  }

  /* éš±è—åºè™Ÿæ¬„ */
  .annTable td:nth-child(1){
    display:none !important;
  }

  /* è—¥ä»£æ¬„è²¼å·¦ */
  .annTable td:nth-child(2),
  .annTable td:nth-child(2) input{
    margin-left:0 !important;
    padding-left:6px !important;
  }
}

/* â‘¢ æ‰‹æ©Ÿï¼šè¡Œè·å†å£“ç¸®ï¼ˆæœ€å¾Œä¸€æ®µï¼Œå°ˆç®¡é«˜åº¦ï¼‰ */
@media (max-width:520px){

  .annTable tr{
    padding:2px 6px !important;
    gap:4px !important;
  }

  .annTable td{
    padding:0 !important;
    margin:0 !important;
  }

  .annTable input{
    height:20px !important;
    min-height:20px !important;
    padding:2px 4px !important;
    line-height:1 !important;
  }

  .annTable td:nth-child(5) button{
    height:20px !important;
    min-height:20px !important;
  }
}

</style>

</head>

<body>
<div class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="sub">æ¯æœˆä¸€æª” inventory_YYYY_MM.jsonï¼ˆå–®æœˆç‚ºä¸»ï¼Œæ”¯æ´é€²éšå¤šæœˆï¼‰</div>

  <div class="sub" id="loadInfo" style="font-weight:900;color:#374151"></div>

  <!-- ä¸Šæ–¹å…¬å‘Š -->
  <div id="announceBar" class="announceBar"></div>

  <!-- å¹´æœˆé¸æ“‡ -->
  <div class="row">
    <label>å¹´ä»½</label><select id="year"></select>
    <label>æœˆä»½</label>
    <button id="pm" class="btn4">â—€</button>
    <select id="m1"></select>
    <button id="nm" class="btn4">â–¶</button>

    <label style="margin-left:6px">
      <input id="adv" type="checkbox" style="transform:scale(1.1);margin-right:6px">å¤šæœˆé€²éš
    </label>
    <span id="advBox" style="display:none;align-items:center;gap:8px">
      <span class="small">åˆ°</span><select id="m2"></select>
    </span>

    <button id="reload" class="btn2">é‡æ–°è¼‰å…¥</button>
    <button id="reset" class="btn3">é‡ç½®</button>
  </div>

  <!-- å» å•† -->
  <div class="row">
    <label>å» å•†</label>
    <select id="vendorSel"></select>
    <button id="clearVendor" class="btn3">æ¸…é™¤å» å•†</button>
    <button id="vendorPage" class="btn4">å» å•†é </button>
  </div>

  <!-- æœå°‹ / åŠŸèƒ½ -->
  <div class="row">
    <label>æœå°‹</label>
    <input id="q" placeholder="è¼¸å…¥è—¥ä»£æˆ–è—¥å“åç¨±" style="flex:1;min-width:220px">
    <button id="search">æœå°‹</button>
    <button id="export" class="btn4">åŒ¯å‡º Excel</button>
    <button id="yearView" class="btn4">å¹´åº¦ç¸½è¦½</button>
    <button id="buyView" class="btn4">éœ€æ¡è³¼æ¸…å–®</button>
    <button id="admin" class="btn2">ç®¡ç†è€…</button>
  </div>

  <!-- çµ±è¨ˆ -->
  <div class="row">
    <span class="pill p1" id="cTotal"></span>
    <span class="pill p2" id="cBuy"></span>
    <span class="pill p3" id="cOk"></span>
    <span class="pill p4" id="cAnn"></span>
  </div>

  <!-- ä¸»è¡¨ -->
  <div class="table-wrap">
    <table class="mainTable">
      <thead>
        <tr>
          <th>è—¥ä»£</th>
          <th>è—¥å“</th>
          <th>ç”¨é‡</th>
          <th>åº«å­˜ / å…¬å‘Š</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>
<!-- =========================
     å…¬å‘Šæ˜ç´°ï¼ˆå«ï¼šæ–‡å­—å…¬å‘Š + è—¥ä»£å…¬å‘Šï¼›å³ä¸Šè§’åŒ¯å‡º CSVï¼‰
     ========================= -->
<div id="modal" class="modal"><div class="box">
  <div class="boxHead">
    <div>
      <h3>å…¬å‘Šæ˜ç´°</h3>
      <div class="boxSub" id="annRule"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="annExport" class="btn4">åŒ¯å‡ºå…¬å‘Š CSV</button>
      <button id="close" class="btn3">é—œé–‰</button>
    </div>
  </div>

  <div class="table-wrap">
    <table class="annTable">
      <thead>
        <tr>
          <th style="width:72px">åºè™Ÿ</th>
          <th>å…§å®¹ï¼ˆå¯è¼¸å…¥æ–‡å­—å…¬å‘Šï¼›æˆ–è—¥å“æ”¹å/æ–°å¢åˆ—é¡¯ç¤ºï¼šè—¥ä»£ï¼‹è—¥å“(10ç¢¼)ï¼‰</th>
          <th style="width:130px">åº«å­˜ï¼ˆå¯è¼¸å…¥ï¼‰</th>
          <th>å‚™è¨»ï¼ˆå¯è¼¸å…¥ï¼‰</th>
          <th style="width:150px">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="annBody"></tbody>
    </table>
  </div>
</div></div>

<!-- =========================
     éœ€æ¡è³¼æ¸…å–®
     ========================= -->
<div id="buyModal" class="modal"><div class="box">
  <div class="boxHead">
    <div>
      <h3>éœ€æ¡è³¼æ¸…å–®</h3>
      <div class="boxSub">æ¯ç¨®è—¥ä»£ä¸€è¡Œï¼ˆåº«å­˜ < ç”¨é‡ï¼‰</div>
    </div>
    <button id="buyClose" class="btn3">é—œé–‰</button>
  </div>
  <div class="table-wrap">
    <table class="annTable">
      <thead>
        <tr>
          <th>è—¥ä»£</th>
          <th>è—¥å“</th>
          <th>ç”¨é‡</th>
          <th>åº«å­˜</th>
          <th>å»ºè­°æ¡è³¼</th>
          <th>å‚™è¨»</th>
        </tr>
      </thead>
      <tbody id="buyBody"></tbody>
    </table>
  </div>
</div></div>

<!-- =========================
     å» å•†é 
     ========================= -->
<div id="vModal" class="modal"><div class="box">
  <div class="boxHead">
    <div>
      <h3 id="vTitle">å» å•†é </h3>
      <div class="boxSub">é»å» å•†â†’çœ‹è©²å» å•†æ‰€æœ‰è—¥ï¼ˆå» å•†ä»¥ã€Œå‰å…©å€‹ä¸­æ–‡ã€æ­¸é¡ï¼‰</div>
    </div>
    <button id="vClose" class="btn3">é—œé–‰</button>
  </div>

  <div class="row">
    <input id="vSearch" placeholder="æœå°‹å» å•†" style="flex:1;min-width:220px">
    <button id="vClear" class="btn3">æ¸…é™¤</button>
  </div>

  <div id="vList" class="row" style="gap:6px"></div>

  <hr style="border:none;border-top:1px solid #e5e7eb;margin:10px 0">

  <div class="row">
    <input id="vdSearch" placeholder="æœå°‹è—¥ä»£/è—¥å“" style="flex:1;min-width:220px">
    <button id="vdClear" class="btn3">æ¸…é™¤</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th></tr></thead>
      <tbody id="vdBody"></tbody>
    </table>
  </div>
</div></div>

<script>
/* =========================================================
   PART 3 æœƒæ¥åœ¨é€™è£¡ï¼šå®Œæ•´ JSï¼ˆå«å…¬å‘Š CSV åŒ¯å‡ºï¼‰
   ========================================================= */
</script>

<script>
(()=> {
  const $ = (id)=>document.getElementById(id);

  // localStorage keys
  const STOCK="drug_stock_v1",
        NOTE="drug_note_v1",
        NAME="drug_name_override_v1",
        MAN="manual_announce_v1",
        TEXT_ANN="text_announce_v1",
        ADMIN="admin_on_v1";

  // persisted state
  const stock   = JSON.parse(localStorage.getItem(STOCK)||"{}");
  const notes   = JSON.parse(localStorage.getItem(NOTE)||"{}");
  const nameMap = JSON.parse(localStorage.getItem(NAME)||"{}");
  const manual  = JSON.parse(localStorage.getItem(MAN)||"{}");
  const textAnnounce = JSON.parse(localStorage.getItem(TEXT_ANN)||"[]"); // [{id,text,time}]

  let adminOn = localStorage.getItem(ADMIN)==="1";
  let rows = [], viewRows = [], vendorMap = new Map();

  // âœ… ä¾ inventory_index.json æ±ºå®šå¯é¸å¹´æœˆ
  let avail = new Map();      // year -> Set(month)
  let availPairs = [];        // [{y,m}, ...] sorted

  const pad2 = (n)=>String(n).padStart(2,"0");
  const file = (y,m)=>`inventory_${y}_${pad2(m)}.json`;

  const normCode = (s)=>String(s||"").trim().toUpperCase();

  // âœ… æ‰‹å‹•å…¬å‘Šï¼šä¸å—æœˆä»½å½±éŸ¿ï¼ˆåªçœ‹ manualï¼‰
  const isManualAnn = (code)=>{
    const c = String(code||"");
    const n = normCode(c);
    return !!manual[c] || !!manual[n];
  };

  // âœ… å…¬å‘Šåªçœ‹æ‰‹å‹•å…¬å‘Š
  const isAnn = (r)=> isManualAnn(r.è—¥ä»£);

  const vendorKey = (s)=>{
    s=(s||"æœªæ¨™ç¤ºå» å•†").trim();
    const m=[...s.matchAll(/[\u4E00-\u9FFF]/g)].map(x=>x[0]);
    if(m.length>=2) return m[0]+m[1];
    if(m.length===1) return m[0];
    return (s.replace(/\s+/g," ").slice(0,8) || "å…¶ä»–");
  };

  const tagHTML=(st,u,ann)=>{
    if(ann) return `<span class="tag t3">å…¬å‘Š</span>`;
    if(st==null) return `<span class="tag t0">æœªè¼¸å…¥</span>`;
    if(u>0 && st<u) return `<span class="tag t2">éœ€æ¡è³¼</span>`;
    return `<span class="tag t1">æ­£å¸¸</span>`;
  };

  function updateTag(el, st, u, ann=false){
    if(!el) return;
    el.className="tag";
    if(ann){ el.classList.add("t3"); el.textContent="å…¬å‘Š"; return; }
    if(st==null || st===""){ el.classList.add("t0"); el.textContent="æœªè¼¸å…¥"; return; }
    st=Number(st); u=Number(u||0);
    if(u>0 && st<u){ el.classList.add("t2"); el.textContent="éœ€æ¡è³¼"; return; }
    el.classList.add("t1"); el.textContent="æ­£å¸¸";
  }

  // âœ… é¡¯ç¤ºã€Œå¯¦éš›è¼‰å…¥æœˆä»½ã€ï¼† Console debug
  function renderLoadInfo(loadedFiles, missingFiles){
    const el = $("loadInfo");
    if(!el) return;

    const ok = loadedFiles.length;
    const miss = missingFiles.length;

    const pretty = (fn)=>{
      const m = String(fn).match(/inventory_(\d{4})_(\d{2})\.json$/);
      if(!m) return fn;
      return `${m[1]}/${m[2]}`;
    };

    const rangeText = ok ? `ï½œ${pretty(loadedFiles[0])} â†’ ${pretty(loadedFiles[ok-1])}` : "";
    el.textContent = `âœ… å·²è¼‰å…¥ ${ok} å€‹æœˆè³‡æ–™${miss ? `ï¼ˆç¼º ${miss} å€‹æœˆæª”æ¡ˆï¼‰` : ""}${rangeText}`;

    console.log("[loadData] loadedFiles:", loadedFiles);
    if(missingFiles.length) console.warn("[loadData] missingFiles:", missingFiles);
  }

  // =========================
  // âœ… CSV åŒ¯å‡ºå·¥å…·ï¼ˆiPhone ç©©ï¼‰
  // =========================
  function csvEscape(v){
    if(v==null) return "";
    const s = String(v);
    if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  function toCSV(rows, headers){
    const headLine = headers.map(csvEscape).join(",");
    const lines = rows.map(r => headers.map(h => csvEscape(r[h])).join(","));
    return "\ufeff" + [headLine, ...lines].join("\r\n"); // BOM + CRLF
  }

function downloadTextFile(filename, text, mime="text/csv;charset=utf-8"){
  const blob = new Blob([text], { type: mime });
  const url = URL.createObjectURL(blob);

  // iOS Safariï¼šç”¨æ–°åˆ†é æ‰“é–‹
  if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    window.open(url, "_blank");
    setTimeout(()=>URL.revokeObjectURL(url), 8000);
    return;
  }

  // å…¶ä»–ç€è¦½å™¨ï¼šæ­£å¸¸ä¸‹è¼‰
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}


  // =========================
  // âœ… inventory_index.json
  // =========================
  function buildAvailPairs(){
    const pairs=[];
    [...avail.keys()].sort((a,b)=>a-b).forEach(y=>{
      const set=avail.get(y);
      const months=set ? [...set].sort((a,b)=>a-b) : [];
      months.forEach(m=>pairs.push({y:+y,m:+m}));
    });
    availPairs=pairs;
  }

  async function loadIndex(){
    avail = new Map();
    try{
      const r = await fetch("inventory_index.json", {cache:"no-store"});
      if(r.ok){
        const idx = await r.json();
        const arr = idx.months || idx["æœˆ"] || idx["months"] || [];
        arr.forEach(s=>{
          const m = String(s).trim().match(/^(\d{4})-(\d{2})$/);
          if(!m) return;
          const y = +m[1], mo = +m[2];
          if(!avail.has(y)) avail.set(y, new Set());
          avail.get(y).add(mo);
        });
      }
    }catch(e){
      // ignore
    }

    if(avail.size===0){
      const y=new Date().getFullYear();
      avail.set(y, new Set(Array.from({length:12},(_,i)=>i+1)));
    }
    buildAvailPairs();
  }

  function fillMonthsByYear(y){
    const set = avail.get(+y);
    const months = set ? [...set].sort((a,b)=>a-b) : Array.from({length:12},(_,i)=>i+1);

    $("m1").innerHTML="";
    $("m2").innerHTML="";
    months.forEach(mm=>{
      $("m1").appendChild(new Option(mm,mm));
      $("m2").appendChild(new Option(mm,mm));
    });

    const last = months[months.length-1] || (new Date().getMonth()+1);
    if(![...$("m1").options].some(o=>+o.value===+$("m1").value)) $("m1").value = last;
    if(![...$("m2").options].some(o=>+o.value===+$("m2").value)) $("m2").value = last;

    if(!$("adv").checked) $("m2").value = $("m1").value;
  }

  function setYM(y,m){
    if(![...$("year").options].some(o=>+o.value===+y)){
      const ys=[...$("year").options].map(o=>+o.value);
      y=ys.length?ys[ys.length-1]:y;
    }
    $("year").value = y;

    fillMonthsByYear(y);

    if([...$("m1").options].some(o=>+o.value===+m)) $("m1").value = m;
    else{
      const ms=[...$("m1").options].map(o=>+o.value);
      $("m1").value = ms.length?ms[ms.length-1]:m;
    }
    if(!$("adv").checked) $("m2").value = $("m1").value;
    else{
      if(![...$("m2").options].some(o=>+o.value===+$("m2").value)) $("m2").value = $("m1").value;
    }
  }

  function initSelects(){
    $("year").innerHTML="";
    const years = [...avail.keys()].sort((a,b)=>a-b);
    const fallbackYear = new Date().getFullYear();
    if(years.length===0) years.push(fallbackYear);

    years.forEach((yy,i)=>{
      const isLast = (i===years.length-1);
      $("year").appendChild(new Option(yy, yy, isLast, isLast));
    });

    fillMonthsByYear($("year").value);

    $("adv").checked=false;
    $("advBox").style.display="none";

    $("admin").textContent=adminOn?"ç®¡ç†è€…(é–‹)":"ç®¡ç†è€…";
  }

  async function loadData(){
    rows=[]; vendorMap=new Map();

    const y=+$("year").value;
    const adv=$("adv").checked;
    const a=+$("m1").value, b=adv?+$("m2").value:a;
    const s=Math.min(a,b), e=Math.max(a,b);

    const agg=new Map();

    const loadedFiles = [];
    const missingFiles = [];
    let loadedMonths = 0;

    for(let m=s;m<=e;m++){
      try{
        const fn = file(y,m);
        const r=await fetch(fn,{cache:"no-store"});
        if(!r.ok){
          missingFiles.push(fn);
          continue;
        }
        const list=await r.json();

        loadedMonths++;
        loadedFiles.push(fn);

        list.forEach(x=>{
          const code=x["è—¥ä»£"];
          const name=x["è—¥å“"];
          const ven=x["å» å•†"]||"æœªæ¨™ç¤ºå» å•†";
          if(!agg.has(code)) agg.set(code,{è—¥ä»£:code,è—¥å“:name,å» å•†:ven, sum:0});
          agg.get(code).sum += Number(x["æœˆç”¨é‡"]||0);
        });
      }catch(e){}
    }

    const monthCount = Math.max(1, loadedMonths);

    rows=[...agg.values()].map(x=>{
      const avg = monthCount>0 ? (x.sum/monthCount) : 0;
      const vKey = vendorKey(x.å» å•†);
      if(!vendorMap.has(vKey)) vendorMap.set(vKey,[]);
      const rec={
        è—¥ä»£:x.è—¥ä»£,
        è—¥å“:x.è—¥å“,
        å» å•†:x.å» å•†,
        å» å•†Key:vKey,
        ç”¨é‡:avg,
        å€é–“ç¸½ç”¨é‡:x.sum,
        æœˆæ•¸:monthCount
      };
      vendorMap.get(vKey).push(rec);
      return rec;
    });

    buildVendorDropdown();
    applyFilters();
    renderLoadInfo(loadedFiles, missingFiles);
  }

  function buildVendorDropdown(){
    const sel=$("vendorSel");
    const cur=sel.value || "(å…¨éƒ¨)";
    sel.innerHTML="";
    sel.appendChild(new Option("(å…¨éƒ¨)","(å…¨éƒ¨)"));
    [...vendorMap.keys()].sort((a,b)=>a.localeCompare(b,"zh-Hant")).forEach(k=>{
      sel.appendChild(new Option(`${k} (${vendorMap.get(k).length})`,k));
    });
    sel.value=[...sel.options].some(o=>o.value===cur)?cur:"(å…¨éƒ¨)";
  }

  function applyFilters(){
    const q=$("q").value.trim();
    const v=$("vendorSel").value;

    viewRows=rows.filter(r=>{
      if(v!=="(å…¨éƒ¨)" && r.å» å•†Key!==v) return false;
      if(q){
        const hit =
          String(r.è—¥ä»£||"").includes(q) ||
          String(r.è—¥å“||"").includes(q) ||
          String(nameMap[r.è—¥ä»£]||"").includes(q);
        if(!hit) return false;
      }
      return true;
    });

    viewRows.sort((a,b)=> String(a.è—¥ä»£||"").localeCompare(String(b.è—¥ä»£||""),"en",{numeric:true,sensitivity:"base"}));

    renderTable(viewRows);
    renderCounts(viewRows);
    renderAnnounceBar(viewRows);
  }

  function renderTable(list){
    const tb=$("body"); tb.innerHTML="";
    list.forEach(r=>{
      const u=Math.round((r.ç”¨é‡||0)*100)/100;
      const st=stock[r.è—¥ä»£];
      const ann=isAnn(r);
      const showName = nameMap[r.è—¥ä»£] ?? r.è—¥å“;

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.è—¥ä»£}</td>
        <td class="drugName">${showName}</td>
        <td>${u}</td>
        <td>
          <div class="stock">
            <div class="stockTop">
              <input type="number" inputmode="numeric" value="${st??""}" style="min-width:120px">
              ${tagHTML(st,u,ann)}
              <label style="display:flex;align-items:center;gap:6px;margin-left:6px">
                <input type="checkbox" ${isManualAnn(r.è—¥ä»£)?"checked":""} style="transform:scale(1.05)">æ‰‹å‹•å…¬å‘Š
              </label>
            </div>
            <input class="note" placeholder="å‚™è¨»" value="${notes[r.è—¥ä»£]??""}">
          </div>
        </td>`;

      const tagEl=tr.querySelector(".tag");
      const stockInp=tr.querySelector('input[type="number"]');
      const manChk=tr.querySelector('input[type="checkbox"]');
      const noteInp=tr.querySelector('input.note');

      stockInp.oninput=()=>{
        stockInp.value=stockInp.value.replace(/\D/g,"");
        const v=stockInp.value===""?null:+stockInp.value;
        updateTag(tagEl,v,u,isAnn(r));
      };
      stockInp.onblur=()=>{
        const v=stockInp.value===""?null:+stockInp.value;
        stock[r.è—¥ä»£]=v;
        localStorage.setItem(STOCK,JSON.stringify(stock));
        applyFilters();
      };

      manChk.onchange=()=>{
        const k=r.è—¥ä»£, nk=normCode(k);
        if(manChk.checked){ manual[k]=1; manual[nk]=1; }
        else { delete manual[k]; delete manual[nk]; }
        localStorage.setItem(MAN,JSON.stringify(manual));
        applyFilters();
      };

      noteInp.oninput=()=>{
        notes[r.è—¥ä»£]=noteInp.value;
        localStorage.setItem(NOTE,JSON.stringify(notes));
      };

      tb.appendChild(tr);
    });
  }

  function renderCounts(list){
    let buy=0, ok=0, ann=0;
    list.forEach(r=>{
      const st=stock[r.è—¥ä»£];
      const u=Number(r.ç”¨é‡||0);
      if(isAnn(r)) ann++;
      if(st!=null && u>st) buy++;
      else if(st!=null) ok++;
    });
    $("cTotal").textContent=`å…± ${list.length}`;
    $("cBuy").textContent=`éœ€æ¡è³¼ ${buy}`;
    $("cOk").textContent=`æ­£å¸¸ ${ok}`;
    $("cAnn").textContent=`å…¬å‘Š ${ann}`;
  }

  // âœ… ä¸Šæ–¹å…¬å‘Šï¼šé¡¯ç¤º è—¥ä»£å…¬å‘Šç­†æ•¸ + æ–‡å­—å…¬å‘Šå‰‡æ•¸
  function renderAnnounceBar(list){
    const drugCount = list.filter(isAnn).length;
    const textCount = textAnnounce.length;

    let msg = `ğŸ“¢ å…¬å‘Š `;
    msg += drugCount ? `è—¥å“ ${drugCount} ç­†` : "";
    msg += (drugCount && textCount) ? "ï¼‹" : "";
    msg += textCount ? `ä¸€èˆ¬ ${textCount} å‰‡` : "";
    if(!drugCount && !textCount) msg += "0";
    msg += "ï¼ˆé»æˆ‘çœ‹æ˜ç´° / æ–°å¢ï¼‰";

    $("announceBar").textContent = msg;
  }

  function deleteAnnounceByCode(code){
    const ncode = normCode(code);
    delete manual[code];
    delete manual[ncode];
    localStorage.setItem(MAN, JSON.stringify(manual));
    applyFilters();
  }

  // âœ… æ–‡å­—å…¬å‘Šï¼šæ–°å¢ / åˆªé™¤
  function addTextAnnounce(txt){
    const t = (txt||"").trim();
    if(!t) return false;
    textAnnounce.unshift({ id: Date.now(), text: t, time: new Date().toISOString() });
    localStorage.setItem(TEXT_ANN, JSON.stringify(textAnnounce));
    applyFilters();
    return true;
  }
  function deleteTextAnnounceByIndex(idx){
    if(idx<0 || idx>=textAnnounce.length) return;
    textAnnounce.splice(idx,1);
    localStorage.setItem(TEXT_ANN, JSON.stringify(textAnnounce));
    applyFilters();
  }

  // âœ… åŒ¯å‡ºã€Œå…¬å‘Š CSVã€ï¼šæ–‡å­—å…¬å‘Šå…¨éƒ¨ï¼›è—¥ä»£å…¬å‘ŠåªåŒ¯å‡ºç›®å‰ç•«é¢ï¼ˆviewRowsï¼‰å…¬å‘Š
  function exportAnnounceCSV(){
    const textRows = (textAnnounce || []).map((a,i)=>({
      é¡å‹: "æ–‡å­—å…¬å‘Š",
      åºè™Ÿ: i+1,
      å…§å®¹: a.text || "",
      æ™‚é–“: a.time || "",
      è—¥ä»£: "",
      è—¥å“: "",
      å» å•†: "",
      ç”¨é‡: "",
      åº«å­˜: "",
      å‚™è¨»: ""
    }));

    let idx = 1;
    const drugRows = (viewRows || [])
      .filter(r => isAnn(r))
      .map(r=>{
        const code = r.è—¥ä»£;
        const name = nameMap[code] ?? r.è—¥å“;
        const ven  = r.å» å•† || "";
        const use  = Math.round(Number(r.ç”¨é‡||0)*100)/100;
        const st   = stock[code];
        const note = notes[code] ?? "";
        return {
          é¡å‹: "è—¥ä»£å…¬å‘Š",
          åºè™Ÿ: idx++,
          å…§å®¹: "",
          æ™‚é–“: "",
          è—¥ä»£: code,
          è—¥å“: name,
          å» å•†: ven,
          ç”¨é‡: use,
          åº«å­˜: (st==null ? "" : Number(st)),
          å‚™è¨»: note
        };
      });

    const merged = [...textRows, ...drugRows];
    const headers = ["é¡å‹","åºè™Ÿ","å…§å®¹","æ™‚é–“","è—¥ä»£","è—¥å“","å» å•†","ç”¨é‡","åº«å­˜","å‚™è¨»"];
    const csv = toCSV(
      merged.length ? merged : [{é¡å‹:"(ç„¡)",åºè™Ÿ:"",å…§å®¹:"",æ™‚é–“:"",è—¥ä»£:"",è—¥å“:"",å» å•†:"",ç”¨é‡:"",åº«å­˜:"",å‚™è¨»:""}],
      headers
    );

    const y  = $("year").value;
    const m1 = $("m1").value;
    const m2 = $("adv").checked ? $("m2").value : m1;
    downloadTextFile(`å…¬å‘ŠåŒ¯å‡º_${y}_${pad2(m1)}-${pad2(m2)}.csv`, csv);
  }

  // âœ… å…¬å‘Šæ˜ç´°ï¼šæœ€ä¸Šæ–¹æ–°å¢æ–‡å­—å…¬å‘Šï¼‹ä¸‹æ–¹è—¥ä»£å…¬å‘Š
  function openAnnModal(){
    $("annRule").textContent = "å…¬å‘Šæ¸…å–®ï¼ˆä¸€èˆ¬æ–‡å­—å…¬å‘Š + æ‰‹å‹•å…¬å‘Šï¼›ä¸å—æœˆä»½åˆ‡æ›å½±éŸ¿ï¼‰";

    const tb = $("annBody");
    tb.innerHTML = "";

    const findRowByCode = (code)=>{
      const n = normCode(code);
      return rows.find(r => normCode(r.è—¥ä»£) === n) || null;
    };

    // (A) æ–‡å­—å…¬å‘Šæ–°å¢åˆ—
    const textAddTr = document.createElement("tr");
    textAddTr.innerHTML = `
      <td style="font-weight:900">ï¼‹</td>
      <td colspan="3">
        <input id="textAnnInput" placeholder="è¼¸å…¥å…¬å‘Šæ–‡å­—ï¼ˆèˆ‡è—¥ä»£ç„¡é—œï¼‰"
               style="width:100%;border-radius:10px;border:1px solid #d1d5db;padding:8px 12px">
      </td>
      <td style="white-space:nowrap">
        <button id="textAnnAddBtn" class="btn2" style="padding:8px 14px;border-radius:999px">â• æ–°å¢</button>
        <button id="textAnnClose" class="btn3" style="padding:8px 14px;border-radius:999px;margin-left:6px">é—œé–‰</button>
      </td>
    `;
    tb.appendChild(textAddTr);

    // (A2) æ–‡å­—å…¬å‘Šæ¸…å–®
    textAnnounce.forEach((a, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td colspan="3">${String(a.text||"")}</td>
        <td>
          <button class="btn3" data-text-del="${idx}" style="padding:8px 14px;border-radius:999px">ğŸ—‘ åˆªé™¤</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    // åˆ†éš”ç·š
    const sep = document.createElement("tr");
    sep.innerHTML = `
      <td colspan="5" style="background:#fff;padding:6px 8px">
        <div style="height:1px;background:#e5e7eb;margin:6px 0"></div>
        <div class="small" style="font-weight:900;color:#374151">ä»¥ä¸‹ç‚ºã€Œè—¥ä»£æ‰‹å‹•å…¬å‘Šã€</div>
      </td>
    `;
    tb.appendChild(sep);

    // (B) æ–°å¢è—¥ä»£å…¬å‘Šåˆ—
    const addTr = document.createElement("tr");
    addTr.innerHTML = `
      <td style="font-weight:900">ï¼‹</td>
      <td>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="annAddCode" placeholder="è¼¸å…¥è—¥ä»£ï¼ˆä¾‹å¦‚ A00523ï¼‰"
                 style="width:180px;max-width:100%;border-radius:10px;border:1px solid #d1d5db;padding:6px 10px">
          <span id="annAddInfo" class="small" style="font-weight:900;color:#111827">â€”</span>
        </div>
      </td>
      <td>
        <input id="annAddStock" type="number" inputmode="numeric" placeholder="åº«å­˜"
               style="width:100%;border-radius:10px;border:1px solid #d1d5db;padding:6px 10px">
      </td>
      <td>
        <input id="annAddNote" placeholder="å‚™è¨»"
               style="width:100%;border-radius:10px;border:1px solid #d1d5db;padding:6px 10px">
      </td>
      <td style="white-space:nowrap">
        <button id="annAddBtn" class="btn2" style="padding:8px 14px;border-radius:999px">â• åŠ å…¥</button>
      </td>
    `;
    tb.appendChild(addTr);

    // (B2) è—¥ä»£å…¬å‘Šæ¸…å–®ï¼šç”¨ç›®å‰ç•«é¢ viewRowsï¼ˆç¬¦åˆä½ ç¯©é¸çš„è¦–è§’ï¼‰
    const list = viewRows.filter(isAnn);
    list.forEach((r, idx)=>{
      const code=r.è—¥ä»£;
      const showName = nameMap[code] ?? r.è—¥å“;
      const st=stock[code];
      const note=notes[code] ?? "";

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${idx+1}</td>
        <td>
          <input data-name="${code}" value="${String(showName).replace(/"/g,'&quot;')}"
                 style="width:100%;border-radius:10px;border:1px solid #d1d5db;padding:6px 10px">
        </td>
        <td>
          <input data-stock="${code}" type="number" inputmode="numeric" value="${st ?? ""}"
                 style="width:100%;border-radius:10px;border:1px solid #d1d5db;padding:6px 10px">
        </td>
        <td>
          <input data-note="${code}" value="${String(note).replace(/"/g,'&quot;')}"
                 style="width:100%;border-radius:10px;border:1px solid #d1d5db;padding:6px 10px">
        </td>
        <td>
          <button class="btn2" data-del="${code}" style="padding:8px 14px;border-radius:999px">ğŸ—‘ åˆªé™¤å…¬å‘Š</button>
        </td>`;
      tb.appendChild(tr);
    });

    // ===== äº‹ä»¶ï¼šæ–‡å­—å…¬å‘Š =====
    const textInp = document.getElementById("textAnnInput");
    const textAddBtn = document.getElementById("textAnnAddBtn");
    const textCloseBtn = document.getElementById("textAnnClose");

    textAddBtn.onclick = (e)=>{
      e.preventDefault(); e.stopPropagation();
      if(addTextAnnounce(textInp.value)){
        textInp.value="";
        openAnnModal();
      }else{
        alert("è«‹å…ˆè¼¸å…¥å…¬å‘Šæ–‡å­—ã€‚");
        textInp.focus();
      }
    };
    textInp.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        textAddBtn.click();
      }
    });
    textCloseBtn.onclick = (e)=>{
      e.preventDefault(); e.stopPropagation();
      $("modal").style.display="none";
    };

    tb.querySelectorAll("[data-text-del]").forEach(btn=>{
      btn.onclick=()=>{
        const idx = +btn.getAttribute("data-text-del");
        if(confirm("åˆªé™¤é€™å‰‡æ–‡å­—å…¬å‘Šï¼Ÿ")){
          deleteTextAnnounceByIndex(idx);
          openAnnModal();
        }
      };
    });

    // ===== äº‹ä»¶ï¼šè—¥ä»£å…¬å‘Šæ–°å¢ =====
    const addCodeInp  = document.getElementById("annAddCode");
    const addInfo     = document.getElementById("annAddInfo");
    const addStockInp = document.getElementById("annAddStock");
    const addNoteInp  = document.getElementById("annAddNote");
    const addBtn      = document.getElementById("annAddBtn");

    const refreshPreview = ()=>{
      const raw = (addCodeInp.value||"").trim();
      if(!raw){
        addInfo.textContent = "â€”";
        addStockInp.value = "";
        addNoteInp.value = "";
        return;
      }

      const codeShow = normCode(raw);
      addInfo.textContent = codeShow;

      const r = findRowByCode(raw);
      if(r){
        const fullName = (nameMap[r.è—¥ä»£] ?? r.è—¥å“) || "";
        addInfo.textContent = `${codeShow} / ${String(fullName).slice(0,10)}`;

        const st = stock[r.è—¥ä»£];
        const nt = notes[r.è—¥ä»£] ?? "";
        addStockInp.value = (st==null ? "" : String(st));
        addNoteInp.value = nt;
      }
    };
    addCodeInp.addEventListener("input", refreshPreview);

    const doAddManual = ()=>{
      const raw = (addCodeInp.value || "").trim();
      if(!raw){
        alert("è«‹å…ˆè¼¸å…¥è—¥ä»£ã€‚");
        addCodeInp.focus();
        return;
      }

      const r = findRowByCode(raw);
      const codeKey = r ? r.è—¥ä»£ : raw;
      const ncode   = normCode(codeKey);

      manual[codeKey] = 1;
      manual[ncode] = 1;
      localStorage.setItem(MAN, JSON.stringify(manual));

      const stStr = String(addStockInp.value||"").replace(/\D/g,"");
      const stVal = stStr==="" ? null : +stStr;
      stock[codeKey] = stVal;
      stock[ncode] = stVal;
      localStorage.setItem(STOCK, JSON.stringify(stock));

      const ntVal = addNoteInp.value || "";
      notes[codeKey] = ntVal;
      notes[ncode] = ntVal;
      localStorage.setItem(NOTE, JSON.stringify(notes));

      applyFilters();

      addCodeInp.value = "";
      addStockInp.value = "";
      addNoteInp.value = "";
      addInfo.textContent = "â€”";
      openAnnModal();
    };

    addBtn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); doAddManual(); };
    addCodeInp.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); doAddManual(); }
    });

    // ===== äº‹ä»¶ï¼šè—¥ä»£å…¬å‘Šç·¨è¼¯ =====
    tb.querySelectorAll("input[data-name]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const code=inp.getAttribute("data-name");
        const v=(inp.value||"").trim();
        if(v) nameMap[code]=v; else delete nameMap[code];
        localStorage.setItem(NAME, JSON.stringify(nameMap));
        applyFilters();
      });
    });

    tb.querySelectorAll("input[data-stock]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        inp.value=inp.value.replace(/\D/g,"");
        const code=inp.getAttribute("data-stock");
        const v=inp.value===""?null:+inp.value;
        stock[code]=v;
        localStorage.setItem(STOCK, JSON.stringify(stock));
        applyFilters();
      });
    });

    tb.querySelectorAll("input[data-note]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const code=inp.getAttribute("data-note");
        notes[code]=inp.value;
        localStorage.setItem(NOTE, JSON.stringify(notes));
        applyFilters();
      });
    });

    tb.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick=()=>{
        const code=btn.getAttribute("data-del");
        if(confirm(`ç¢ºå®šè¦åˆªé™¤å…¬å‘Šï¼š${code} ï¼Ÿï¼ˆåªç§»é™¤å…¬å‘Šæ¨™è¨˜ï¼Œåº«å­˜/å‚™è¨»ä¿ç•™ï¼‰`)){
          deleteAnnounceByCode(code);
          openAnnModal();
        }
      };
    });

    $("modal").style.display="flex";
    setTimeout(()=> textInp?.focus(), 0);
  }

  function closeModal(id){ $(id).style.display="none"; }

  // âœ… éœ€æ¡è³¼æ¸…å–®
  function openBuyModal(){
    const tb=$("buyBody"); tb.innerHTML="";

    const list = viewRows
      .map(r=>{
        const u = Number(r.ç”¨é‡||0);
        const st = stock[r.è—¥ä»£];
        const showName = nameMap[r.è—¥ä»£] ?? r.è—¥å“;
        return {r,u,st,showName};
      })
      .filter(x => x.st!=null && x.u>0 && Number(x.st) < x.u);

    list.sort((a,b)=> (b.u-Number(b.st)) - (a.u-Number(a.st)));

    list.forEach(x=>{
      const code=x.r.è—¥ä»£;
      const u=Math.round(x.u*100)/100;
      const st=Number(x.st);
      const gap = Math.max(0, x.u - st);
      const suggest = Math.ceil(gap);
      const note = notes[code] ?? "";

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${code}</td>
        <td>${x.showName}</td>
        <td>${u}</td>
        <td>${st}</td>
        <td>${suggest}</td>
        <td>${note}</td>
      `;
      tb.appendChild(tr);
    });

    $("buyModal").style.display="flex";
  }

  // âœ… å» å•†é 
  let curVendorKey="";

  function renderVendorList(){
    const kw = ($("vSearch").value||"").trim();
    const wrap = $("vList");
    wrap.innerHTML="";

    const keys = [...vendorMap.keys()]
      .filter(k=> !kw || k.includes(kw))
      .sort((a,b)=>a.localeCompare(b,"zh-Hant"));

    keys.forEach(k=>{
      const btn=document.createElement("button");
      btn.className="btn4";
      btn.textContent=`${k} (${vendorMap.get(k).length})`;
      btn.style.padding="8px 14px";
      btn.onclick=()=>{
        curVendorKey=k;
        $("vTitle").textContent=`å» å•†é ï¼š${k}`;
        renderVendorDrugs();
      };
      wrap.appendChild(btn);
    });

    if(curVendorKey && !vendorMap.has(curVendorKey)) curVendorKey="";
    if(!curVendorKey && keys.length){ curVendorKey = keys[0]; renderVendorDrugs(); }
  }

  function renderVendorDrugs(){
    const list = vendorMap.get(curVendorKey) || [];
    const kw = ($("vdSearch").value||"").trim();
    const tb = $("vdBody");
    tb.innerHTML="";

    const show = list
      .filter(r=>{
        if(!kw) return true;
        const nm = nameMap[r.è—¥ä»£] ?? r.è—¥å“;
        return String(r.è—¥ä»£||"").includes(kw) || String(nm||"").includes(kw);
      })
      .sort((a,b)=> String(a.è—¥ä»£||"").localeCompare(String(b.è—¥ä»£||""),"en",{numeric:true,sensitivity:"base"}));

    show.forEach(r=>{
      const u=Math.round(Number(r.ç”¨é‡||0)*100)/100;
      const st = stock[r.è—¥ä»£];
      const nm = nameMap[r.è—¥ä»£] ?? r.è—¥å“;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.è—¥ä»£}</td>
        <td>${nm}</td>
        <td>${u}</td>
        <td>${st==null?"":st}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function openVendorModal(){
    $("vModal").style.display="flex";
    renderVendorList();
  }

  // âœ… åŒ¯å‡º Excelï¼ˆç¯©é¸çµæœï¼‰
  function exportExcel(){
    const data = viewRows.map(r=>{
      const code = r.è—¥ä»£;
      const nm = nameMap[code] ?? r.è—¥å“;
      const u = Math.round(Number(r.ç”¨é‡||0)*100)/100;
      const st = stock[code];
      const annFlag = isAnn(r);
      const tag = annFlag ? "å…¬å‘Š" : (st==null ? "æœªè¼¸å…¥" : (u>0 && Number(st)<u ? "éœ€æ¡è³¼" : "æ­£å¸¸"));
      return {
        è—¥ä»£: code,
        è—¥å“: nm,
        å» å•†: r.å» å•†,
        ç”¨é‡: u,
        åº«å­˜: st==null ? "" : Number(st),
        ç‹€æ…‹: tag,
        å‚™è¨»: notes[code] ?? ""
      };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "æ¸…å–®");

    const y=$("year").value;
    const m1=$("m1").value;
    const m2=$("adv").checked? $("m2").value : m1;
    XLSX.writeFile(wb, `è—¥å“æ¡è³¼_${y}_${pad2(m1)}-${pad2(m2)}.xlsx`);
  }

  // âœ… å¹´åº¦ç¸½è¦½ï¼ˆåŒ¯å‡º Excelï¼‰
  async function exportYearOverview(){
    const y=+$("year").value;
    const map = new Map();

    for(let m=1;m<=12;m++){
      try{
        const r=await fetch(file(y,m),{cache:"no-store"});
        if(!r.ok) continue;
        const list=await r.json();
        list.forEach(x=>{
          const code=x["è—¥ä»£"];
          const name=x["è—¥å“"];
          const ven=x["å» å•†"]||"æœªæ¨™ç¤ºå» å•†";
          const use=Number(x["æœˆç”¨é‡"]||0);

          if(!map.has(code)){
            map.set(code,{è—¥ä»£:code, è—¥å“:name, å» å•†:ven, months:Array(12).fill(0)});
          }
          map.get(code).months[m-1]=use;
        });
      }catch(e){}
    }

    const outRows = [...map.values()].map(o=>{
      const nm = nameMap[o.è—¥ä»£] ?? o.è—¥å“;
      const total = o.months.reduce((a,b)=>a+b,0);
      const avg = total/12;
      const out = {
        è—¥ä»£:o.è—¥ä»£,
        è—¥å“:nm,
        å» å•†:o.å» å•†,
        å¹´ç¸½ç”¨é‡: total,
        æœˆå¹³å‡: Math.round(avg*100)/100
      };
      o.months.forEach((v,i)=> out[`${i+1}æœˆ`] = v);
      return out;
    });

    outRows.sort((a,b)=> String(a.è—¥ä»£||"").localeCompare(String(b.è—¥ä»£||""),"en",{numeric:true,sensitivity:"base"}));

    const ws = XLSX.utils.json_to_sheet(outRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å¹´åº¦ç¸½è¦½");
    XLSX.writeFile(wb, `å¹´åº¦ç¸½è¦½_${y}.xlsx`);
  }

  function toggleAdmin(){
    adminOn = !adminOn;
    localStorage.setItem(ADMIN, adminOn ? "1" : "0");
    $("admin").textContent=adminOn?"ç®¡ç†è€…(é–‹)":"ç®¡ç†è€…";
  }

  function resetUI(){
    $("q").value="";
    $("vendorSel").value="(å…¨éƒ¨)";
    $("adv").checked=false;
    $("advBox").style.display="none";
    $("m2").value=$("m1").value;
    applyFilters();
  }

 // âœ… ä¾ index é€²è¡Œã€Œä¸Šä¸€æœˆ/ä¸‹ä¸€æœˆã€åˆ‡æ›ï¼ˆè·¨å¹´ä¹Ÿå¯ï¼‰
  function shiftMonth(delta){
    const y=+$("year").value;
    const m=+$("m1").value;

    let idx = availPairs.findIndex(p=>p.y===y && p.m===m);

    if(idx<0){
      const sameYear = availPairs.filter(p=>p.y===y);
      if(sameYear.length){
        const last = sameYear[sameYear.length-1];
        setYM(last.y,last.m);
        loadData();
        return;
      }
      if(availPairs.length){
        const last = availPairs[availPairs.length-1];
        setYM(last.y,last.m);
        loadData();
        return;
      }
      let mm = m + delta;
      if(mm<1) mm=12;
      if(mm>12) mm=1;
      $("m1").value=mm;
      if(!$("adv").checked) $("m2").value=mm;
      loadData();
      return;
    }

    let nidx = idx + delta;
    if(nidx<0) nidx = availPairs.length-1;
    if(nidx>=availPairs.length) nidx = 0;

    const next = availPairs[nidx];
    setYM(next.y, next.m);
    loadData();
  }

  function bindEvents(){
    $("adv").addEventListener("change", ()=>{
      $("advBox").style.display = $("adv").checked ? "inline-flex" : "none";
      if(!$("adv").checked) $("m2").value = $("m1").value;
      loadData();
    });

    $("year").addEventListener("change", ()=>{
      fillMonthsByYear($("year").value);
      loadData();
    });

    $("m1").addEventListener("change", ()=>{
      if(!$("adv").checked) $("m2").value = $("m1").value;
      loadData();
    });

    $("m2").addEventListener("change", loadData);

    $("pm").onclick=()=>shiftMonth(-1);
    $("nm").onclick=()=>shiftMonth(+1);

    $("reload").onclick=async ()=>{
      await loadIndex();
      initSelects();
      loadData();
    };

    $("reset").onclick=resetUI;

    $("vendorSel").addEventListener("change", applyFilters);
    $("clearVendor").onclick=()=>{
      $("vendorSel").value="(å…¨éƒ¨)";
      applyFilters();
    };

    $("search").onclick=applyFilters;
    $("q").addEventListener("keydown",(e)=>{
      if(e.key==="Enter") applyFilters();
    });

    $("export").onclick=exportExcel;
    $("yearView").onclick=exportYearOverview;
    $("buyView").onclick=openBuyModal;

    $("admin").onclick = (e)=>{
      e.preventDefault(); e.stopPropagation();
      toggleAdmin();
    };

    $("announceBar").onclick = (e)=>{
      e.preventDefault(); e.stopPropagation();
      openAnnModal();
    };

    $("close").onclick=()=>closeModal("modal");
    $("buyClose").onclick=()=>closeModal("buyModal");
    $("vClose").onclick=()=>closeModal("vModal");

    $("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal("modal"); });
    $("buyModal").addEventListener("click",(e)=>{ if(e.target.id==="buyModal") closeModal("buyModal"); });
    $("vModal").addEventListener("click",(e)=>{ if(e.target.id==="vModal") closeModal("vModal"); });

    $("vendorPage").onclick=(e)=>{ e.preventDefault(); e.stopPropagation(); openVendorModal(); };
    $("vSearch").addEventListener("input", renderVendorList);
    $("vClear").onclick=()=>{ $("vSearch").value=""; renderVendorList(); };

    $("vdSearch").addEventListener("input", renderVendorDrugs);
    $("vdClear").onclick=()=>{ $("vdSearch").value=""; renderVendorDrugs(); };
  }

  // âœ… å•Ÿå‹•ï¼šå…ˆè®€ index â†’ å†åˆå§‹åŒ– â†’ å†è¼‰å…¥è³‡æ–™
  (async ()=>{
    await loadIndex();
    initSelects();
    bindEvents();
    loadData();
  })();
})();
</script>
</body>
</html>
