<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html, body { margin:0; padding:0; width:100%; overflow-x:hidden; }
body { background:#eef1f7; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
body.lock { height:100vh; overflow:hidden; }

.app{
  max-width:1100px;
  margin:0 auto;
  background:#fff;
  padding:16px;
}

.row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; align-items:center; }
button{ padding:8px 16px; border-radius:20px; border:0; font-weight:800; }
button.dark{ background:#111827; color:#fff; }
button.ghost{ background:#e5e7eb; color:#111827; }

input,select{ padding:8px 14px; border-radius:20px; border:1px solid #ccc; }

.pill{ padding:6px 12px; border-radius:999px; font-size:13px; font-weight:900; }
.pill.buy{ background:#fee2e2; color:#991b1b; }
.pill.ok{ background:#dcfce7; color:#166534; }
.pill.na{ background:#e5e7eb; color:#111827; }

.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
table{ width:100%; border-collapse:collapse; }
th,td{ padding:10px 8px; font-size:14px; vertical-align:middle; }
tr:nth-child(even){ background:#f3f4f6; }

input.stock{ width:78px; font-size:16px; text-align:center; }

.tag{ display:inline-block; padding:4px 10px; border-radius:999px; font-weight:900; font-size:12px; }
.tag-buy{ background:#fee2e2; color:#991b1b; }
.tag-ok{ background:#dcfce7; color:#166534; }
.tag-na{ background:#e5e7eb; color:#111827; }

/* ===== éœ€æ¡è³¼é ï¼ˆçœŸåˆ‡é ï¼‰ ===== */
.buy-page{
  display:none;
  min-height:100vh;
  background:#0b1220;
  color:#fff;
  padding:16px;
}
.buy-title{ font-size:22px; font-weight:900; margin:6px 0 10px; }
.buy-sub{ color:#cbd5e1; font-size:13px; margin-bottom:12px; }
.buy-card{
  background:#111827;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
  border:1px solid rgba(255,255,255,.08);
}

/* ===== æ‰‹æ©Ÿå¡ç‰‡ ===== */
@media(max-width:600px){
  table thead{ display:none; }
  tr{
    display:block;
    background:#fff;
    margin-bottom:10px;
    border-radius:12px;
    padding:12px;
    overflow:hidden;
  }
  td{ display:block; padding:6px 0; }
}
</style>
</head>

<body>

<!-- ===== ä¸»ç•«é¢ ===== -->
<div id="mainApp" class="app">
  <h1 style="margin:0 0 10px;">è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>

  <div class="row">
    <label style="display:flex; gap:8px; align-items:center; font-weight:900;">
      <input type="checkbox" id="needBuyOnly">
      åªé¡¯ç¤ºéœ€æ¡è³¼ï¼ˆSafari å¯è·³ï¼‰
    </label>
    <button class="dark" id="openBuyBtn">éœ€æ¡è³¼æ¸…å–®</button>
  </div>

  <div class="row">
    <span class="pill buy" id="buyCount">éœ€æ¡è³¼ 0</span>
    <span class="pill ok" id="okCount">è¶³å¤  0</span>
    <span class="pill na" id="naCount">æœªè¼¸å…¥ 0</span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>è—¥ä»£</th><th>è—¥å“</th><th>æœˆç”¨é‡</th><th>åº«å­˜</th><th>ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody id="drugBody"></tbody>
    </table>
  </div>
</div>

<!-- ===== éœ€æ¡è³¼é ï¼ˆçœŸåˆ‡é ï¼‰ ===== -->
<div id="buyPage" class="buy-page">
  <div class="row">
    <button class="ghost" id="backBtn">â† è¿”å›ä¸»ç•«é¢</button>
    <button class="dark" id="csvBtn">å­˜ CSV</button>
    <button class="dark" id="jsonBtn">å­˜ JSON</button>
  </div>
  <div class="buy-title">ğŸ§¾ éœ€æ¡è³¼æ¸…å–®</div>
  <div class="buy-sub" id="buyMeta"></div>
  <div id="buyList"></div>
</div>

<script>
document.addEventListener("touchstart", ()=>{}, {passive:true});

let data = [];               // çœŸå¯¦è³‡æ–™
const STOCK_KEY = "drug_stock_v2";

const $ = id => document.getElementById(id);

function loadStockMap(){
  try { return JSON.parse(localStorage.getItem(STOCK_KEY) || "{}"); }
  catch { return {}; }
}
function saveStockMap(map){
  localStorage.setItem(STOCK_KEY, JSON.stringify(map));
}

/* âœ… ç‹€æ…‹åˆ¤æ–·ï¼ˆä¿®æ­£é‡é»ï¼‰
   - åº«å­˜ = null/ç©ºç™½ â†’ æœªè¼¸å…¥
   - æœ‰åº«å­˜ä¸”æœˆç”¨é‡>åº«å­˜ â†’ éœ€æ¡è³¼
   - æœ‰åº«å­˜ä¸”æœˆç”¨é‡<=åº«å­˜ â†’ è¶³å¤ 
*/
function computeStatus(x){
  const u = Number(x.æœˆç”¨é‡) || 0;
  const s = (x.åº«å­˜==="" || x.åº«å­˜===undefined) ? null : x.åº«å­˜;
  if (s === null) return "æœªè¼¸å…¥";
  const stock = Number(s);
  if (!Number.isFinite(stock)) return "æœªè¼¸å…¥";
  return (u > stock) ? "éœ€æ¡è³¼" : "è¶³å¤ ";
}

function tagHTML(status){
  if(status==="éœ€æ¡è³¼") return `<span class="tag tag-buy">éœ€æ¡è³¼</span>`;
  if(status==="è¶³å¤ ")   return `<span class="tag tag-ok">è¶³å¤ </span>`;
  return `<span class="tag tag-na">æœªè¼¸å…¥</span>`;
}

function renderMain(){
  $("drugBody").innerHTML = "";

  let buy=0, ok=0, na=0;
  const needOnly = $("needBuyOnly").checked;

  data.forEach(x=>{
    const status = computeStatus(x);
    x._status = status;

    if (status==="éœ€æ¡è³¼") buy++;
    else if (status==="è¶³å¤ ") ok++;
    else na++;

    if (needOnly && status!=="éœ€æ¡è³¼") return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${x.è—¥ä»£ ?? ""}</b></td>
      <td>${x.è—¥å“ ?? ""}</td>
      <td>${x.æœˆç”¨é‡ ?? ""}</td>
      <td><input class="stock" type="number" inputmode="numeric" value="${x.åº«å­˜ ?? ""}" placeholder=""></td>
      <td>${tagHTML(status)}</td>
    `;

    const inp = tr.querySelector("input");
    inp.addEventListener("input", (e)=>{
      const v = e.target.value;
      x.åº«å­˜ = (v==="") ? null : +v;

      // å­˜æª”åˆ° localStorage
      const map = loadStockMap();
      map[String(x.è—¥ä»£)] = x.åº«å­˜;
      saveStockMap(map);

      renderMain();
      if (isBuyPageOpen()) openBuySafari(); // éœ€æ¡è³¼é é–‹è‘—å°±åŒæ­¥åˆ·æ–°
    });

    $("drugBody").appendChild(tr);
  });

  $("buyCount").textContent = `éœ€æ¡è³¼ ${buy}`;
  $("okCount").textContent  = `è¶³å¤  ${ok}`;
  $("naCount").textContent  = `æœªè¼¸å…¥ ${na}`;
}

/* ===== éœ€æ¡è³¼é å…§å®¹ ===== */
function getNeedList(){
  return data
    .filter(x => computeStatus(x) === "éœ€æ¡è³¼")
    .map(x=>{
      const u = Number(x.æœˆç”¨é‡)||0;
      const s = Number(x.åº«å­˜)||0;
      return {
        è—¥ä»£: x.è—¥ä»£,
        è—¥å“: x.è—¥å“,
        æœˆç”¨é‡: u,
        åº«å­˜: s,
        å»ºè­°æ¡è³¼é‡: Math.max(0, u - s)
      };
    })
    .sort((a,b)=> b.å»ºè­°æ¡è³¼é‡ - a.å»ºè­°æ¡è³¼é‡);
}

function renderBuy(){
  const list = getNeedList();
  $("buyList").innerHTML = "";

  $("buyMeta").textContent = `å…± ${list.length} ç­†ï¼ˆä¾å»ºè­°æ¡è³¼é‡æ’åºï¼‰`;

  if(list.length===0){
    $("buyList").innerHTML = `
      <div class="buy-card">
        <div style="font-weight:900; font-size:16px">ç›®å‰æ²’æœ‰éœ€æ¡è³¼é …ç›®</div>
        <div style="color:#94a3b8; margin-top:6px">æç¤ºï¼šåº«å­˜ç©ºç™½æœƒè¢«è¦–ç‚ºã€Œæœªè¼¸å…¥ã€ï¼Œä¸æœƒç®—è¶³å¤ ä¹Ÿä¸æœƒç®—éœ€æ¡è³¼ã€‚</div>
      </div>`;
    return;
  }

  list.forEach(x=>{
    const div=document.createElement("div");
    div.className="buy-card";
    div.innerHTML = `
      <div style="font-weight:900; margin-bottom:6px;"><b>${x.è—¥ä»£}</b>ã€€${x.è—¥å“}</div>
      <div style="color:#cbd5e1;">æœˆç”¨é‡ï¼š${x.æœˆç”¨é‡}ã€€ï½œã€€åº«å­˜ï¼š${x.åº«å­˜}</div>
      <div style="margin-top:6px; font-weight:900;">å»ºè­°æ¡è³¼ï¼š${x.å»ºè­°æ¡è³¼é‡}</div>
    `;
    $("buyList").appendChild(div);
  });
}

/* ===== Safari çœŸåˆ‡é ï¼ˆå¼·åˆ¶é‡ç¹ªï¼‰ ===== */
function isBuyPageOpen(){ return $("buyPage").style.display==="block"; }

function openBuySafari(){
  renderBuy();

  $("mainApp").style.display = "none";
  $("buyPage").style.display = "block";

  // ğŸ”¥ iOS Safari å¼·åˆ¶é‡ç¹ªï¼ˆé—œéµï¼‰
  $("buyPage").style.webkitTransform = "translateZ(0)";
  $("buyPage").offsetHeight; // force reflow
  $("buyPage").style.webkitTransform = "";

  document.body.classList.add("lock");
  window.scrollTo(0,0);
}
function closeBuySafari(){
  $("buyPage").style.display = "none";
  $("mainApp").style.display = "block";
  document.body.classList.remove("lock");
  window.scrollTo(0,0);
}

/* ===== ä¸‹è¼‰ ===== */
function download(name, mime, content){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===== Safari checkboxï¼šchange + touchend é›™ä¿éšª ===== */
function onNeedBuyToggle(){
  renderMain();
  if ($("needBuyOnly").checked) openBuySafari();
  else closeBuySafari();
}
$("needBuyOnly").addEventListener("change", onNeedBuyToggle);
$("needBuyOnly").addEventListener("touchend", ()=>setTimeout(onNeedBuyToggle, 0));

/* ===== æŒ‰éˆ• ===== */
$("openBuyBtn").addEventListener("click", ()=>{
  $("needBuyOnly").checked = true; // åŒæ­¥ç‹€æ…‹
  openBuySafari();
});
$("backBtn").addEventListener("click", ()=>{
  $("needBuyOnly").checked = false;
  closeBuySafari();
  renderMain();
});

$("csvBtn").addEventListener("click", ()=>{
  const list = getNeedList();
  const header = ["è—¥ä»£","è—¥å“","æœˆç”¨é‡","åº«å­˜","å»ºè­°æ¡è³¼é‡"];
  const esc = v => {
    const s = (v==null) ? "" : String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const rows = [header.join(",")].concat(list.map(x=>header.map(k=>esc(x[k])).join(",")));
  download(`éœ€æ¡è³¼æ¸…å–®.csv`, "text/csv;charset=utf-8", rows.join("\n"));
});

$("jsonBtn").addEventListener("click", ()=>{
  const list = getNeedList();
  download(`éœ€æ¡è³¼æ¸…å–®.json`, "application/json;charset=utf-8", JSON.stringify(list,null,2));
});

/* ===== è¼‰å…¥è³‡æ–™ï¼šinventory.jsonï¼ˆå¤±æ•—å°±ç”¨ç¤ºç¯„è³‡æ–™ï¼‰ ===== */
async function boot(){
  let base = [
    {è—¥ä»£:"A001",è—¥å“:"AMOXICILLIN",æœˆç”¨é‡:100},
    {è—¥ä»£:"B002",è—¥å“:"PARACETAMOL",æœˆç”¨é‡:80},
  ];

  try{
    const r = await fetch("inventory.json", {cache:"no-store"});
    if(r.ok){
      base = await r.json();
    }
  }catch(e){}

  // é‚„åŸåº«å­˜
  const map = loadStockMap();
  data = base.map(x=>({
    ...x,
    åº«å­˜: (map[String(x.è—¥ä»£)]===undefined) ? null : map[String(x.è—¥ä»£)]
  }));

  renderMain();
}
boot();
</script>
</body>
</html>
