<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è—¥å“ç›¤é»ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- è®€ Excel ç”¨çš„ SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #f3f4f6;
    }
    header {
      display: flex;
      align-items: center;
      padding: 8px 20px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }
    header img {
      width: 32px;
      height: 32px;
      margin-right: 8px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    .container {
      padding: 16px 20px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .btn {
      border: none;
      border-radius: 4px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      color: #fff;
      background: #1d4ed8;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-secondary {
      background: #6b7280;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .info {
      font-size: 13px;
      color: #6b7280;
    }
    .error {
      font-size: 13px;
      color: #b91c1c;
      margin-top: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #ffffff;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }
    .stock-input {
      width: 100%;
      padding: 4px 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .status-ok {
      color: #15803d;
      font-weight: 600;
    }
    .status-warn {
      color: #b45309;
      font-weight: 600;
    }
    .status-bad {
      color: #b91c1c;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <!-- ä½ å¯ä»¥æ”¹æˆè‡ªå·±çš„åœ–ç‰‡ -->
    <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="factory" />
    <h1>è—¥å“ç›¤é»ç³»çµ±</h1>
  </header>

  <div class="container">
    <div class="toolbar">
      <!-- éš±è—çš„æª”æ¡ˆ inputï¼Œç”¨æŒ‰éˆ•è§¸ç™¼ -->
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" />
      <button class="btn" id="uploadBtn">ğŸ“‚ ä¸Šå‚³ Excel</button>

      <button class="btn btn-secondary" id="downloadBtn" disabled>ğŸ“¨ ä¸‹è¼‰çµæœ</button>

      <div class="info" id="fileInfo">è«‹å…ˆä¸Šå‚³å«æœ‰ã€Œè—¥å“ã€ã€ã€Œç´¯è¨ˆæ•¸é‡/ç´¯è¨ˆç”¨é‡ã€æ¬„ä½çš„ Excelã€‚</div>
    </div>
    <div id="errorBox" class="error"></div>

    <table>
      <thead>
        <tr>
          <th style="width: 40%;">è—¥å“åç¨±</th>
          <th style="width: 20%;">ç´¯è¨ˆç”¨é‡</th>
          <th style="width: 20%;">åº«å­˜</th>
          <th style="width: 20%;">ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody id="drugBody">
        <tr><td colspan="4">å°šæœªè¼‰å…¥è³‡æ–™</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const fileInput = document.getElementById("fileInput");
    const fileInfo = document.getElementById("fileInfo");
    const errorBox = document.getElementById("errorBox");
    const drugBody = document.getElementById("drugBody");

    // å­˜ç›®å‰è¡¨æ ¼çš„è³‡æ–™
    let drugRows = [];

    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", handleFile);
    downloadBtn.addEventListener("click", downloadCSV);

    function handleFile(e) {
      const file = e.target.files[0];
      errorBox.textContent = "";
      if (!file) {
        fileInfo.textContent = "æœªé¸æ“‡æª”æ¡ˆ";
        return;
      }
      fileInfo.textContent = `å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}`;
      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          const sheetName = workbook.Sheets["Sheet1"]
            ? "Sheet1"
            : workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          let rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

          if (!rows.length) {
            throw new Error("å·¥ä½œè¡¨ç‚ºç©ºæˆ–æ¬„ä½ç„¡æ³•è¾¨è­˜");
          }
          processData(rows);
        } catch (err) {
          console.error(err);
          errorBox.textContent = "è§£æ Excel ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processData(rows) {
      drugRows = [];

      rows.forEach((row) => {
        // å…ˆæŠŠæ¬„ä½åç¨± trim
        const cleaned = {};
        for (const k in row) {
          cleaned[k.trim()] = row[k];
        }

        // å–è—¥å“åç¨±æ¬„ä½ï¼ˆå‡è¨­å«ã€Œè—¥å“ã€æˆ–ã€Œè—¥å“åç¨±ã€ï¼‰
        const name =
          cleaned["è—¥å“"] !== undefined
            ? cleaned["è—¥å“"]
            : cleaned["è—¥å“åç¨±"];

        if (!name) return; // æ²’è—¥å“åå°±è·³é

        // è™•ç†ç´¯è¨ˆç”¨é‡ï¼šå¯èƒ½å«ã€Œç´¯è¨ˆç”¨é‡ã€æˆ–ã€Œç´¯è¨ˆæ•¸é‡ã€
        let used =
          cleaned["ç´¯è¨ˆç”¨é‡"] !== undefined
            ? cleaned["ç´¯è¨ˆç”¨é‡"]
            : cleaned["ç´¯è¨ˆæ•¸é‡"];

        let num = parseFloat(String(used).toString().replace(/,/g, ""));
        if (isNaN(num)) num = 0;

        drugRows.push({
          name: String(name),
          used: num,
          stock: 0,
          status: "",
        });
      });

      renderTable();
    }

    function renderTable() {
      if (!drugRows.length) {
        drugBody.innerHTML = "<tr><td colspan='4'>æ²’æœ‰è³‡æ–™</td></tr>";
        downloadBtn.disabled = true;
        return;
      }

      drugBody.innerHTML = "";
      drugRows.forEach((drug, idx) => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = drug.name;

        const usedTd = document.createElement("td");
        usedTd.textContent = drug.used.toFixed(1);

        const stockTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "0.1";
        input.value = drug.stock;
        input.className = "stock-input";
        input.addEventListener("input", () => {
          const v = parseFloat(input.value);
          drug.stock = isNaN(v) ? 0 : v;
          updateStatus(drug, statusTd);
        });
        stockTd.appendChild(input);

        const statusTd = document.createElement("td");
        updateStatus(drug, statusTd);

        tr.appendChild(nameTd);
        tr.appendChild(usedTd);
        tr.appendChild(stockTd);
        tr.appendChild(statusTd);
        drugBody.appendChild(tr);
      });

      downloadBtn.disabled = false;
    }

    // æ ¹æ“š åº«å­˜ / ç´¯è¨ˆç”¨é‡ çµ¦ç‹€æ…‹
    function updateStatus(drug, td) {
      td.textContent = "";
      td.className = "";

      const used = drug.used;
      const stock = drug.stock;

      // æ²’æœ‰æ­·å²ç”¨é‡è³‡æ–™
      if (used <= 0 && stock > 0) {
        td.textContent = "ğŸŸ¢ æœ‰åº«å­˜ï¼ˆç„¡æ­·å²ç”¨é‡ï¼‰";
        td.classList.add("status-ok");
        drug.status = td.textContent;
        return;
      }
      if (used <= 0 && stock <= 0) {
        td.textContent = "â€”";
        drug.status = td.textContent;
        return;
      }

      const ratio = stock / used;

      if (ratio >= 1) {
        td.textContent = "ğŸŸ¢ è¶³å¤ ";
        td.classList.add("status-ok");
      } else if (ratio >= 0.5) {
        td.textContent = "ğŸŸ¡ å³å°‡ä¸è¶³";
        td.classList.add("status-warn");
      } else if (stock > 0) {
        td.textContent = "ğŸ”´ åº«å­˜ä¸è¶³";
        td.classList.add("status-bad");
      } else {
        td.textContent = "ğŸ”´ ç„¡åº«å­˜";
        td.classList.add("status-bad");
      }
      drug.status = td.textContent;
    }

    // ä¸‹è¼‰çµæœæˆ CSV
    function downloadCSV() {
      if (!drugRows.length) return;

      const header = ["è—¥å“åç¨±", "ç´¯è¨ˆç”¨é‡", "åº«å­˜", "ç‹€æ…‹"];
      const lines = [header.join(",")];

      drugRows.forEach((d) => {
        const row = [
          `"${d.name.replace(/"/g, '""')}"`,
          d.used.toFixed(1),
          d.stock,
          `"${(d.status || "").replace(/"/g, '""')}"`,
        ];
        lines.push(row.join(","));
      });

      const csvContent = lines.join("\r\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "è—¥å“ç›¤é»çµæœ.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
