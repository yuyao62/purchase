<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<style>
html,body{max-width:100%;overflow-x:hidden;margin:0;padding:0;font:16px/1.35 system-ui,-apple-system,"PingFang TC","Noto Sans TC",sans-serif;background:#f3f4f6;color:#111827}
*{box-sizing:border-box;max-width:100%}
.app{width:min(1100px,100%);margin:16px auto;background:#fff;padding:14px;border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.12)}
h1{margin:0 0 6px;text-align:center}
.sub{margin:0 0 10px;text-align:center;color:#6b7280;font-size:13px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
label{font-weight:900}
input,select,button{font-size:16px;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db}
button{border:none;cursor:pointer;background:#4f46e5;color:#fff;font-weight:900}
.btn2{background:#111827}.btnG{background:#e5e7eb;color:#111827}.btnN{background:#374151}
.announce{display:none;margin:10px 0;padding:10px 12px;border-radius:14px;background:#ede9fe;color:#4c1d95;font-weight:900}
.pill{padding:4px 10px;border-radius:999px;font-size:14px;font-weight:900}
.pT{background:#dbeafe}.pB{background:#fee2e2;color:#991b1b}.pO{background:#dcfce7;color:#166534}.pF{background:#ede9fe;color:#4c1d95}
.table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px;word-break:break-word;vertical-align:top}
th{background:#e5e7eb}tr:nth-child(even) td{background:#f3f4f6}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:13px}
.tE{background:#e5e7eb}.tO{background:#dcfce7;color:#166534}.tB{background:#fee2e2;color:#991b1b}.tF{background:#ede9fe;color:#5b21b6}
.stock{display:flex;flex-direction:column;gap:6px}.top{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.note{width:100%;padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}
@media(max-width:520px){
.app{margin:0;border-radius:0;box-shadow:none}
table,thead,tbody,tr,td,th{display:block;width:100%}thead{display:none}
tr{background:#fff;border-radius:14px;padding:10px;margin-bottom:10px}
td{padding:4px 0}td::before{display:block;margin-bottom:2px;font-weight:900;color:#6b7280}
td:nth-child(1)::before{content:"å» å•†"}td:nth-child(2)::before{content:"è—¥ä»£"}
td:nth-child(3)::before{content:"è—¥å“"}td:nth-child(4)::before{content:"ç”¨é‡"}td:nth-child(5)::before{content:"åº«å­˜"}
}
</style></head><body>
<div class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="sub">æ¯æœˆä¸€æª” inventory_YYYY_MM.jsonï¼ˆé è¨­å–®æœˆï¼›éœ€è¦å¤šæœˆå†å‹¾ï¼‰</div>

  <div id="announce" class="announce"></div>

  <div class="row">
    <label>å¹´ä»½</label><select id="year"></select>
    <label>æœˆä»½</label>
    <button id="prev" class="btnN" title="ä¸Šå€‹æœˆ">â—€</button>
    <select id="m1"></select>
    <span id="rangeUI" style="display:none;align-items:center;gap:8px">
      <span style="font-weight:900;color:#6b7280">åˆ°</span><select id="m2"></select>
    </span>
    <button id="next" class="btnN" title="ä¸‹å€‹æœˆ">â–¶</button>

    <label style="margin-left:6px"><input id="range" type="checkbox" style="transform:scale(1.1);margin-right:6px">å¤šæœˆ</label>
    <button id="reload" class="btn2">é‡æ–°è¼‰å…¥</button>
    <button id="reset" class="btnG">é‡ç½®</button>
  </div>

  <div class="row">
    <label>å» å•†</label>
    <input id="vendor" list="vendorList" placeholder="ä¸‹æ‹‰æˆ–è¼¸å…¥å» å•†é—œéµå­—">
    <datalist id="vendorList"></datalist>

    <label>è—¥ä»£</label><input id="qCode" placeholder="è—¥ä»£é—œéµå­—">
    <label>è—¥å“</label><input id="qName" placeholder="è—¥å“é—œéµå­—">
    <button id="doFilter">ç¯©é¸</button>
    <button id="clear" class="btnG">æ¸…ç©º</button>
  </div>

  <div class="row">
    <span class="pill pT" id="c0"></span>
    <span class="pill pB" id="c1"></span>
    <span class="pill pO" id="c2"></span>
    <span class="pill pF" id="c3"></span>
  </div>

  <table class="table">
    <thead><tr><th>å» å•†</th><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th></tr></thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<script>
(()=>{const $=id=>document.getElementById(id);
let data=[]; // {vendor,code,name,u}
const STOCK="drug_stock_v1",MANUAL="manual_over_v1",NOTE="drug_note_v1";
const stock=JSON.parse(localStorage.getItem(STOCK)||"{}");
const manual=JSON.parse(localStorage.getItem(MANUAL)||"{}");
const notes=JSON.parse(localStorage.getItem(NOTE)||"{}");

const pad=n=>String(n).padStart(2,"0");
const fname=(y,m)=>`inventory_${y}_${pad(m)}.json`;
const pickVendor=r=>r["å» å•†"]??r["å» å•†åç¨±"]??r["ä¾›æ‡‰å•†"]??r["Vendor"]??"";
const pickCode=r=>r["è—¥ä»£"]??r["ä»£ç¢¼"]??r["code"]??"";
const pickName=r=>r["è—¥å“"]??r["å“å"]??r["name"]??"";
const pickUsage=r=>Number(r["æœˆç”¨é‡"]??r["ç”¨é‡"]??r["usage"]??0);

function setAnnounce(msg){const a=$("announce");a.textContent=msg;a.style.display=msg?"block":"none";}
function initYM(){
  const y=new Date().getFullYear();$("year").innerHTML="";$("year").appendChild(new Option(y,y,true,true));
  $("m1").innerHTML="";$("m2").innerHTML="";
  for(let i=1;i<=12;i++){ $("m1").appendChild(new Option(i,i)); $("m2").appendChild(new Option(i,i)); }
  const m=new Date().getMonth()+1; $("m1").value=m; $("m2").value=m;
}
function rangeMonths(){
  let s=+$("m1").value,e=+$("m2").value; if(e<s){const t=s;s=e;e=t;}
  const arr=[]; for(let m=s;m<=e;m++) arr.push(m); return arr;
}
async function load(){
  data=[]; $("vendorList").innerHTML="";
  const y=$("year").value;
  const months = $("range").checked ? rangeMonths() : [+$("m1").value];
  const merged=new Map(); // code -> {vendor,code,name,u}
  for(const m of months){
    try{
      const r=await fetch(fname(y,m),{cache:"no-store"}); if(!r.ok) continue;
      const rows=await r.json();
      rows.forEach(row=>{
        const code=String(pickCode(row)||"").trim(); if(!code) return;
        const name=String(pickName(row)||"").trim();
        const vendor=String(pickVendor(row)||"").trim();
        const u=pickUsage(row)||0;
        if(!merged.has(code)) merged.set(code,{vendor,code,name,u:0});
        const rec=merged.get(code);
        if(!rec.vendor && vendor) rec.vendor=vendor;
        if(!rec.name && name) rec.name=name;
        rec.u += u;
      });
    }catch{}
  }
  data=[...merged.values()];
  // vendor datalist
  const vs=[...new Set(data.map(x=>x.vendor).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"zh-Hant"));
  const dl=$("vendorList"); vs.forEach(v=>dl.appendChild(new Option(v,v)));
  const label = $("range").checked ? `${months[0]}~${months[months.length-1]}æœˆ` : `${months[0]}æœˆ`;
  setAnnounce(`å·²è¼‰å…¥ï¼š${y} å¹´ ${label}ï¼ˆå…± ${data.length} ç­†ï¼‰`);
  render(applyFilter());
}
function isOver(x){
  if(manual[x.code]) return true;
  const st=stock[x.code]; const u=x.u||0;
  return u>0 && st!=null && st>u*6;
}
function tag(st,u,over){
  if(over) return `<span class="tag tF">å‹¿å¿˜æˆ‘</span>`;
  if(st==null) return `<span class="tag tE">æœªè¼¸å…¥</span>`;
  if(u>0 && st<u) return `<span class="tag tB">éœ€æ¡è³¼</span>`;
  return `<span class="tag tO">æ­£å¸¸</span>`;
}
function applyFilter(){
  const v=$("vendor").value.trim();
  const qc=$("qCode").value.trim();
  const qn=$("qName").value.trim();
  return data.filter(x=>{
    if(v && !(x.vendor||"").includes(v)) return false;
    if(qc && !(x.code||"").includes(qc)) return false;
    if(qn && !(x.name||"").includes(qn)) return false;
    return true;
  });
}
function render(list){
  const tb=$("tb"); tb.innerHTML="";
  let over=0,need=0,ok=0;
  list.forEach(x=>{
    const st=stock[x.code]; const u=x.u||0; const overFlag=isOver(x);
    if(overFlag) over++; if(st!=null && u>st) need++; else if(st!=null) ok++;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${x.vendor||""}</td>
      <td>${x.code}</td>
      <td>${x.name||""}</td>
      <td>${u}</td>
      <td><div class="stock">
        <div class="top">
          <input type="number" inputmode="numeric" value="${st??""}">
          ${tag(st,u,overFlag)}
        </div>
        <input class="note note-input" placeholder="å‚™è¨»" value="${notes[x.code]??""}">
      </div></td>`;
    const [inp,ninp]=tr.querySelectorAll("input");
    inp.oninput=()=>{ stock[x.code]=inp.value===""?null:+inp.value; localStorage.setItem(STOCK,JSON.stringify(stock)); render(list); };
    ninp.oninput=()=>{ notes[x.code]=ninp.value; localStorage.setItem(NOTE,JSON.stringify(notes)); };
    tb.appendChild(tr);
  });
  $("c0").textContent=`å…± ${list.length}`;
  $("c1").textContent=`éœ€æ¡è³¼ ${need}`;
  $("c2").textContent=`æ­£å¸¸ ${ok}`;
  $("c3").textContent=`å…¬å‘Š(å‹¿å¿˜æˆ‘) ${over}`;
  // âœ… å‹¿å¿˜æˆ‘åªç”¨å…¬å‘Šå‘ˆç¾ï¼ˆä¸å†å‡ºæ¸…å–®ï¼‰
  if(over){
    const y=$("year").value;
    const months=$("range").checked?rangeMonths():[+$("m1").value];
    const label=$("range").checked?`${months[0]}~${months[months.length-1]}æœˆ`:`${months[0]}æœˆ`;
    setAnnounce(`ğŸ“£ ${y} å¹´ ${label}ï¼šå‹¿å¿˜æˆ‘ ${over} ç­†ï¼ˆåº«å­˜éé«˜/äººå·¥æ¨™è¨˜ï¼‰`);
  }
}
function shift(d){
  let m=+$("m1").value; m+=d; if(m<1)m=1; if(m>12)m=12;
  $("m1").value=m; if(!$("range").checked) load();
}
$("range").onchange=()=>{ $("rangeUI").style.display=$("range").checked?"inline-flex":"none"; if(!$("range").checked) $("m2").value=$("m1").value; load(); };
$("m1").onchange=()=>{ if(!$("range").checked) load(); else render(applyFilter()); };
$("m2").onchange=()=>{ if($("range").checked) load(); };
$("prev").onclick=()=>shift(-1); $("next").onclick=()=>shift(1);
$("reload").onclick=load;
$("doFilter").onclick=()=>render(applyFilter());
$("clear").onclick=()=>{ $("vendor").value="";$("qCode").value="";$("qName").value=""; render(applyFilter()); setAnnounce($("announce").textContent); };
$("reset").onclick=()=>{ localStorage.removeItem(STOCK);localStorage.removeItem(MANUAL);localStorage.removeItem(NOTE); location.reload(); };

initYM(); load();
})();
</script>
</body></html>
