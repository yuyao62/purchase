<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>

<!-- å¦‚æœä½ åŸæœ¬æœ‰ Chart.jsï¼Œä¿ç•™é€™è¡Œï¼ˆæˆ–ç”¨ä½ è‡ªå·±çš„è·¯å¾‘ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== å…¨ç«™åŸºæº–å­—é«”ï¼šè®“ä¸Š/ä¸‹åŠéƒ¨ä¸€è‡´ ===== */
html{ font-size:16px; }
body{
  margin:0;
  background:#f3f4f6;
  font-size:16px;         /* âœ… åŸºæº–å­— */
  line-height:1.4;
  color:#111827;
}

.app{
  width:min(1100px,100%);
  background:#fff;
  margin:20px auto;
  padding:24px;
  border-radius:20px;
  box-shadow:0 18px 40px rgba(0,0,0,.12);
}

h1{ text-align:center; margin:0 0 6px; }
.subtitle{ text-align:center; color:#6b7280; font-size:14px; margin-bottom:16px; }

.row{ display:flex; flex-wrap:wrap; align-items:center; gap:12px; margin-bottom:12px; }
label{ font-weight:800; }

input, select{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid #d1d5db;
  font-size:16px;         /* âœ… åŸæœ¬ 14px -> 16pxï¼šå’Œä¸‹åŠéƒ¨ä¸€è‡´ï¼Œä¹Ÿé¿å… iOS ç¸®æ”¾ */
  max-width:100%;
}

button{
  padding:8px 18px;
  border-radius:999px;
  border:none;
  background:#4f46e5;
  color:#fff;
  font-weight:800;
  cursor:pointer;
}
.emergency-btn{ background:#dc2626; }
.secondary-btn{ background:#111827; }
.ghost-btn{ background:#e5e7eb; color:#111827; }
.warn-pill{ background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }

.pill{ padding:4px 12px; border-radius:999px; font-size:14px; font-weight:800; } /* âœ… åŸæœ¬ 13px -> 14px */
.pill-total{ background:#dbeafe; color:#1e3a8a; }
.pill-buy{ background:#fee2e2; color:#991b1b; }
.pill-ok{ background:#dcfce7; color:#166534; }

.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
table{ width:100%; border-collapse:collapse; font-size:16px; } /* âœ… åŸæœ¬ 13px -> 16pxï¼šä¸‹åŠéƒ¨è®Šå¤§ */
th{ background:#e5e7eb; padding:8px; position:sticky; top:0; }
td{ padding:6px 8px; vertical-align:middle; }
tr:nth-child(even) td{ background:#f3f4f6; }
td.col-stock input{ width:80px; text-align:center; border-radius:10px; }

.tag{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:14px;         /* âœ… åŸæœ¬ 12px -> 14pxï¼šè·Ÿåˆ—è¡¨ä¸€è‡´ */
}
.tag-empty{ background:#e5e7eb; }
.tag-buy{ background:#fee2e2; color:#b91c1c; }
.tag-ok{ background:#dcfce7; color:#166534; }

@media (max-width:520px){
  .app{ width:100%; margin:0; padding:12px; border-radius:0; box-shadow:none; }
  h1{ font-size:26px; }
  .subtitle{ font-size:12px; }

  .table-wrap{ overflow:visible; }
  table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  thead{ display:none; }

  tr{
    display:grid;
    grid-template-columns:minmax(0,1fr) 120px;
    grid-template-areas:
      "code right"
      "drug right"
      "usage right";
    gap:4px 8px;
    background:#fff;
    border-radius:14px;
    padding:10px;
    max-width:100%;
    overflow:hidden;

    font-size:16px;        /* âœ… è®“æ‰‹æ©Ÿç‰ˆå¡ç‰‡åˆ—æ•´é«”å­—é«”è·Ÿä¸ŠåŠéƒ¨ä¸€è‡´ */
  }

  td{ padding:0; white-space:normal; min-width:0; }

  td.col-code{ grid-area:code; font-weight:900; font-size:16px; } /* âœ… åŸæœ¬ 14px -> 16px */
  td.col-drug{
    grid-area:drug; font-weight:700; line-height:1.3;
    font-size:16px;        /* âœ… è£œä¸Šï¼šåŸæœ¬æ²’æŒ‡å®šæœƒåƒåˆ°è¼ƒå° */
    overflow-wrap:anywhere; word-break:break-word;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }
  td.col-usage{
    grid-area:usage; font-weight:800; color:#374151;
    font-size:16px;        /* âœ… ä¸€è‡´ */
  }

  td.col-stock{
    grid-area:right;
    display:flex; align-items:center; justify-content:flex-end; gap:6px;
    min-height:48px; align-self:stretch; min-width:0; max-width:100%;
  }
  td.col-status{ display:none; }
  td.col-stock input{
    width:68px; max-width:100%; min-height:36px; font-size:16px; text-align:center;
    touch-action:manipulation;
  }
  td.col-stock .tag{
    max-width:52px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    font-size:14px;        /* âœ… åŸæœ¬ 11px -> 14px */
    padding:4px 6px;
  }
  #searchInput{ font-size:16px; padding:10px 16px; }
}

/* ===== ç·Šæ€¥ modal ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,#7f1d1d,#000);
  color:#fff;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.modal h1{ font-size:44px; margin:0 0 16px; }
.modal button{
  width:min(360px, 90vw);
  padding:14px 18px;
  font-size:18px;
  border-radius:14px;
}

/* ===== éœ€æ¡è³¼æ¸…å–®ï¼šç¨ç«‹ç•«é¢ ===== */
.buy-screen{
  display:none;
  height:100dvh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  background:#0b1220;
  color:#fff;
  padding: calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom));
}

.buy-panel{ width:min(980px, 100%); margin:0 auto; }
.buy-head{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:10px;
  justify-content:space-between;
  margin-bottom:12px;
}
.buy-title{ font-size:22px; font-weight:900; }
.buy-sub{ color:#cbd5e1; font-size:14px; margin-top:4px; } /* âœ… 13 -> 14 */
.buy-actions{ display:flex; flex-wrap:wrap; gap:10px; }

.vendor-group{
  margin:14px 0 6px;
  padding:6px 10px;
  border-radius:10px;
  background:#020617;
  font-weight:900;
  font-size:16px; /* âœ… 14 -> 16 */
  color:#e5e7eb;
  letter-spacing:.5px;
}

.buy-line{
  display:grid;
  grid-template-columns:84px 1fr auto;
  gap:10px;
  align-items:center;
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:rgba(17,24,39,.35);
  border-radius:12px;
  margin-bottom:8px;
}
.buy-code{ font-weight:900; font-size:16px; color:#e5e7eb; } /* âœ… 14 -> 16 */
.buy-drug{
  font-weight:800;
  font-size:16px; /* âœ… 14 -> 16 */
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.buy-meta{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:900;
  white-space:nowrap;
  font-size:16px; /* âœ… 13 -> 16 */
}
.buy-need{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:#fecaca;
  color:#7f1d1d;
  font-size:14px; /* âœ… 12 -> 14 */
  font-weight:900;
}

@media (max-width:700px){
  .buy-line{
    grid-template-columns:76px 1fr;
    grid-template-areas:
      "code meta"
      "drug drug";
    gap:6px 10px;
    padding:10px;
  }
  .buy-code{ grid-area:code; }
  .buy-meta{ grid-area:meta; justify-content:flex-end; }
  .buy-drug{ grid-area:drug; white-space:normal; line-height:1.3; }
}
</style>
</head>

<body>
<div class="app" id="mainApp">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="subtitle">æ¯æœˆä¸€æª”ï¼šinventory_YYYY_MM.jsonï½œå¯ç®—å–®æœˆ/å¤šæœˆç´¯åŠ ï¼ˆä¾‹ï¼š9â†’11 = 9+10+11ï¼‰</div>

  <div class="row">
    <label>å¹´ä»½ï¼š</label>
    <select id="yearSelect"></select>

    <label style="margin-left:6px;">ç”¨é‡å€é–“ï¼š</label>
    <select id="startMonth"></select>
    <span style="font-weight:900;color:#374151;">åˆ°</span>
    <select id="endMonth"></select>

    <button id="reloadBtn" class="secondary-btn">é‡æ–°è¼‰å…¥æœˆä»½æª”</button>
  </div>

  <div class="row">
    <span class="pill warn-pill" id="missingFilesPill" style="display:none;"></span>
  </div>

  <div class="row">
    <label>å» å•†ï¼š</label>
    <select id="vendorSelect"><option value="">å…¨éƒ¨</option></select>
  </div>

  <div class="row">
    <label>æœå°‹ï¼š</label>
    <input id="searchInput" style="flex:1" placeholder="è¼¸å…¥å°±æœƒè‡ªå‹•æŸ¥ï¼ˆè—¥ä»£ / è—¥å / å» å•†ï¼‰">
  </div>

  <div class="row">
    <button id="resetBtn">é‡ç½®</button>
    <button id="emergencyBtn" class="emergency-btn">ç·Šæ€¥</button>
    <label><input type="checkbox" id="needBuyOnly"> åªé¡¯ç¤ºéœ€æ¡è³¼ï¼ˆå‹¾é¸è‡ªå‹•è·³é ï¼‰</label>
    <button id="openBuyScreenBtn" class="secondary-btn">éœ€æ¡è³¼æ¸…å–®ï¼ˆå¦ä¸€ç•«é¢ï¼‰</button>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount"></span>
    <span class="pill pill-buy" id="needBuyCount"></span>
    <span class="pill pill-ok" id="okCount"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>è—¥ä»£</th>
          <th>è—¥å“</th>
          <th id="usageHead">ç”¨é‡</th>
          <th>åº«å­˜</th>
          <th>ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody id="drugBody"></tbody>
    </table>
  </div>

  <canvas id="chart" height="180"></canvas>
</div>

<div id="buyScreen" class="buy-screen">
  <div class="buy-panel">
    <div class="buy-head">
      <div>
        <div class="buy-title">ğŸ§¾ éœ€æ¡è³¼æ¸…å–®</div>
        <div class="buy-sub" id="buyMeta"></div>
      </div>
      <div class="buy-actions">
        <button id="backBtn" class="ghost-btn">è¿”å›ä¸»ç•«é¢</button>
        <button id="saveCSVBtn" class="secondary-btn">å­˜æª” CSV</button>
        <button id="saveJSONBtn" class="secondary-btn">å­˜æª” JSON</button>
      </div>
    </div>

    <div id="buyList"></div>
  </div>
</div>

<div id="emergencyModal" class="modal">
  <div style="text-align:center; padding: 16px">
    <h1>âš ï¸ è«‹æ´½åº—é•·</h1>
    <button onclick="document.getElementById('emergencyModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>

<script>
document.addEventListener("touchstart", ()=>{}, {passive:true});

(() => {
  let rawData = [];
  let chart;
  let missingFiles = [];

  const $ = id => document.getElementById(id);

  function fileNameOf(year, month){
    const mm = String(month).padStart(2,"0");
    return `inventory_${year}_${mm}.json`;
  }

  const vendorKey = v => {
    v = String(v||"");
    return /^[A-Za-z]/.test(v) ? v.slice(0,5).toUpperCase() : v.slice(0,2);
  };

  const nowStamp = () => {
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
  };

  function initYearMonthUI(){
    const y = new Date().getFullYear();
    $("yearSelect").innerHTML = "";
    [y-1, y, y+1].forEach(yy=>{
      const o = document.createElement("option");
      o.value = yy;
      o.textContent = `${yy} å¹´`;
      if(yy === y) o.selected = true;
      $("yearSelect").appendChild(o);
    });

    $("startMonth").innerHTML = "";
    $("endMonth").innerHTML = "";
    for(let m=1; m<=12; m++){
      const o1 = document.createElement("option");
      o1.value = m; o1.textContent = `${m}æœˆ`;
      $("startMonth").appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = m; o2.textContent = `${m}æœˆ`;
      $("endMonth").appendChild(o2);
    }
    const nowM = new Date().getMonth()+1;
    $("startMonth").value = String(nowM);
    $("endMonth").value = String(nowM);
  }

  function updateUsageHead(){
    const s = $("startMonth").value;
    const e = $("endMonth").value;
    $("usageHead").textContent = (s===e) ? `${s}æœˆç”¨é‡` : `${s}â†’${e}æœˆç´¯åŠ `;
  }

  function pickUsageValue(rec){
    const v = (rec["æœˆç”¨é‡"] ?? rec["ç”¨é‡"] ?? rec["ä½¿ç”¨é‡"] ?? rec["æœˆä½¿ç”¨é‡"]);
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function mergeMonthlyData(year, monthlyDatas){
    const map = new Map();

    monthlyDatas.forEach(({month, rows})=>{
      rows.forEach(rec=>{
        const code = String(rec["è—¥ä»£"] ?? rec["ä»£ç¢¼"] ?? rec["è—¥å“ä»£ç¢¼"] ?? "").trim();
        if(!code) return;

        if(!map.has(code)){
          map.set(code, {
            è—¥ä»£: code,
            è—¥å“: rec["è—¥å“"] ?? rec["è—¥å"] ?? rec["å“å"] ?? "",
            å» å•†: rec["å» å•†"] ?? rec["ä¾›æ‡‰å•†"] ?? "",
            åº«å­˜é‡: null,
            éœ€æ¡è³¼: false,
            _ç”¨é‡åˆè¨ˆ: 0
          });
        }else{
          const x = map.get(code);
          if(!x.è—¥å“ && (rec["è—¥å“"]||rec["è—¥å"]||rec["å“å"])) x.è—¥å“ = rec["è—¥å“"] ?? rec["è—¥å"] ?? rec["å“å"];
          if(!x.å» å•† && (rec["å» å•†"]||rec["ä¾›æ‡‰å•†"])) x.å» å•† = rec["å» å•†"] ?? rec["ä¾›æ‡‰å•†"];
        }

        const x = map.get(code);
        x[`${month}æœˆç”¨é‡`] = pickUsageValue(rec);
      });
    });

    return [...map.values()];
  }

  function monthRangeSum(x, startM, endM){
    const getM = (m) => Number(x[`${m}æœˆç”¨é‡`] ?? 0) || 0;
    let sum = 0;

    if(startM <= endM){
      for(let m=startM; m<=endM; m++) sum += getM(m);
    }else{
      for(let m=startM; m<=12; m++) sum += getM(m);
      for(let m=1; m<=endM; m++) sum += getM(m);
    }
    return sum;
  }

  function currentUsage(x){
    const s = Number($("startMonth").value);
    const e = Number($("endMonth").value);
    return monthRangeSum(x, s, e);
  }

  function updateNeedFlag(x){
    const u = currentUsage(x);
    const stock = x.åº«å­˜é‡;
    x._ç”¨é‡åˆè¨ˆ = u;
    x.éœ€æ¡è³¼ = (stock != null) && (u > stock);
  }

  function updateAllNeedFlags(){
    rawData.forEach(updateNeedFlag);
  }

  function makeTag(x){
    if(x.åº«å­˜é‡==null) return '<span class="tag tag-empty">æœªè¼¸å…¥</span>';
    return x.éœ€æ¡è³¼
      ? '<span class="tag tag-buy">éœ€æ¡è³¼</span>'
      : '<span class="tag tag-ok">è¶³å¤ </span>';
  }

  function renderStats(list){
    const total = list.length;
    const need = list.filter(x=>x.éœ€æ¡è³¼).length;
    const ok = list.filter(x=>x.åº«å­˜é‡!=null && !x.éœ€æ¡è³¼).length;

    $("totalCount").textContent = `å…± ${total} ç­†`;
    $("needBuyCount").textContent = `éœ€æ¡è³¼ ${need} ç­†`;
    $("okCount").textContent = `åº«å­˜è¶³å¤  ${ok} ç­†`;

    if(chart) chart.destroy();
    chart = new Chart($("chart"),{
      type:"pie",
      data:{labels:["éœ€æ¡è³¼","åº«å­˜è¶³å¤ "],datasets:[{data:[need,ok]}]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  function render(list){
    $("drugBody").innerHTML = "";
    list.forEach(x=>{
      updateNeedFlag(x);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-code">${x.è—¥ä»£}</td>
        <td class="col-drug">${x.è—¥å“}</td>
        <td class="col-usage">${x._ç”¨é‡åˆè¨ˆ}</td>
        <td class="col-stock">
          <input type="number" inputmode="numeric" value="${x.åº«å­˜é‡??""}">
          ${makeTag(x)}
        </td>
        <td class="col-status"></td>
      `;

      const inp = tr.querySelector("input");
      inp.addEventListener("input", ()=>{
        x.åº«å­˜é‡ = inp.value==="" ? null : +inp.value;
        updateNeedFlag(x);
        tr.querySelector(".tag").outerHTML = makeTag(x);

        persistStock();
        renderStats(list);

        if (isBuyScreenOpen()) openBuyScreen();
      });

      $("drugBody").appendChild(tr);
    });
    renderStats(list);
  }

  function currentFilteredList(){
    const kw = $("searchInput").value.toLowerCase();
    const vSel = $("vendorSelect").value;
    const needOnly = $("needBuyOnly").checked;

    updateAllNeedFlags();

    let list = rawData.filter(x=>{
      if(vSel && vendorKey(x.å» å•†)!==vSel) return false;
      if(!kw) return true;
      return (
        String(x.è—¥ä»£).toLowerCase().includes(kw) ||
        String(x.è—¥å“).toLowerCase().includes(kw) ||
        String(x.å» å•†).toLowerCase().includes(kw)
      );
    });

    if(needOnly) list = list.filter(x=>x.éœ€æ¡è³¼);
    return list;
  }

  function filter(){
    updateUsageHead();
    const list = currentFilteredList();
    render(list);
    const first = $("drugBody").querySelector("tr");
    if(first) first.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function isBuyScreenOpen(){
    return $("buyScreen").style.display === "block";
  }

  function showBuyPage(){
    $("mainApp").style.display = "none";
    $("buyScreen").style.display = "block";
    document.body.classList.add("lock");
    $("buyScreen").scrollTop = 0;
  }

  function showMainPage(){
    $("buyScreen").style.display = "none";
    $("mainApp").style.display = "block";
    document.body.classList.remove("lock");
    window.scrollTo(0, 0);
  }

  function getNeedBuyList(){
    const kw = $("searchInput").value.toLowerCase();
    const vSel = $("vendorSelect").value;

    updateAllNeedFlags();

    return rawData
      .filter(x=>{
        if(vSel && vendorKey(x.å» å•†)!==vSel) return false;
        if(kw){
          const hit =
            String(x.è—¥ä»£).toLowerCase().includes(kw) ||
            String(x.è—¥å“).toLowerCase().includes(kw) ||
            String(x.å» å•†).toLowerCase().includes(kw);
          if(!hit) return false;
        }
        return x.éœ€æ¡è³¼;
      })
      .map(x=>{
        const stock = (x.åº«å­˜é‡==null) ? 0 : x.åº«å­˜é‡;
        const usage = currentUsage(x);
        const suggest = Math.max(0, usage - Number(stock||0));
        return {
          è—¥ä»£: x.è—¥ä»£,
          è—¥å“: x.è—¥å“,
          å» å•†: x.å» å•†,
          ç”¨é‡åˆè¨ˆ: usage,
          åº«å­˜é‡: x.åº«å­˜é‡,
          å»ºè­°æ¡è³¼é‡: suggest
        };
      })
      .sort((a,b)=>{
        if(a.å» å•† !== b.å» å•†) return String(a.å» å•†).localeCompare(String(b.å» å•†), "zh-Hant");
        return (b.å»ºè­°æ¡è³¼é‡ - a.å»ºè­°æ¡è³¼é‡);
      });
  }

  function openBuyScreen(){
    const list = getNeedBuyList();
    showBuyPage();

    const vSel = $("vendorSelect").value || "å…¨éƒ¨";
    const kw = $("searchInput").value.trim() || "ï¼ˆç„¡ï¼‰";
    const s = $("startMonth").value;
    const e = $("endMonth").value;
    const usageLabel = (s===e) ? `${s}æœˆ` : `${s}â†’${e}ç´¯åŠ `;

    const y = $("yearSelect").value;
    $("buyMeta").textContent = `å¹´ä»½ï¼š${y}ï½œå» å•†ï¼š${vSel}ï½œé—œéµå­—ï¼š${kw}ï½œç”¨é‡ï¼š${usageLabel}ï½œå…± ${list.length} ç­†`;

    const wrap = $("buyList");
    wrap.innerHTML = "";

    if(list.length === 0){
      const empty = document.createElement("div");
      empty.style.padding = "12px";
      empty.style.background = "#111827";
      empty.style.borderRadius = "12px";
      empty.style.border = "1px solid rgba(255,255,255,.08)";
      empty.innerHTML = `<div style="font-weight:900; font-size:16px">ç›®å‰æ²’æœ‰éœ€æ¡è³¼é …ç›®</div>
                         <div style="color:#94a3b8; margin-top:6px">è«‹å…ˆåœ¨ä¸»ç•«é¢è¼¸å…¥åº«å­˜ï¼Œç³»çµ±æ‰æœƒåˆ¤æ–·éœ€æ¡è³¼ã€‚</div>`;
      wrap.appendChild(empty);
      return;
    }

    let lastVendor = "";
    list.forEach(x=>{
      if(x.å» å•† !== lastVendor){
        const vg = document.createElement("div");
        vg.className = "vendor-group";
        vg.textContent = x.å» å•† || "ï¼ˆæœªå¡«å» å•†ï¼‰";
        wrap.appendChild(vg);
        lastVendor = x.å» å•†;
      }

      const line = document.createElement("div");
      line.className = "buy-line";
      line.innerHTML = `
        <div class="buy-code">${x.è—¥ä»£}</div>
        <div class="buy-drug" title="${x.è—¥å“}">${x.è—¥å“}</div>
        <div class="buy-meta">
          <span>ç”¨${x.ç”¨é‡åˆè¨ˆ}</span>
          <span>åº«${x.åº«å­˜é‡==null ? "â€”" : x.åº«å­˜é‡}</span>
          <span class="buy-need">ç¼º${x.å»ºè­°æ¡è³¼é‡}</span>
        </div>
      `;
      wrap.appendChild(line);
    });
  }

  function closeBuyScreen(){
    showMainPage();
  }

  function downloadFile(filename, mime, content){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportNeedBuyCSV(){
    const list = getNeedBuyList();
    const header = ["è—¥ä»£","è—¥å“","å» å•†","ç”¨é‡åˆè¨ˆ","åº«å­˜é‡","å»ºè­°æ¡è³¼é‡"];
    const esc = v => {
      const s = (v==null) ? "" : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const rows = [header.join(",")].concat(
      list.map(x=> header.map(k=>esc(x[k])).join(","))
    );
    downloadFile(`éœ€æ¡è³¼æ¸…å–®_${nowStamp()}.csv`, "text/csv;charset=utf-8", rows.join("\n"));
  }

  function exportNeedBuyJSON(){
    const list = getNeedBuyList();
    downloadFile(`éœ€æ¡è³¼æ¸…å–®_${nowStamp()}.json`, "application/json;charset=utf-8", JSON.stringify(list, null, 2));
  }

  const STOCK_KEY = "drug_stock_v1";
  function persistStock(){
    const obj = {};
    rawData.forEach(x=>{ obj[String(x.è—¥ä»£)] = x.åº«å­˜é‡; });
    localStorage.setItem(STOCK_KEY, JSON.stringify(obj));
  }
  function restoreStock(){
    try{
      const obj = JSON.parse(localStorage.getItem(STOCK_KEY) || "{}");
      rawData = rawData.map(x=>{
        const v = obj[String(x.è—¥ä»£)];
        const stock = (v===null || v===undefined || v==="") ? null : Number(v);
        return {...x, åº«å­˜é‡: stock};
      });
    }catch(e){}
  }

  function showMissingFiles(){
    if(!missingFiles.length){
      $("missingFilesPill").style.display = "none";
      $("missingFilesPill").textContent = "";
      return;
    }
    $("missingFilesPill").style.display = "inline-block";
    $("missingFilesPill").textContent = `ç¼ºå°‘æœˆä»½æª”ï¼š${missingFiles.join("ã€")}ï¼ˆç¼ºçš„æœˆä»½ç”¨é‡è¦–ç‚º 0ï¼‰`;
  }

  async function loadMonthlyFiles(){
    const year = Number($("yearSelect").value);
    missingFiles = [];

    const tasks = [];
    for(let m=1; m<=12; m++){
      const fn = fileNameOf(year, m);
      tasks.push(
        fetch(fn).then(r=>{
          if(!r.ok) throw new Error(fn);
          return r.json();
        }).then(rows=>({month:m, rows}))
        .catch(()=>{ missingFiles.push(`${m}æœˆ`); return null; })
      );
    }

    const results = await Promise.all(tasks);
    const ok = results.filter(Boolean);

    rawData = mergeMonthlyData(year, ok);
    restoreStock();

    const keepAll = $("vendorSelect").value || "";
    $("vendorSelect").innerHTML = `<option value="">å…¨éƒ¨</option>`;
    [...new Set(rawData.map(x=>vendorKey(x.å» å•†)))].filter(v=>v).forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      $("vendorSelect").appendChild(o);
    });
    $("vendorSelect").value = keepAll;

    showMissingFiles();
    filter();
  }

  $("searchInput").addEventListener("input", ()=>{
    clearTimeout(window._t);
    window._t = setTimeout(()=>{
      filter();
      if ($("needBuyOnly").checked) openBuyScreen();
    }, 200);
  });

  $("vendorSelect").addEventListener("change", ()=>{
    filter();
    if ($("needBuyOnly").checked) openBuyScreen();
  });

  $("startMonth").addEventListener("change", ()=>{
    filter();
    if ($("needBuyOnly").checked) openBuyScreen();
  });
  $("endMonth").addEventListener("change", ()=>{
    filter();
    if ($("needBuyOnly").checked) openBuyScreen();
  });

  $("yearSelect").addEventListener("change", ()=>{
    loadMonthlyFiles().catch(err=>{
      console.error(err);
      alert("è¼‰å…¥æœˆä»½æª”å¤±æ•—ï¼ˆè«‹ç¢ºèªæª”æ¡ˆå‘½åèˆ‡è·¯å¾‘ï¼‰");
    });
  });

  $("reloadBtn").addEventListener("click", ()=>{
    loadMonthlyFiles().catch(err=>{
      console.error(err);
      alert("è¼‰å…¥æœˆä»½æª”å¤±æ•—ï¼ˆè«‹ç¢ºèªæª”æ¡ˆå‘½åèˆ‡è·¯å¾‘ï¼‰");
    });
  });

  $("needBuyOnly").addEventListener("change", ()=>{
    filter();
    if ($("needBuyOnly").checked) openBuyScreen();
    else if (isBuyScreenOpen()) closeBuyScreen();
  });

  $("openBuyScreenBtn").addEventListener("click", openBuyScreen);
  $("backBtn").addEventListener("click", closeBuyScreen);

  $("saveCSVBtn").addEventListener("click", exportNeedBuyCSV);
  $("saveJSONBtn").addEventListener("click", exportNeedBuyJSON);

  $("resetBtn").addEventListener("click", ()=>{
    $("vendorSelect").value = "";
    $("searchInput").value = "";
    $("needBuyOnly").checked = false;

    const nowM = new Date().getMonth()+1;
    $("startMonth").value = String(nowM);
    $("endMonth").value = String(nowM);

    filter();
    if (isBuyScreenOpen()) closeBuyScreen();
  });

  $("emergencyBtn").addEventListener("click", ()=>{
    $("emergencyModal").style.display = "flex";
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      $("emergencyModal").style.display = "none";
      if(isBuyScreenOpen()) closeBuyScreen();
    }
  });

  $("emergencyModal").addEventListener("click", (e)=>{
    if(e.target.id === "emergencyModal") $("emergencyModal").style.display = "none";
  });

  initYearMonthUI();
  loadMonthlyFiles().catch(err=>{
    console.error(err);
    alert("è¼‰å…¥æœˆä»½æª”å¤±æ•—ï¼š\n" + err.message + "\n\nå¯èƒ½åŸå› ï¼š\n1) ç›´æ¥ç”¨ file:// é–‹è¢«æ“‹ fetch\n2) æª”åä¸æ˜¯ inventory_YYYY_MM.json\n3) æª”æ¡ˆä¸åœ¨åŒè³‡æ–™å¤¾\n\nå»ºè­°ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹ã€‚");
  });
