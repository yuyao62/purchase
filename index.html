<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
html,body{
  width:100%;
  max-width:100%;
  overflow-x:hidden;
  margin:0;
  background:#f3f4f6;
  color:#111827;
  font-size:16px
}
body{position:relative}
*{box-sizing:border-box;max-width:100%}

.app{width:min(1100px,100%);margin:12px auto;background:#fff;padding:14px;border-radius:16px;box-shadow:0 10px 22px rgba(0,0,0,.10)}
h1{margin:0 0 6px;text-align:center}
.sub{color:#6b7280;text-align:center;font-size:13px;margin:0 0 10px}

.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
label{font-weight:900}
input,select,button{font-size:16px;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db}
button{border:none;background:#4f46e5;color:#fff;font-weight:900;cursor:pointer}
.btn2{background:#111827}
.btn3{background:#e5e7eb;color:#111827}
.btn4{background:#374151}

.pill{padding:4px 12px;border-radius:999px;font-size:14px;font-weight:900}
.p1{background:#dbeafe}
.p2{background:#fee2e2;color:#991b1b}
.p3{background:#dcfce7;color:#166534}
.p4{background:#ede9fe;color:#4c1d95}

.table-wrap{width:100%;overflow-x:hidden}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px;vertical-align:top;word-break:break-word}
th{background:#e5e7eb}
tr:nth-child(even) td{background:#f3f4f6}

.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:13px}
.t0{background:#e5e7eb}
.t1{background:#dcfce7;color:#166534}
.t2{background:#fee2e2;color:#991b1b}
.t3{background:#ede9fe;color:#5b21b6}

.stock{display:flex;flex-direction:column;gap:6px}
.stockTop{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.note{width:100%;padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}

.announceBar{display:none;margin:8px 0;padding:10px 14px;border-radius:14px;background:#ede9fe;color:#4c1d95;font-weight:900;cursor:pointer}
.announceBar:hover{background:#ddd6fe}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:12px}
.box{background:#fff;width:min(980px,100%);border-radius:16px;box-shadow:0 18px 40px rgba(0,0,0,.25);padding:12px}
.boxHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.boxHead h3{margin:0}
.boxSub{color:#6b7280;font-size:13px;margin:6px 0 10px}
.box .table-wrap{max-height:70vh;overflow:auto;border-radius:12px}
.small{font-size:13px;color:#6b7280}

/* æ‰‹æ©Ÿæ‘˜è¦å¡ï¼šè—¥ä»£/ç”¨é‡åŒåˆ—ï¼Œè—¥å“ä¸‹ä¸€åˆ— */
.mCard{display:none}
.mTop{display:flex;justify-content:space-between;gap:12px;align-items:baseline}
.mCode,.mQty{font-weight:900;font-size:18px}
.mName{
  margin-top:4px;
  font-size:16px;
  font-weight:600;
  line-height:1.25;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  overflow-wrap:anywhere;
  word-break:break-word
}

@media(max-width:520px){
  .app{margin:0;border-radius:0;box-shadow:none}

  /* è®“æ•´å€‹è¡¨æ ¼å¡ç‰‡å¼å‘ˆç¾ */
  table,thead,tbody,tr,td,th{display:block;width:100%}
  thead{display:none}

  tr{
    background:#fff;
    border-radius:14px;
    padding:10px;
    margin:10px 0;
    overflow:hidden; /* âœ… é˜²æ­¢å…§å®¹æ’å‡ºç•Œ */
  }
  tr:nth-child(even) td{background:transparent}

  td{padding:4px 0}

  /* âœ… ä¸ç”¨ td::before å°ä¸­æ–‡ï¼ˆé¿å…å››è¡Œï¼‰ */
  td::before{display:none !important}

  /* âœ… æ‰‹æ©Ÿåªé¡¯ç¤ºç¬¬ 4 æ¬„ï¼ˆåº«å­˜/å…¬å‘Šï¼‰ï¼Œå‰ 3 æ¬„éš±è— */
  tr td:nth-child(1),
  tr td:nth-child(2),
  tr td:nth-child(3){display:none}

  /* âœ… é¡¯ç¤ºæ‰‹æ©Ÿæ‘˜è¦ */
  .mCard{display:block;margin-bottom:8px}

  /* âœ… è—¥åä¸€å®šèƒ½æ–·è¡Œï¼Œé¿å…å·¦å³æ»‘ */
  .drugName,.mName{overflow-wrap:anywhere;word-break:break-word}

  /* âœ… åº«å­˜/å…¬å‘Šé‚£æ’å…è¨±æ›è¡Œ + input ä¸æ’å¯¬ */
  .stockTop{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center
  }
  .stockTop input{
    width:100%;
    max-width:160px;
    min-width:0 !important;
    flex:1 1 120px
  }
  .tag{white-space:nowrap;flex:0 0 auto}
  .stockTop label{flex:1 1 auto;min-width:0;white-space:nowrap}
}
</style>
</head>

<body>
<div class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="sub">æ¯æœˆä¸€æª” inventory_YYYY_MM.jsonï¼ˆå–®æœˆç‚ºä¸»ï¼Œæ”¯æ´é€²éšå¤šæœˆï¼‰</div>

  <div id="announceBar" class="announceBar"></div>

  <div class="row">
    <label>å¹´ä»½</label><select id="year"></select>
    <label>æœˆä»½</label>
    <button id="pm" class="btn4" title="ä¸Šå€‹æœˆ">â—€</button>
    <select id="m1"></select>
    <button id="nm" class="btn4" title="ä¸‹å€‹æœˆ">â–¶</button>

    <label style="margin-left:6px"><input id="adv" type="checkbox" style="transform:scale(1.1);margin-right:6px">å¤šæœˆé€²éš</label>
    <span id="advBox" style="display:none;align-items:center;gap:8px">
      <span class="small">åˆ°</span><select id="m2"></select>
    </span>

    <button id="reload" class="btn2">é‡æ–°è¼‰å…¥</button>
    <button id="reset" class="btn3">é‡ç½®</button>
  </div>

  <div class="row">
    <label>å» å•†</label>
    <select id="vendorSel"></select>
    <button id="clearVendor" class="btn3">æ¸…é™¤å» å•†</button>
    <button id="vendorPage" class="btn4">å» å•†é </button>
  </div>

  <div class="row">
    <label>æœå°‹</label>
    <input id="q" placeholder="è¼¸å…¥è—¥ä»£æˆ–è—¥å“åç¨±" style="flex:1;min-width:220px">
    <button id="search">æœå°‹</button>
    <button id="export" class="btn4">åŒ¯å‡º Excel</button>
    <button id="yearView" class="btn4">å¹´åº¦ç¸½è¦½</button>
    <button id="admin" class="btn2">ç®¡ç†è€…</button>
  </div>

  <div class="row">
    <span class="pill p1" id="cTotal"></span>
    <span class="pill p2" id="cBuy"></span>
    <span class="pill p3" id="cOk"></span>
    <span class="pill p4" id="cAnn"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜ / å…¬å‘Š</th></tr></thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>

<!-- å…¬å‘Šæ˜ç´° -->
<div id="modal" class="modal"><div class="box">
  <div class="boxHead">
    <div>
      <h3>å…¬å‘Šæ˜ç´°</h3>
      <div class="boxSub" id="annRule"></div>
    </div>
    <button id="close" class="btn3">é—œé–‰</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th><th>åŸå› </th><th>æ“ä½œ</th></tr></thead>
      <tbody id="annBody"></tbody>
    </table>
  </div>
</div></div>

<!-- å» å•†é  -->
<div id="vModal" class="modal"><div class="box">
  <div class="boxHead">
    <div>
      <h3 id="vTitle">å» å•†é </h3>
      <div class="boxSub">é»å» å•†â†’çœ‹è©²å» å•†æ‰€æœ‰è—¥ï¼ˆå» å•†ä»¥ã€Œå‰å…©å€‹ä¸­æ–‡ã€æ­¸é¡ï¼‰</div>
    </div>
    <button id="vClose" class="btn3">é—œé–‰</button>
  </div>
  <div class="row">
    <input id="vSearch" placeholder="æœå°‹å» å•†" style="flex:1;min-width:220px">
    <button id="vClear" class="btn3">æ¸…é™¤</button>
  </div>
  <div id="vList" class="row" style="gap:6px"></div>
  <hr style="border:none;border-top:1px solid #e5e7eb;margin:10px 0">
  <div class="row"><input id="vdSearch" placeholder="æœå°‹è—¥ä»£/è—¥å“" style="flex:1;min-width:220px"><button id="vdClear" class="btn3">æ¸…é™¤</button></div>
  <div class="table-wrap">
    <table>
      <thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th></tr></thead>
      <tbody id="vdBody"></tbody>
    </table>
  </div>
</div></div>

<script>
(()=> {
  const $=id=>document.getElementById(id);
  const STOCK="drug_stock_v1", NOTE="drug_note_v1", MAN="manual_announce_v1", IGN="ignore_auto_announce_v1", ADMIN="admin_on_v1";
  const stock=JSON.parse(localStorage.getItem(STOCK)||"{}");
  const notes=JSON.parse(localStorage.getItem(NOTE)||"{}");
  const manual=JSON.parse(localStorage.getItem(MAN)||"{}");
  const ignore=JSON.parse(localStorage.getItem(IGN)||"{}");
  let adminOn=localStorage.getItem(ADMIN)==="1";
  let rows=[], viewRows=[], vendorMap=new Map();

  const pad2=n=>String(n).padStart(2,"0");
  const file=(y,m)=>`inventory_${y}_${pad2(m)}.json`;

  // å» å•† keyï¼šæŠ“ã€Œå‰å…©å€‹ä¸­æ–‡(CJK)å­—ã€
  const vendorKey = (s)=>{
    s=(s||"æœªæ¨™ç¤ºå» å•†").trim();
    const m=[...s.matchAll(/[\u4E00-\u9FFF]/g)].map(x=>x[0]);
    if(m.length>=2) return m[0]+m[1];
    if(m.length===1) return m[0];
    return (s.replace(/\s+/g," ").slice(0,8) || "å…¶ä»–");
  };

  const tagHTML=(st,u,ann)=>{
    if(ann) return `<span class="tag t3">å…¬å‘Š</span>`;
    if(st==null) return `<span class="tag t0">æœªè¼¸å…¥</span>`;
    if(u>0 && st<u) return `<span class="tag t2">éœ€æ¡è³¼</span>`;
    return `<span class="tag t1">æ­£å¸¸</span>`;
  };

  function initSelects(){
    const y=new Date().getFullYear();
    $("year").innerHTML=""; $("year").appendChild(new Option(y,y,true,true));
    $("m1").innerHTML=""; $("m2").innerHTML="";
    for(let i=1;i<=12;i++){ $("m1").appendChild(new Option(i,i)); $("m2").appendChild(new Option(i,i)); }
    const m=new Date().getMonth()+1; $("m1").value=m; $("m2").value=m;
    $("adv").checked=false; $("advBox").style.display="none";
    $("admin").textContent=adminOn?"ç®¡ç†è€…(é–‹)":"ç®¡ç†è€…";
  }

  async function loadData(){
    rows=[]; vendorMap=new Map();
    const y=+$("year").value;
    const adv=$("adv").checked;
    const a=+$("m1").value, b=adv?+$("m2").value:a;
    const s=Math.min(a,b), e=Math.max(a,b);
    const monthCount=(e-s+1);

    const agg=new Map();
    for(let m=s;m<=e;m++){
      try{
        const r=await fetch(file(y,m),{cache:"no-store"});
        if(!r.ok) continue;
        const list=await r.json();
        list.forEach(x=>{
          const code=x["è—¥ä»£"], name=x["è—¥å“"], ven=x["å» å•†"]||"æœªæ¨™ç¤ºå» å•†";
          const key=code;
          if(!agg.has(key)) agg.set(key,{è—¥ä»£:code,è—¥å“:name,å» å•†:ven, sum:0});
          agg.get(key).sum += Number(x["æœˆç”¨é‡"]||0);
        });
      }catch{}
    }

    rows=[...agg.values()].map(x=>{
      const avg = monthCount>0 ? (x.sum/monthCount) : 0;
      const vKey = vendorKey(x.å» å•†);
      if(!vendorMap.has(vKey)) vendorMap.set(vKey,[]);
      const rec={è—¥ä»£:x.è—¥ä»£,è—¥å“:x.è—¥å“,å» å•†:x.å» å•†,å» å•†Key:vKey, ç”¨é‡:avg, å€é–“ç¸½ç”¨é‡:x.sum, æœˆæ•¸:monthCount};
      vendorMap.get(vKey).push(rec);
      return rec;
    });

    buildVendorDropdown();
    applyFilters();
  }

  function buildVendorDropdown(){
    const sel=$("vendorSel");
    const cur=sel.value || "(å…¨éƒ¨)";
    sel.innerHTML="";
    sel.appendChild(new Option("(å…¨éƒ¨)","(å…¨éƒ¨)"));
    [...vendorMap.keys()].sort((a,b)=>a.localeCompare(b,"zh-Hant")).forEach(k=>{
      sel.appendChild(new Option(`${k} (${vendorMap.get(k).length})`,k));
    });
    sel.value=[...sel.options].some(o=>o.value===cur)?cur:"(å…¨éƒ¨)";
  }

  function isAutoAnn(r){
    if(ignore[r.è—¥ä»£]) return false;
    const u=Number(r.ç”¨é‡||0);
    const st=stock[r.è—¥ä»£];
    return u>0 && st!=null && st>u*6;
  }
  function isAnn(r){ return !!manual[r.è—¥ä»£] || isAutoAnn(r); }
  function annReason(r){
    const a=isAutoAnn(r), m=!!manual[r.è—¥ä»£];
    if(m && a) return "æ‰‹å‹•+è‡ªå‹•";
    if(m) return "æ‰‹å‹•";
    if(a) return "è‡ªå‹•";
    return "";
  }

  function applyFilters(){
    const q=$("q").value.trim();
    const v=$("vendorSel").value;
    viewRows=rows.filter(r=>{
      if(v!=="(å…¨éƒ¨)" && r.å» å•†Key!==v) return false;
      if(q && !(r.è—¥ä»£.includes(q) || r.è—¥å“.includes(q))) return false;
      return true;
    });
    renderTable(viewRows);
    renderCounts(viewRows);
    renderAnnounceBar(viewRows);
  }

  function renderTable(list){
    const tb=$("body"); tb.innerHTML="";
    list.forEach(r=>{
      const u=Math.round((r.ç”¨é‡||0)*100)/100;
      const st=stock[r.è—¥ä»£]; const ann=isAnn(r);
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.è—¥ä»£}</td>
        <td class="drugName">${r.è—¥å“}</td>
        <td>${u}</td>
        <td>
          <!-- æ‰‹æ©Ÿæ‘˜è¦ï¼šè—¥ä»£/ç”¨é‡åŒåˆ—ï¼Œè—¥å“ä¸‹ä¸€åˆ— -->
          <div class="mCard">
            <div class="mTop">
              <div><span style="color:#6b7280;font-weight:900;font-size:13px">è—¥ä»£</span> <span class="mCode">${r.è—¥ä»£}</span></div>
              <div><span style="color:#6b7280;font-weight:900;font-size:13px">ç”¨é‡</span> <span class="mQty">${u}</span></div>
            </div>
            <div style="margin-top:4px"><span style="color:#6b7280;font-weight:900;font-size:13px">è—¥å“</span></div>
            <div class="mName">${r.è—¥å“}</div>
          </div>

          <div class="stock">
            <div class="stockTop">
              <input type="number" inputmode="numeric" value="${st??""}">
              ${tagHTML(st,u,ann)}
              <label style="display:flex;align-items:center;gap:6px;margin-left:6px">
                <input type="checkbox" ${manual[r.è—¥ä»£]?"checked":""} style="transform:scale(1.05)">æ‰‹å‹•å…¬å‘Š
              </label>
            </div>
            <input class="note" placeholder="å‚™è¨»" value="${notes[r.è—¥ä»£]??""}">
          </div>
        </td>`;

      const inputs=tr.querySelectorAll("input");
      const stockInp=inputs[0], manChk=inputs[1], noteInp=inputs[2];

      stockInp.oninput=()=>{
        stock[r.è—¥ä»£]=stockInp.value===""?null:+stockInp.value;
        localStorage.setItem(STOCK,JSON.stringify(stock));
        applyFilters();
      };
      manChk.onchange=()=>{
        if(manChk.checked) manual[r.è—¥ä»£]=1; else delete manual[r.è—¥ä»£];
        localStorage.setItem(MAN,JSON.stringify(manual));
        applyFilters();
      };
      noteInp.oninput=()=>{
        notes[r.è—¥ä»£]=noteInp.value;
        localStorage.setItem(NOTE,JSON.stringify(notes));
      };
      tb.appendChild(tr);
    });
  }

  function renderCounts(list){
    let buy=0, ok=0, ann=0;
    list.forEach(r=>{
      const st=stock[r.è—¥ä»£], u=Number(r.ç”¨é‡||0);
      if(isAnn(r)) ann++;
      if(st!=null && u>st) buy++; else if(st!=null) ok++;
    });
    $("cTotal").textContent=`å…± ${list.length}`;
    $("cBuy").textContent=`éœ€æ¡è³¼ ${buy}`;
    $("cOk").textContent=`æ­£å¸¸ ${ok}`;
    $("cAnn").textContent=`å…¬å‘Š ${ann}`;
  }

  function renderAnnounceBar(list){
    const n=list.filter(isAnn).length;
    const bar=$("announceBar");
    if(n){
      bar.style.display="block";
      bar.textContent=`ğŸ“¢ å…¬å‘Š ${n} ç­†ï¼ˆé»æˆ‘çœ‹æ˜ç´°ï¼‰`;
    }else bar.style.display="none";
  }

  function openAnnModal(){
    const adv=$("adv").checked;
    const s=+$("m1").value, e=adv?+$("m2").value:s;
    const months=Math.abs(e-s)+1;
    const rule = adv
      ? `å¤šæœˆæ¨¡å¼ï¼šè‡ªå‹•åˆ¤æ–·ï¼åº«å­˜ >ï¼ˆå€é–“å¹³å‡æœˆç”¨é‡ï¼‰Ã— 6ï¼ˆå¹³å‡ï¼ç¸½ç”¨é‡ Ã· ${months}ï¼‰`
      : `å–®æœˆæ¨¡å¼ï¼šè‡ªå‹•åˆ¤æ–·ï¼åº«å­˜ > å–®æœˆç”¨é‡ Ã— 6`;
    $("annRule").textContent=rule;

    const list=viewRows.filter(isAnn);
    const tb=$("annBody"); tb.innerHTML="";
    list.forEach(r=>{
      const u=Math.round((r.ç”¨é‡||0)*100)/100;
      const st=stock[r.è—¥ä»£];
      const reason=annReason(r);
      const canDel=adminOn;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.è—¥ä»£}</td>
        <td class="drugName">${r.è—¥å“}</td>
        <td>${u}</td>
        <td>${st??""}</td>
        <td>${reason}</td>
        <td>${canDel?`
          <button class="btn3" data-del="${r.è—¥ä»£}" style="padding:6px 10px;border-radius:999px;border:1px solid #d1d5db;cursor:pointer">åˆªé™¤å…¬å‘Š</button>
        `:`<span class="small">éœ€ç®¡ç†è€…</span>`}</td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick=()=>{
        const code=btn.getAttribute("data-del");
        delete manual[code];
        ignore[code]=1;
        localStorage.setItem(MAN,JSON.stringify(manual));
        localStorage.setItem(IGN,JSON.stringify(ignore));
        applyFilters();
        openAnnModal();
      };
    });

    $("modal").style.display="flex";
  }

  function exportExcel(){
    const data=viewRows.map(r=>{
      const st=stock[r.è—¥ä»£];
      const u=Math.round((r.ç”¨é‡||0)*100)/100;
      return {
        è—¥ä»£:r.è—¥ä»£, è—¥å“:r.è—¥å“, å» å•†:r.å» å•†Key, åŸå» å•†:r.å» å•†,
        ç”¨é‡:u, åº«å­˜:st??"", å…¬å‘Š:isAnn(r)?"æ˜¯":"å¦", å…¬å‘ŠåŸå› :annReason(r),
        å‚™è¨»:notes[r.è—¥ä»£]??""
      };
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"data");
    const y=$("year").value, adv=$("adv").checked, a=$("m1").value, b=adv?$("m2").value:a;
    XLSX.writeFile(wb,`æ¡è³¼æŸ¥è©¢_${y}_${a}-${b}.xlsx`);
  }

  async function yearOverview(){
    const y=+$("year").value;
    const backup={m1:$("m1").value,m2:$("m2").value,adv:$("adv").checked};
    const sum=[];
    for(let m=1;m<=12;m++){
      $("adv").checked=false; $("advBox").style.display="none";
      $("m1").value=m;
      await loadData();
      let ann=0,buy=0,total=rows.length;
      rows.forEach(r=>{
        const st=stock[r.è—¥ä»£], u=Number(r.ç”¨é‡||0);
        if(isAnn(r)) ann++;
        if(st!=null && u>st) buy++;
      });
      sum.push({æœˆä»½:m, ç­†æ•¸:total, éœ€æ¡è³¼:buy, å…¬å‘Š:ann});
    }
    $("m1").value=backup.m1; $("m2").value=backup.m2; $("adv").checked=backup.adv;
    $("advBox").style.display=backup.adv?"inline-flex":"none";
    await loadData();

    $("annRule").textContent="å¹´åº¦ç¸½è¦½ï¼ˆæ¯æœˆï¼šç­†æ•¸ / éœ€æ¡è³¼ / å…¬å‘Šï¼‰";
    const tb=$("annBody"); tb.innerHTML="";
    sum.forEach(x=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${x.æœˆä»½}</td><td>â€”</td><td>${x.ç­†æ•¸}</td><td>${x.éœ€æ¡è³¼}</td><td>${x.å…¬å‘Š}</td><td></td>`;
      tb.appendChild(tr);
    });
    $("modal").style.display="flex";
  }

  function openVendorPage(){
    $("vModal").style.display="flex";
    renderVendorList();
    $("vdBody").innerHTML="";
  }
  function renderVendorList(){
    const kw=$("vSearch").value.trim();
    const list=[...vendorMap.keys()].sort((a,b)=>a.localeCompare(b,"zh-Hant"))
      .filter(k=>!kw || k.includes(kw));
    const box=$("vList"); box.innerHTML="";
    list.forEach(k=>{
      const b=document.createElement("button");
      b.className="btn3";
      b.style.border="1px solid #d1d5db";
      b.textContent=`${k} (${vendorMap.get(k).length})`;
      b.onclick=()=>renderVendorDrugs(k);
      box.appendChild(b);
    });
  }
  function renderVendorDrugs(k){
    $("vTitle").textContent=`å» å•†é ï¼š${k}`;
    const kw=$("vdSearch").value.trim();
    const list=(vendorMap.get(k)||[]).filter(r=>!kw || r.è—¥ä»£.includes(kw) || r.è—¥å“.includes(kw));
    const tb=$("vdBody"); tb.innerHTML="";
    list.forEach(r=>{
      const u=Math.round((r.ç”¨é‡||0)*100)/100, st=stock[r.è—¥ä»£];
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.è—¥ä»£}</td><td class="drugName">${r.è—¥å“}</td><td>${u}</td><td>${st??""}</td>`;
      tb.appendChild(tr);
    });
  }

  function shiftMonth(d){
    let m=+$("m1").value; m+=d;
    if(m<1) m=1; if(m>12) m=12;
    $("m1").value=m;
    if(!$("adv").checked) $("m2").value=m;
    loadData();
  }

  $("reload").onclick=loadData;
  $("search").onclick=applyFilters;
  $("q").addEventListener("keydown",e=>{ if(e.key==="Enter") applyFilters(); });
  $("vendorSel").onchange=applyFilters;
  $("clearVendor").onclick=()=>{ $("vendorSel").value="(å…¨éƒ¨)"; applyFilters(); };
  $("pm").onclick=()=>shiftMonth(-1);
  $("nm").onclick=()=>shiftMonth(1);
  $("m1").onchange=()=>{ if(!$("adv").checked) $("m2").value=$("m1").value; loadData(); };
  $("m2").onchange=loadData;

  $("adv").onchange=()=>{
    const on=$("adv").checked;
    $("advBox").style.display=on?"inline-flex":"none";
    if(!on) $("m2").value=$("m1").value;
    loadData();
  };

  $("announceBar").onclick=openAnnModal;
  $("close").onclick=()=>$("modal").style.display="none";
  $("modal").onclick=(e)=>{ if(e.target.id==="modal") $("modal").style.display="none"; };

  $("export").onclick=exportExcel;
  $("yearView").onclick=yearOverview;

  $("vendorPage").onclick=openVendorPage;
  $("vClose").onclick=()=>$("vModal").style.display="none";
  $("vModal").onclick=(e)=>{ if(e.target.id==="vModal") $("vModal").style.display="none"; };
  $("vSearch").oninput=renderVendorList;
  $("vClear").onclick=()=>{ $("vSearch").value=""; renderVendorList(); };
  $("vdSearch").oninput=()=>{ const t=$("vTitle").textContent.replace("å» å•†é ï¼š",""); if(t) renderVendorDrugs(t); };
  $("vdClear").onclick=()=>{ $("vdSearch").value=""; const t=$("vTitle").textContent.replace("å» å•†é ï¼š",""); if(t) renderVendorDrugs(t); };

  $("admin").onclick=()=>{
    const ok=prompt("è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼ˆæ­¤è£ç½®ï¼‰","");
    if(ok==="admin"){ adminOn=!adminOn; localStorage.setItem(ADMIN,adminOn?"1":"0"); alert(adminOn?"ç®¡ç†è€…æ¨¡å¼å·²é–‹å•Ÿ":"ç®¡ç†è€…æ¨¡å¼å·²é—œé–‰"); }
    $("admin").textContent=adminOn?"ç®¡ç†è€…(é–‹)":"ç®¡ç†è€…";
  };

  $("reset").onclick=()=>{
    localStorage.removeItem(STOCK); localStorage.removeItem(NOTE);
    localStorage.removeItem(MAN); localStorage.removeItem(IGN);
    location.reload();
  };

  initSelects();
  loadData();
})();
</script>
</body>
</html>
